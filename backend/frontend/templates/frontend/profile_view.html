{% extends 'frontend/base.html' %}
{% load static %}

{% block title %}プロフィール - ToyBox{% endblock %}

{% block extra_css %}
<style>
    .profile-view-header {
        width: 100%;
        background: var(--steam-iron-800);
    }
    
    .profile-view-header-image {
        height: 12rem;
        width: 100%;
    }
    
    @media (min-width: 768px) {
        .profile-view-header-image {
            height: 14rem;
        }
    }
    
    @media (min-width: 1024px) {
        .profile-view-header-image {
            height: 16rem;
        }
    }
    
    .profile-view-header-image img {
        height: 100%;
        width: 100%;
        object-fit: cover;
    }
    
    .profile-view-header-image .no-image {
        display: flex;
        height: 100%;
        align-items: center;
        justify-content: center;
        color: var(--steam-iron-400);
        font-size: 0.875rem;
    }
    
    .profile-view-container {
        max-width: 56rem;
        margin: 0 auto;
        padding: 1rem;
    }
    
    .profile-view-avatar {
        margin-top: -4rem;
        display: flex;
        justify-content: flex-start;
    }
    
    @media (min-width: 768px) {
        .profile-view-avatar {
            margin-top: -5rem;
        }
    }
    
    .profile-view-avatar-image {
        height: 200px;
        width: 200px;
        overflow: hidden;
        border-radius: 50%;
        border: 4px solid var(--steam-iron-900);
        box-shadow: 0 0 0 2px var(--steam-iron-700);
        background: var(--steam-iron-800);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        color: var(--steam-iron-400);
    }
    
    .profile-view-avatar-image img {
        height: 100%;
        width: 100%;
        object-fit: cover;
    }
    
    .profile-view-info {
        margin-top: 0.75rem;
        text-align: left;
    }
    
    .profile-view-name {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--steam-iron-100);
    }
    
    .profile-view-id {
        font-size: 0.75rem;
        color: var(--steam-iron-300);
        margin-top: 0.25rem;
    }
    
    .profile-view-title {
        margin-top: 0.75rem;
    }
    
    .profile-view-bio {
        margin-top: 1rem;
        font-size: 0.875rem;
        line-height: 1.75;
        color: var(--steam-iron-200);
        white-space: pre-wrap;
    }
    
    .profile-view-submissions-title {
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
        color: var(--steam-gold-300);
        font-weight: 600;
    }
    
    .profile-view-submissions-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }
    
    @media (min-width: 768px) {
        .profile-view-submissions-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }
    
    .profile-view-submission-item {
        position: relative;
        border-radius: 8px;
        border: 1px solid var(--steam-iron-700);
        background: var(--steam-iron-900);
        aspect-ratio: 1;
        overflow: hidden;
    }
    
    .profile-view-submission-item.game {
        border-color: #a855f7;
    }
    
    .profile-view-submission-item.video {
        border-color: #0ea5e9;
    }
    
    .profile-view-submission-item img,
    .profile-view-submission-item video {
        width: 100%;
        height: 100%;
        object-fit: contain;
        padding: 0.5rem;
        cursor: pointer;
    }
    
    .profile-view-submission-item .game-icon {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--steam-iron-200);
        padding: 0.75rem;
    }
    
    .profile-view-submission-item .game-icon svg {
        color: var(--steam-gold-300);
        margin-bottom: 0.25rem;
    }
    
    .profile-view-submission-item .game-icon-text {
        font-size: 0.75rem;
        letter-spacing: 0.1em;
        font-weight: 600;
    }
    
    .profile-view-submission-item .like-button {
        position: absolute;
        bottom: 0.5rem;
        right: 0.5rem;
        z-index: 10;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.6);
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        color: white;
        border: none;
        cursor: pointer;
    }
    
    .profile-view-submission-item .like-button:hover {
        background: rgba(0, 0, 0, 0.8);
    }
    
    .profile-view-submission-item .like-button.liked {
        color: #fb7185;
    }
    
    .profile-view-submission-item .like-button svg {
        width: 1rem;
        height: 1rem;
    }
    
    .profile-view-submission-item .game-link {
        position: absolute;
        top: 0.5rem;
        left: 0.5rem;
        z-index: 10;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.6);
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        color: white;
        text-decoration: none;
    }
    
    .profile-view-submission-item .game-link:hover {
        background: rgba(0, 0, 0, 0.8);
    }
    
    .profile-view-load-more {
        margin-top: 1rem;
        border-radius: 4px;
        background: var(--steam-iron-800);
        padding: 0.5rem 0.75rem;
        color: var(--steam-gold-300);
        border: none;
        cursor: pointer;
    }
    
    .profile-view-load-more:hover {
        background: var(--steam-iron-700);
    }
    
    .lightbox-overlay {
        position: fixed;
        inset: 0;
        z-index: 5000;
        background: rgba(0, 0, 0, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        overflow-y: auto;
        cursor: pointer;
    }
    
    .lightbox-content {
        cursor: default;
    }
    
    .lightbox-overlay.show {
        display: flex;
    }
    
    .lightbox-content {
        position: relative;
        max-width: 90vw;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
        margin: auto;
    }
    
    .lightbox-image,
    .lightbox-video {
        max-width: 90vw;
        max-height: 80vh;
        object-fit: contain;
        border-radius: 8px;
    }
    
    .lightbox-video {
        background: black;
    }
    
    .discord-share-btn:hover:not(:disabled) {
        background: #4752C4;
    }
    
    .discord-share-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .lightbox-close {
        position: fixed;
        top: 1rem;
        right: 1rem;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 50%;
        width: 2.5rem;
        height: 2.5rem;
        font-size: 1.5rem;
        cursor: pointer;
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
        line-height: 1;
    }
    
    .lightbox-close:hover {
        background: rgba(0, 0, 0, 0.9);
    }
</style>
{% endblock %}

{% block content %}
<!-- ヘッダー画像 -->
<section class="profile-view-header">
    <div class="profile-view-header-image" id="header-image">
        <div class="no-image">NO Image</div>
    </div>
</section>

<main class="profile-view-container">
    <!-- アバター -->
    <div class="profile-view-avatar">
        <div class="profile-view-avatar-image" id="avatar-image">
            <span>未設定</span>
        </div>
    </div>
    
    <!-- 名前とID -->
    <div class="profile-view-info">
        <div class="profile-view-name" id="profile-name">—</div>
        <div class="profile-view-id" id="profile-id">—</div>
        <div class="profile-view-title" id="profile-title"></div>
        <div class="profile-view-total-likes" id="profile-total-likes-entry" style="margin-top: 0.5rem; color: var(--steam-gold-300); font-size: 0.875rem;">
            <span style="color: var(--steam-iron-300);">獲得したいいね:</span> <span id="total-likes-count">0</span>
        </div>
    </div>
    
    <!-- プロフィール文 -->
    <div class="profile-view-bio" id="profile-bio" style="display: none;"></div>
    
    <!-- 提出一覧 -->
    <h2 class="profile-view-submissions-title">提出一覧</h2>
    <div class="profile-view-submissions-grid" id="submissions-grid">
        <div style="grid-column: 1 / -1; text-align: center; color: var(--steam-iron-300); font-size: 0.875rem;">読み込み中...</div>
    </div>
    <button class="profile-view-load-more" id="load-more-button" style="display: none;" onclick="loadMore()">さらに読み込む</button>
</main>

<!-- ライトボックス -->
<div class="lightbox-overlay" id="lightbox-overlay" onclick="closeLightbox()">
    <button class="lightbox-close" onclick="closeLightbox()">×</button>
    <div class="lightbox-content" onclick="event.stopPropagation()" style="display: flex; flex-direction: column; align-items: center; gap: 1rem; max-width: min(80vw, 1200px); width: 100%; padding: 1rem 0; margin: auto;">
        <div id="lightbox-media-container" style="max-width: min(80vw, 1200px); display: flex; flex-direction: column; align-items: center;">
            <img id="lightbox-image" class="lightbox-image" src="" alt="submission" style="display: none; max-width: min(80vw, 1200px); max-height: 85vh; width: auto; height: auto; object-fit: contain;">
            <video id="lightbox-video" class="lightbox-video" controls style="display: none; max-width: min(80vw, 1200px); max-height: 85vh; width: auto; height: auto; background: black;"></video>
            <div id="lightbox-game" style="display: none; max-width: min(80vw, 1200px); width: auto; height: auto; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem;">
                <img id="lightbox-game-thumbnail" src="" alt="ゲームサムネイル" style="display: none; max-width: 100%; max-height: 60vh; width: auto; height: auto; object-fit: contain; border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--steam-iron-700);">
                <div id="lightbox-game-icon" style="display: flex; flex-direction: column; align-items: center;">
                    <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: var(--steam-gold-300); margin-bottom: 1rem;">
                        <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .69.28 1.32.73 1.77.45.45 1.08.73 1.77.73H21a2 2 0 1 1 0 4h-.09c-.69 0-1.32.28-1.77.73-.45.45-.73 1.08-.73 1.77z"/>
                    </svg>
                    <div id="lightbox-game-label" style="font-size: 1.25rem; letter-spacing: 0.1em; font-weight: 600; color: var(--steam-gold-300); margin-bottom: 0.5rem;">GAME</div>
                </div>
                <a id="lightbox-game-link" href="" target="_blank" rel="noreferrer" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 9999px; background: var(--steam-gold-500); color: black; font-size: 0.875rem; font-weight: 600; text-decoration: none; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='var(--steam-gold-400)'" onmouseout="this.style.background='var(--steam-gold-500)'">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                    ゲームを開く
                </a>
            </div>
        </div>
        <!-- 情報表示（画像の下） -->
        <div id="lightbox-info" style="display: none; max-width: 90vw; width: 100%; padding: 1rem; color: var(--steam-gold-200);">
            <div id="lightbox-title" style="font-size: 1.125rem; font-weight: 600; color: var(--steam-gold-300); margin-bottom: 0.5rem; display: none;"></div>
            <div id="lightbox-caption" style="font-size: 0.875rem; color: var(--steam-iron-200); margin-bottom: 0.75rem; white-space: pre-wrap; word-break: break-word; display: none; line-height: 1.5;"></div>
            <div id="lightbox-hashtags" style="display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
        </div>
        <div id="lightbox-actions" style="display: none; margin-top: 1rem; gap: 0.5rem; align-items: center; justify-content: center;">
            <button id="discord-share-btn" class="discord-share-btn" onclick="shareToDiscord()" style="display: inline-flex; align-items: center; gap: 0.5rem; background: #5865F2; color: white; border: none; border-radius: 9999px; padding: 0.5rem 1rem; font-size: 0.875rem; cursor: pointer; transition: background 0.2s;">
                <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.317 4.369A19.791 19.791 0 0 0 16.558 3c-.2.363-.43.85-.59 1.23a18.33 18.33 0 0 0-5.934 0A9.145 9.145 0 0 0 9.464 3a19.736 19.736 0 0 0-3.759 1.369C2.83 8.165 2.18 11.86 2.454 15.5a19.9 19.9 0 0 0 4.883 2.469c.395-.54.747-1.11 1.053-1.706a12.7 12.7 0 0 1-1.66-.8c.14-.103.277-.211.408-.322 3.219 1.5 6.711 1.5 9.896 0 .133.111.27.219.41.322-.53.31-1.09.583-1.668.8.306.596.658 1.166 1.053 1.706a19.9 19.9 0 0 0 4.882-2.469c.4-5.09-.683-8.753-2.524-11.131ZM9.861 13.623c-.96 0-1.748-.88-1.748-1.957 0-1.078.77-1.958 1.748-1.958.978 0 1.766.88 1.748 1.958 0 1.078-.77 1.957-1.748 1.957Zm4.295 0c-.96 0-1.748-.88-1.748-1.957 0-1.078.77-1.958 1.748-1.958s1.748.88 1.748 1.958c0 1.078-.77 1.957-1.748 1.957Z"/>
                </svg>
                <span>Discordにシェア</span>
            </button>
        </div>
    </div>
</div>

<script>
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    const token = getAccessToken();
    
    // 認証チェック
    if (!requireAuth()) {
        // requireAuth()がfalseを返した場合、既にリダイレクトされている
    }
    
    let currentUserId = null;
    let nextCursor = null;
    let submissions = [];
    
    // 初期データ読み込み
    document.addEventListener('DOMContentLoaded', function() {
        // ロールチェック：一般ユーザー（FREE_USER）はこのページにアクセスできない
        const token = localStorage.getItem('access_token');
        if (token) {
            fetch('/api/users/me/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(res => {
                if (res.ok) {
                    return res.json();
                }
                throw new Error(`HTTP ${res.status}`);
            })
            .then(userData => {
                if (userData.role === 'FREE_USER') {
                    window.location.href = '/upgrade/';
                    return;
                }
                // 課金ユーザー以上の場合は通常の処理を続行
                loadProfile();
            })
            .catch(err => {
                console.error('Error fetching user data:', err);
                // エラーが発生した場合は通常の処理を続行
                loadProfile();
            });
        } else {
            // トークンがない場合はログインページにリダイレクト
            window.location.href = '/login/';
        }
    });
    
    async function loadProfile() {
        try {
            // URLパラメータからuserを取得（他のユーザーのプロフィールを表示する場合）
            const urlParams = new URLSearchParams(window.location.search);
            const targetUserId = urlParams.get('user');
            
            let targetDisplayId = null;
            if (targetUserId) {
                // 指定されたユーザーのプロフィールを表示
                targetDisplayId = targetUserId;
            } else {
                // 自分のユーザー情報を取得
                const metaRes = await fetch('/api/users/me/meta/', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    }
                });
                const metaData = await metaRes.json();
                
                if (metaData.display_id) {
                    targetDisplayId = metaData.display_id;
                    currentUserId = metaData.display_id;
                }
            }
            
            if (targetDisplayId) {
                // プロフィール情報を取得
                const profileRes = await fetch(`/api/user/profile/${encodeURIComponent(targetDisplayId)}/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    }
                });
                
                if (!profileRes.ok) {
                    throw new Error('Failed to load profile');
                }
                
                const metaData = await profileRes.json();
                currentUserId = targetDisplayId;
                
                // プロフィール情報を表示
                // APIレスポンスはキャメルケース（headerUrl, avatarUrl）で返される
                const headerUrl = metaData.headerUrl || metaData.header_url;
                const avatarUrl = metaData.avatarUrl || metaData.avatar_url;
                const displayName = metaData.displayName || metaData.display_name;
                const anonId = metaData.anonId || metaData.display_id;
                const activeTitle = metaData.activeTitle || metaData.active_title;
                const activeTitleUntil = metaData.activeTitleUntil || metaData.active_title_until;
                
                if (headerUrl) {
                    document.getElementById('header-image').innerHTML = `<img src="${headerUrl}" alt="header">`;
                } else {
                    document.getElementById('header-image').innerHTML = '<div class="no-image">ヘッダー画像なし</div>';
                }
                
                if (avatarUrl) {
                    document.getElementById('avatar-image').innerHTML = `<img src="${avatarUrl}" alt="avatar">`;
                } else {
                    document.getElementById('avatar-image').innerHTML = '<div class="no-image">アバターなし</div>';
                }
                
                if (displayName) {
                    document.getElementById('profile-name').textContent = displayName;
                } else if (anonId) {
                    document.getElementById('profile-name').textContent = anonId;
                }
                
                if (anonId) {
                    document.getElementById('profile-id').textContent = anonId;
                }
                
                if (activeTitle) {
                    document.getElementById('profile-title').innerHTML = `<span style="color: var(--steam-gold-300);">称号: ${activeTitle}</span>`;
                } else {
                    document.getElementById('profile-title').innerHTML = '';
                }
                
                if (metaData.bio) {
                    document.getElementById('profile-bio').textContent = metaData.bio;
                    document.getElementById('profile-bio').style.display = 'block';
                } else {
                    document.getElementById('profile-bio').style.display = 'none';
                }
                
                // 獲得したいいねの合計を表示
                const totalLikes = metaData.totalLikes || 0;
                document.getElementById('total-likes-count').textContent = totalLikes;
                
                // 提出物を読み込み
                loadSubmissions();
            }
        } catch (err) {
            console.error('Failed to load profile:', err);
        }
    }
    
    async function loadSubmissions() {
        if (!currentUserId) return;
        
        try {
            const url = nextCursor 
                ? `/api/user/submissions/${encodeURIComponent(currentUserId)}/?limit=12&cursor=${encodeURIComponent(nextCursor)}`
                : `/api/user/submissions/${encodeURIComponent(currentUserId)}/?limit=12`;
            
            const res = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                }
            });
            const data = await res.json();
            
            if (data.items) {
                submissions = submissions.concat(data.items);
                nextCursor = data.nextCursor || null;
                renderSubmissions();
                
                if (nextCursor) {
                    document.getElementById('load-more-button').style.display = 'block';
                } else {
                    document.getElementById('load-more-button').style.display = 'none';
                }
            }
        } catch (err) {
            console.error('Failed to load submissions:', err);
            document.getElementById('submissions-grid').innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: var(--steam-iron-300); font-size: 0.875rem;">提出物の読み込みに失敗しました</div>';
        }
    }
    
    function renderSubmissions() {
        const grid = document.getElementById('submissions-grid');
        
        if (submissions.length === 0) {
            grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: var(--steam-iron-300); font-size: 0.875rem;">提出はまだありません</div>';
            return;
        }
        
        grid.innerHTML = submissions.map(s => {
            const isGame = s.gameUrl;
            const isVideo = s.videoUrl;
            const imageUrl = s.displayImageUrl || s.imageUrl;
            const videoUrl = s.videoUrl;
            const gameUrl = s.gameUrl;
            
            let content = '';
            if (isGame) {
                // サムネイル画像があれば表示、なければアイコンを表示
                if (imageUrl) {
                    content = `<img src="${imageUrl}" alt="ゲームサムネイル" style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;" onclick="openLightbox('${gameUrl}', 'game', '${s.id}')">`;
                } else {
                    content = `
                        <div class="game-icon">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .69.28 1.32.73 1.77.45.45 1.08.73 1.77.73H21a2 2 0 1 1 0 4h-.09c-.69 0-1.32.28-1.77.73-.45.45-.73 1.08-.73 1.77z"/>
                            </svg>
                            <div class="game-icon-text">GAME</div>
                        </div>
                    `;
                }
            } else if (isVideo) {
                content = `
                    <video src="${videoUrl}" muted preload="metadata" onclick="openLightbox('${videoUrl}', 'video', '${s.id}')"></video>
                    <div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none;">
                        <div style="height: 3rem; width: 3rem; border-radius: 50%; background: rgba(0, 0, 0, 0.6); color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M8 5v14l11-7z" />
                            </svg>
                        </div>
                    </div>
                `;
            } else {
                content = `<img src="${imageUrl}" alt="submission" onclick="openLightbox('${imageUrl}', 'image', '${s.id}')">`;
            }
            
            return `
                <div class="profile-view-submission-item ${isGame ? 'game' : (isVideo ? 'video' : '')}">
                    ${content}
                    <button class="like-button ${s.liked ? 'liked' : ''}" onclick="toggleLike('${s.id}', ${s.liked || false})" style="pointer-events: auto;">
                        <svg viewBox="0 0 24 24" fill="${s.liked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z" />
                        </svg>
                        <span>${s.likesCount || 0}</span>
                    </button>
                    ${isGame && gameUrl ? `
                        <div class="game-link" onclick="openLightbox('${gameUrl}', 'game', '${s.id}')" style="cursor: pointer;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .69.28 1.32.73 1.77.45.45 1.08.73 1.77.73H21a2 2 0 1 1 0 4h-.09c-.69 0-1.32.28-1.77.73-.45.45-.73 1.08-.73 1.77z"/>
                            </svg>
                            開く
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
    }
    
    function loadMore() {
        loadSubmissions();
    }
    
    async function toggleLike(submissionId, currentLiked) {
        const item = submissions.find(s => s.id === submissionId);
        if (!item) return;
        
        // 楽観的更新（即座にカウントを更新）
        item.liked = !currentLiked;
        // likesCountとlikes_countの両方に対応
        const currentCount = item.likesCount || item.likes_count || 0;
        const newCount = Math.max(0, currentCount + (currentLiked ? -1 : 1));
        item.likesCount = newCount;
        item.likes_count = newCount;
        renderSubmissions();
        
        try {
            const method = currentLiked ? 'DELETE' : 'POST';
            const response = await fetch(`/api/submissions/${encodeURIComponent(submissionId)}/like/`, {
                method: method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
                body: method === 'POST' ? JSON.stringify({}) : undefined
            });
            
            const data = await response.json();
            if (data.ok !== undefined && data.likesCount !== undefined) {
                // サーバーからの結果で更新
                item.liked = data.liked || false;
                item.likesCount = data.likesCount || 0;
                item.likes_count = data.likesCount || 0;
                renderSubmissions();
            }
        } catch (err) {
            // エラー時は元に戻す
            item.liked = currentLiked;
            const currentCount = item.likesCount || item.likes_count || 0;
            const rollbackCount = Math.max(0, currentCount + (currentLiked ? 1 : -1));
            item.likesCount = rollbackCount;
            item.likes_count = rollbackCount;
            renderSubmissions();
            console.error('Failed to toggle like:', err);
        }
    }
    
    // ライトボックス機能
    let currentLightboxAssetId = null;
    
    async function openLightbox(url, type, assetId) {
        const overlay = document.getElementById('lightbox-overlay');
        const image = document.getElementById('lightbox-image');
        const video = document.getElementById('lightbox-video');
        const lightboxActions = document.getElementById('lightbox-actions');
        const lightboxInfo = document.getElementById('lightbox-info');
        const lightboxTitle = document.getElementById('lightbox-title');
        const lightboxCaption = document.getElementById('lightbox-caption');
        const lightboxHashtags = document.getElementById('lightbox-hashtags');
        const lightboxGame = document.getElementById('lightbox-game');
        const lightboxGameLink = document.getElementById('lightbox-game-link');
        
        currentLightboxAssetId = assetId;
        
        if (type === 'video') {
            image.style.display = 'none';
            video.style.display = 'block';
            if (lightboxGame) lightboxGame.style.display = 'none';
            video.src = url;
            video.load();
        } else if (type === 'game') {
            image.style.display = 'none';
            video.style.display = 'none';
            if (lightboxGame) {
                lightboxGame.style.display = 'flex';
                if (lightboxGameLink && url) {
                    lightboxGameLink.href = url;
                }
            }
        } else {
            video.style.display = 'none';
            image.style.display = 'block';
            if (lightboxGame) lightboxGame.style.display = 'none';
            image.src = url;
        }
        
        // Discordシェアボタンを表示（画像と動画のみ）
        if (type === 'image' || type === 'video') {
            lightboxActions.style.display = 'flex';
        } else {
            lightboxActions.style.display = 'none';
        }
        
        // 投稿詳細情報を取得
        if (assetId) {
            try {
                const res = await fetch(`/api/submissions/${assetId}/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (res.ok) {
                    const data = await res.json();
                    
                    // ゲーム投稿の場合、サムネイルを表示
                    if (type === 'game') {
                        const thumbnailImg = document.getElementById('lightbox-game-thumbnail');
                        const gameIcon = document.getElementById('lightbox-game-icon');
                        const displayImageUrl = data.display_image_url || data.thumbnail_url || (data.thumbnail ? data.thumbnail : null);
                        
                        if (thumbnailImg && gameIcon) {
                            if (displayImageUrl) {
                                thumbnailImg.src = displayImageUrl;
                                thumbnailImg.style.display = 'block';
                                gameIcon.style.display = 'none';
                            } else {
                                thumbnailImg.style.display = 'none';
                                gameIcon.style.display = 'flex';
                            }
                        }
                    }
                    
                    // タイトルを表示
                    if (data.title) {
                        lightboxTitle.textContent = data.title;
                        lightboxTitle.style.display = 'block';
                    } else {
                        lightboxTitle.style.display = 'none';
                    }
                    // キャプションを表示
                    if (data.caption) {
                        lightboxCaption.textContent = data.caption;
                        lightboxCaption.style.display = 'block';
                    } else {
                        lightboxCaption.style.display = 'none';
                    }
                    // ハッシュタグを表示
                    lightboxHashtags.innerHTML = '';
                    if (data.hashtags && Array.isArray(data.hashtags) && data.hashtags.length > 0) {
                        data.hashtags.forEach(tag => {
                            if (tag && tag.trim()) {
                                const tagEl = document.createElement('span');
                                tagEl.textContent = `#${tag}`;
                                tagEl.style.cssText = 'display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; background: var(--steam-gold-500); color: black; font-size: 0.75rem; cursor: pointer; font-weight: 600;';
                                tagEl.onclick = (e) => {
                                    e.stopPropagation();
                                    filterByHashtag(tag);
                                    closeLightbox();
                                };
                                lightboxHashtags.appendChild(tagEl);
                            }
                        });
                    }
                    lightboxInfo.style.display = 'block';
                } else {
                    lightboxInfo.style.display = 'none';
                }
            } catch (err) {
                console.error('Failed to load submission details:', err);
                lightboxInfo.style.display = 'none';
            }
        } else {
            lightboxInfo.style.display = 'none';
        }
        
        overlay.classList.add('show');
        document.body.style.overflow = 'hidden';
    }
    
    // ハッシュタグで絞り込む関数
    function filterByHashtag(tag) {
        // URLパラメータにハッシュタグを追加してフィードページに遷移
        window.location.href = `/feed/?hashtag=${encodeURIComponent(tag)}`;
    }
    
    function closeLightbox() {
        const overlay = document.getElementById('lightbox-overlay');
        const video = document.getElementById('lightbox-video');
        
        overlay.classList.remove('show');
        document.body.style.overflow = '';
        
        if (video) {
            video.pause();
            video.src = '';
        }
        
        currentLightboxAssetId = null;
    }
    
    // ESCキーで閉じる
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const overlay = document.getElementById('lightbox-overlay');
            if (overlay.classList.contains('show')) {
                closeLightbox();
            }
        }
    });
    
    // Discordシェア機能
    async function shareToDiscord() {
        if (!currentLightboxAssetId) {
            alert('アセットIDが見つかりません');
            return;
        }
        
        const btn = document.getElementById('discord-share-btn');
        const originalText = btn.innerHTML;
        
        try {
            btn.disabled = true;
            btn.innerHTML = '<span>送信中…</span>';
            
            const response = await fetch('/api/share/discord/', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    assetId: currentLightboxAssetId
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.ok) {
                alert('Discordにシェアしました');
                if (data.discordMessageId) {
                    console.log('Discord message ID:', data.discordMessageId);
                }
            } else {
                const errorMsg = data.error || 'Discordへのシェアに失敗しました';
                if (errorMsg.includes('25MB') || errorMsg.includes('20MB')) {
                    alert('ファイルサイズが大きすぎます（25MB以下）');
                } else {
                    alert(errorMsg);
                }
            }
        } catch (err) {
            console.error('Discord share error:', err);
            alert('Discordへのシェアに失敗しました');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
</script>
{% endblock %}

