# インシデントサマリー：TOYBOX データ損失

**日時**: 2026年1月22日 17:00～21:30（約4.5時間）  
**影響**: 全ユーザーデータの損失  
**現状**: サイトは復旧済み、データは空の状態

---

## 何が起きたか

**開始**: OGP（Open Graph Protocol）設定作業  
**経過**: サーバー障害が発生し、復旧作業中にデータベースが初期化される  
**結果**: 全ユーザーデータ（アカウント、投稿、カード情報）が消失

---

## 主な原因

### 1. ファイルシステムの不安定性
- ファイルシステムが繰り返し読み取り専用モードに移行
- Dockerのマウント操作が失敗

### 2. 運用上の判断ミス
- **iptablesの全削除** → SSH接続が遮断
- **コンテナディレクトリの削除** → データベースとの関連付けが失われる

### 3. バックアップの不備
- データベースの自動バックアップが未実施
- 手動バックアップもボリュームデータを含んでいなかった

---

## 損失した内容

- 全ユーザーアカウント
- 全投稿データ
- 全カード情報
- 全リアクション
- 全セッション情報

**データベース構造は保持**（テーブルは存在、データのみ消失）

---

## 復旧済みの機能

✅ サイトが正常にアクセス可能  
✅ 画像・CSSが正常に表示  
✅ OGPが正常に動作  
✅ SSL/TLS証明書が正常  
✅ すべてのDjangoアプリケーション機能  

---

## 即時対応が必要なこと

1. **新しい管理者アカウントの作成**
   ```bash
   docker exec -it backend-web-1 python manage.py createsuperuser
   ```

2. **ユーザーへの通知**
   - データ損失について説明
   - 再登録を依頼

3. **バックアップシステムの構築**（24時間以内）
   - データベースの自動バックアップ（毎日）
   - Dockerボリュームのバックアップ（毎週）

4. **サーバーの健全性チェック**
   - ConoHaサポートに連絡
   - ディスクの状態を確認

---

## 今後の予防策

### 技術面
- ✅ データベースの自動バックアップ（毎日3:00）
- ✅ Dockerボリュームのバックアップ（毎週日曜）
- ✅ ConoHaのスナップショット機能を有効化
- ✅ 監視システムの導入

### 運用面
- ✅ 本番環境への変更は、必ずバックアップを取ってから実施
- ✅ ステージング環境での事前テスト
- ✅ 運用手順書の整備
- ✅ エスカレーション基準の明確化

---

## タイムライン（概要）

| 時刻 | 出来事 | 影響 |
|------|--------|------|
| 17:00 | OGP設定作業開始 | - |
| 17:30 | Caddy再起動でエラー | サービス停止 |
| 18:00 | ポート競合問題 | 復旧作業開始 |
| 18:20 | **iptables削除** | **SSH遮断** |
| 18:30 | システム再起動 | SSH復旧 |
| 18:45 | read-only file system | Docker不安定 |
| 19:30 | システム再起動（2回目） | 一時的改善 |
| 20:30 | 二重Dockerデーモン発見 | - |
| 20:50 | **コンテナディレクトリ削除** | **データ損失** |
| 21:00 | サービス復旧 | サイト正常化 |
| 21:15 | データ損失確認 | ユーザー数: 0 |
| 21:30 | 復旧完了 | - |

---

## ステークホルダーへの影響

### ユーザー
- 全アカウントが削除される
- 投稿データが失われる
- 再登録が必要

### ビジネス
- ユーザー数の減少
- サービスの信頼性低下
- 再構築のコスト

### 技術チーム
- 復旧作業（10時間）
- バックアップシステム構築
- 監視システム構築

---

## 必要なアクション

### 今日中
- [ ] 新しい管理者アカウント作成
- [ ] ユーザー通知の準備
- [ ] データベースバックアップスクリプト作成

### 今週中
- [ ] ConoHaにディスクチェック依頼
- [ ] 自動バックアップの設定と動作確認
- [ ] スナップショット機能の有効化

### 今月中
- [ ] 監視システムの導入
- [ ] ステージング環境の構築
- [ ] 運用手順書の作成

---

## 連絡先

**技術的な質問**: 開発チーム  
**サーバー管理**: ConoHa サポート  
**ビジネス影響**: プロジェクトマネージャー

---

**作成日**: 2026年1月22日  
**作成者**: 開発チーム  
**承認者**: （署名欄）

---

## 添付資料

1. `INCIDENT_REPORT_20260122.md` - 詳細なインシデントレポート
2. `TECHNICAL_DETAILS_20260122.md` - 技術的な詳細分析
3. ターミナルログ: 
   - `c:\Users\ayato\.cursor\projects\c-github-toybox\terminals\1.txt`
   - `c:\Users\ayato\.cursor\projects\c-github-toybox\terminals\11.txt`
   - `c:\Users\ayato\.cursor\projects\c-github-toybox\terminals\12.txt`
