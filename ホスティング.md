### ToyBox を ConoHa で公開する ぜんぶ手順（やさしい版）

これは「中学生でもそのまま順番にやれば公開できる」を目指した説明です。
むずかしい専門用語はできるだけ使いません。ゆっくり順番にやってください。

---

## 0. まず知っておくこと（すごく大事）
- これから打つコマンドは「ConoHa のサーバーに入ってから、Linux の bash で実行」します。
- Windows のパソコンからは PowerShell を開いて、サーバーに SSH で入ります。
- 使うソースコードは GitHub のこれです → `https://github.com/challenge-marlin/toybox.git`。

---

## 1. サーバー（VPS）に入る
1) ConoHa で Ubuntu のサーバーを作ります（22.04 か 24.04 を選べばOK）。
2) ConoHa の画面で「IPアドレス」をメモします。例: `203.0.113.10`
3) PowerShell を開いて、次を打ちます（`app` はログイン名の例）。
   ```bash
   ssh app@203.0.113.10
   ```
4) 初めてつなぐと「Are you sure?」と聞かれます。`yes` と入力 → パスワードを入れます。

TIP: まだユーザーが無いときは、最初は `root` で入り、後でユーザーを作ります（次の章）。

---

## 2. はじめの準備（1回だけ）
サーバーに入った状態で、次を上から順に実行します。

1) ユーザーを作る（`app` は好きな名前でOK）
```bash
sudo adduser app
sudo usermod -aG sudo app
```
2) そのユーザーに切り替えます
```bash
sudo su - app
```
3) 必要な道具を入れます（アップデートなど）
```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y git ufw ca-certificates curl gnupg fail2ban
sudo timedatectl set-timezone Asia/Tokyo
```
4) ファイアウォール（インターネットの出入口の門）を開けます
```bash
sudo ufw allow OpenSSH
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
echo "y" | sudo ufw enable
```

---

## 3. Docker を入れる（アプリを入れる箱）
```bash
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo $VERSION_CODENAME) stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
sudo usermod -aG docker $USER
```
一度ログアウトして入り直すと、`docker` コマンドがそのまま使えます。

---

## 4. ソースコードをもってくる
```bash
cd ~
git clone https://github.com/challenge-marlin/toybox.git
cd toybox
```

アップロード用フォルダを作っておきます。
```bash
mkdir -p backend/public/uploads
```

---

## 5. 設定ファイルを作る（大事）

1) まず「見本」をコピーします。
```bash
cp backend/env.example backend/.env
cp frontend/env.example frontend/.env
```

2) `backend/.env` を開いて、次の行を本番用に直します。
   - `CORS_ORIGINS`: フロントサイトのURL（後で作る https のURL）を入れます。カンマで増やせます。
   - `JWT_SECRET`: 長くてランダムな英数字に変えます（超重要）。

3) `frontend/.env` を開いて、次の行を本番用に直します。
   - `NEXT_PUBLIC_API_BASE=https://api.toybox.example.com`（後で設定するAPIのURL）

編集例（見本）
```env
# backend/.env の例
MONGODB_URI=mongodb://mongo:27017/toybox
MONGODB_DB=toybox
PORT=4000
REDIS_URL=redis://redis:6379
CORS_ORIGINS=https://toybox.example.com
JWT_SECRET=please_change_to_long_random_secret

# frontend/.env の例
NEXT_PUBLIC_API_BASE=https://api.toybox.example.com
```

---

## 6. 住所（ドメイン）と門番（Caddy）を用意

1) ドメインの設定
   - ドメイン管理画面で A レコードを追加します。
     - `toybox.example.com` → サーバーのIP
     - `api.toybox.example.com` → サーバーのIP

2) リバースプロキシ（Caddy）用の設定を作ります。

`Caddyfile`（リポジトリの一番上に作成）
```caddy
toybox.example.com {
  encode gzip
  reverse_proxy frontend:3000
}

api.toybox.example.com {
  encode gzip
  reverse_proxy backend:4000
}
```

`docker-compose.prod.yml`（同じ場所に作成）
```yaml
version: "3.8"
services:
  mongo:
    image: mongo:6
    restart: unless-stopped
    volumes:
      - mongo-data:/data/db

  redis:
    image: redis:7
    restart: unless-stopped

  backend:
    build: ./backend
    env_file:
      - ./backend/.env
    environment:
      - NODE_ENV=production
    depends_on:
      - mongo
      - redis
    restart: unless-stopped
    volumes:
      - uploads-data:/app/public/uploads

  worker:
    build: ./backend
    command: node dist/src/workers/notificationWorker.js
    env_file:
      - ./backend/.env
    depends_on:
      - mongo
      - redis
    restart: unless-stopped

  frontend:
    build: ./frontend
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_BASE=https://api.toybox.example.com
      - BACKEND_INTERNAL_URL=http://backend:4000
    depends_on:
      - backend
    restart: unless-stopped

  caddy:
    image: caddy:2
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    depends_on:
      - frontend
      - backend

volumes:
  mongo-data:
  uploads-data:
  caddy-data:
  caddy-config:
```

---

## 7. 起動する
```bash
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
```

チェック
```bash
docker compose ps
docker compose logs -f backend
docker compose logs -f frontend
```

ブラウザで見る
- `https://toybox.example.com` → サイトが開く
- `https://api.toybox.example.com/api/feed` → JSON が返る

---

## 8. よくあるつまずき
- 画像が表示されない → `frontend/.env` の `NEXT_PUBLIC_API_BASE` が `https://api...` になっているか確認。
- CORS エラーが出る → `backend/.env` の `CORS_ORIGINS` に `https://toybox.example.com` を入れて、バックエンドを再起動。
- アップロードできない → `uploads-data` が読み書きできるか確認（compose の volumes 参照）。

---

## 9. 更新・バックアップ
コードの更新
```bash
cd ~/toybox
git pull origin main
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
```

MongoDB のバックアップ（簡単）
```bash
docker compose exec -T mongo mongodump --archive --db toybox | gzip > toybox_$(date +%Y%m%d_%H%M).gz
```

アップロードファイルのバックアップ（圧縮して取り出す）
```bash
docker run --rm -v $(pwd)/backend/public/uploads:/data alpine sh -c 'cd /data && tar czf - .' > uploads_$(date +%Y%m%d_%H%M).tgz
```

---

## 10. 参考リンク
- ソースコード: `https://github.com/challenge-marlin/toybox.git`

これで公開できます。ゆっくり確実に、上から順に進めてください！


