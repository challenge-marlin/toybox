{% extends 'frontend/base.html' %}
{% load static %}

{% block title %}ToyBox - みんなの投稿{% endblock %}

{% block extra_css %}
<style>
    .feed-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem;
    }
    
    .feed-title {
        margin-bottom: 1rem;
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--steam-gold-300);
    }
    
    .feed-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }
    
    @media (min-width: 768px) {
        .feed-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }
    
    @media (min-width: 1024px) {
        .feed-grid {
            grid-template-columns: repeat(6, 1fr);
        }
    }
    
    .feed-item {
        position: relative;
        border-radius: 8px;
        border: 1px solid var(--steam-iron-700);
        background: var(--steam-iron-900);
        overflow: hidden;
        aspect-ratio: 1;
    }
    
    .feed-item.game {
        border-color: #a855f7;
    }
    
    .feed-item.video {
        border-color: #0ea5e9;
    }
    
    .feed-item-header {
        position: absolute;
        top: 0.5rem;
        left: 0.5rem;
        z-index: 10;
        font-size: 0.625rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.6);
        color: white;
    }
    
    .feed-item-header a {
        color: white;
        text-decoration: none;
    }
    
    .feed-item-header a:hover {
        text-decoration: underline;
    }
    
    .feed-item-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
        padding: 0.75rem;
        cursor: zoom-in;
    }
    
    .feed-item-video-container {
        width: 100%;
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem;
        cursor: pointer;
        position: relative;
    }
    
    .feed-item-video {
        max-height: 100%;
        max-width: 100%;
        object-fit: contain;
        border-radius: 8px;
    }
    
    .feed-item-play-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .feed-item-play-button {
        height: 3rem;
        width: 3rem;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    .feed-item-game-container {
        width: 100%;
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem;
        user-select: none;
    }
    
    .feed-item-game-icon {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--steam-iron-200);
    }
    
    .feed-item-game-icon svg {
        width: 40px;
        height: 40px;
        color: var(--steam-gold-300);
        margin-bottom: 0.25rem;
    }
    
    .feed-item-game-label {
        font-size: 0.75rem;
        letter-spacing: 0.1em;
        font-weight: 600;
    }
    
    .feed-item-ring {
        position: absolute;
        inset: 0;
        pointer-events: none;
        border-radius: 8px;
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    .feed-item.game .feed-item-ring {
        box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.7);
    }
    
    .feed-item.video .feed-item-ring {
        box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.7);
    }
    
    .feed-item:not(.game):not(.video) .feed-item-ring {
        box-shadow: 0 0 0 2px rgba(224, 168, 0, 0.6);
    }
    
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
    }
    
    .feed-like-btn {
        position: absolute;
        bottom: 0.5rem;
        right: 0.5rem;
        z-index: 10;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.6);
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        color: white;
        border: none;
        cursor: pointer;
    }
    
    .feed-like-btn:hover {
        background: rgba(0, 0, 0, 0.8);
    }
    
    .feed-like-btn svg {
        width: 16px;
        height: 16px;
    }
    
    .feed-like-btn.liked svg {
        fill: #fb7185;
        color: #fb7185;
    }
    
    .feed-game-link {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        z-index: 10;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.6);
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        color: white;
        text-decoration: none;
    }
    
    .feed-game-link:hover {
        background: rgba(0, 0, 0, 0.8);
    }
    
    .feed-game-link svg {
        width: 14px;
        height: 14px;
    }
    
    .loading {
        text-align: center;
        padding: 2rem;
        color: var(--steam-iron-300);
        font-size: 0.875rem;
    }
    
    .feed-sentinel {
        height: 4px;
    }
    
    .feed-end-message {
        margin-top: 1rem;
        text-align: center;
        font-size: 0.75rem;
        color: var(--steam-iron-400);
    }
    
    .lightbox-like-btn {
        transition: all 0.2s;
    }
    
    .lightbox-like-btn:hover {
        background: rgba(0, 0, 0, 0.8) !important;
    }
    
    .lightbox-like-btn.liked svg {
        fill: #fb7185;
        color: #fb7185;
    }
</style>
{% endblock %}

{% block content %}
<div class="feed-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h1 class="feed-title" id="sort-by-posted-entry" style="margin-bottom: 0;">みんなの投稿</h1>
        <div id="hashtag-filter" style="display: none; align-items: center; gap: 0.5rem;">
            <span style="font-size: 0.875rem; color: var(--steam-iron-300);">フィルター:</span>
            <span id="hashtag-filter-tag" style="display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; background: var(--steam-gold-500); color: black; font-size: 0.75rem; font-weight: 600;">#</span>
            <button onclick="clearHashtagFilter()" style="padding: 0.25rem 0.5rem; border-radius: 4px; background: var(--steam-iron-700); color: var(--steam-iron-200); border: none; font-size: 0.75rem; cursor: pointer;">×</button>
        </div>
    </div>
    
    <!-- 人気ハッシュタグセクション -->
    <section id="popular-hashtags-section" style="margin-bottom: 1.5rem;">
        <h2 style="margin-bottom: 0.75rem; font-size: 1rem; font-weight: 600; color: var(--steam-gold-300);">人気のハッシュタグ</h2>
        <div id="popular-hashtags" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
            <div class="loading" style="font-size: 0.875rem;">読み込み中...</div>
        </div>
    </section>
    
    <!-- 人気作品セクション -->
    <section id="popular-section" style="margin-bottom: 2rem;">
        <h2 style="margin-bottom: 0.75rem; font-size: 1.25rem; font-weight: 600; color: var(--steam-gold-300);">人気作品</h2>
        <div id="popular-feed" class="feed-grid">
            <div class="loading">読み込み中...</div>
        </div>
    </section>
    
    <!-- 通常の投稿一覧 -->
    <section>
        <h2 style="margin-bottom: 0.75rem; font-size: 1.25rem; font-weight: 600; color: var(--steam-gold-300);">最新の投稿</h2>
        <div id="feed-main-entry" class="feed-grid">
            <div class="loading">読み込み中...</div>
        </div>
    </section>
    <div id="sentinel" class="feed-sentinel"></div>
    <div id="loading-indicator" class="loading" style="display: none;">読み込み中…</div>
    <div id="end-message" class="feed-end-message" style="display: none;">すべて表示しました</div>
</div>

<!-- ライトボックス -->
<div id="lightbox" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; cursor: pointer; align-items: center; justify-content: center; overflow-y: auto;" onclick="closeLightbox()">
    <div id="lightbox-content" onclick="event.stopPropagation()" style="position: relative; max-width: min(80vw, 1200px); width: 100%; display: flex; flex-direction: column; align-items: center; gap: 1rem; padding: 1rem 0; margin: auto;">
        <button id="lightbox-close" onclick="closeLightbox()" aria-label="閉じる" style="position: fixed; top: 1rem; right: 1rem; background: rgba(0, 0, 0, 0.7); color: white; border: none; border-radius: 50%; width: 2.5rem; height: 2.5rem; font-size: 1.5rem; cursor: pointer; z-index: 10000; display: flex; align-items: center; justify-content: center; transition: background 0.2s; line-height: 1;">×</button>
        <div id="lightbox-media-container" style="max-width: min(80vw, 1200px); display: flex; flex-direction: column; align-items: center;">
            <img id="lightbox-image" src="" alt="" style="max-width: min(80vw, 1200px); max-height: 85vh; width: auto; height: auto; object-fit: contain; border-radius: 8px; cursor: default; display: none;">
            <video id="lightbox-video" controls style="max-width: min(80vw, 1200px); max-height: 85vh; width: auto; height: auto; background: black; border-radius: 8px; cursor: default; display: none;"></video>
            <div id="lightbox-game" style="display: none; max-width: min(80vw, 1200px); width: auto; height: auto; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem;">
                <img id="lightbox-game-thumbnail" src="" alt="ゲームサムネイル" style="display: none; max-width: 100%; max-height: 60vh; width: auto; height: auto; object-fit: contain; border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--steam-iron-700);">
                <div id="lightbox-game-icon" style="display: flex; flex-direction: column; align-items: center;">
                    <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: var(--steam-gold-300); margin-bottom: 1rem;">
                        <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .69.28 1.32.73 1.77.45.45 1.08.73 1.77.73H21a2 2 0 1 1 0 4h-.09c-.69 0-1.32.28-1.77.73-.45.45-.73 1.08-.73 1.77z"/>
                    </svg>
                    <div id="lightbox-game-label" style="font-size: 1.25rem; letter-spacing: 0.1em; font-weight: 600; color: var(--steam-gold-300); margin-bottom: 0.5rem;">GAME</div>
                </div>
                <a id="lightbox-game-link" href="" target="_blank" rel="noreferrer" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 9999px; background: var(--steam-gold-500); color: black; font-size: 0.875rem; font-weight: 600; text-decoration: none; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='var(--steam-gold-400)'" onmouseout="this.style.background='var(--steam-gold-500)'">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                    ゲームを開く
                </a>
            </div>
        </div>
        <!-- 情報表示（画像の下） -->
        <div id="lightbox-info" style="display: none; max-width: min(80vw, 1200px); width: 100%; padding: 1rem; color: var(--steam-gold-200);">
            <div id="lightbox-title" style="font-size: 1.125rem; font-weight: 600; color: var(--steam-gold-300); margin-bottom: 0.5rem; display: none;"></div>
            <div id="lightbox-caption" style="font-size: 0.875rem; color: var(--steam-iron-200); margin-bottom: 0.75rem; white-space: pre-wrap; word-break: break-word; display: none; line-height: 1.5;"></div>
            <div id="lightbox-hashtags" style="display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
        </div>
        <div id="lightbox-actions" style="display: none; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
            <button id="lightbox-like-btn" class="lightbox-like-btn" onclick="toggleLightboxLike(event)" style="display: inline-flex; align-items: center; gap: 0.5rem; background: rgba(0, 0, 0, 0.6); color: white; border: none; border-radius: 9999px; padding: 0.5rem 1rem; font-size: 0.875rem; cursor: pointer; transition: all 0.2s;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z" />
                </svg>
                <span id="lightbox-like-count">0</span>
            </button>
            <button id="discord-share-btn" class="discord-share-btn" onclick="shareToDiscord()" style="display: inline-flex; align-items: center; gap: 0.5rem; background: #5865F2; color: white; border: none; border-radius: 9999px; padding: 0.5rem 1rem; font-size: 0.875rem; cursor: pointer;">
                <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.317 4.369A19.791 19.791 0 0 0 16.558 3c-.2.363-.43.85-.59 1.23a18.33 18.33 0 0 0-5.934 0A9.145 9.145 0 0 0 9.464 3a19.736 19.736 0 0 0-3.759 1.369C2.83 8.165 2.18 11.86 2.454 15.5a19.9 19.9 0 0 0 4.883 2.469c.395-.54.747-1.11 1.053-1.706a12.7 12.7 0 0 1-1.66-.8c.14-.103.277-.211.408-.322 3.219 1.5 6.711 1.5 9.896 0 .133.111.27.219.41.322-.53.31-1.09.583-1.668.8.306.596.658 1.166 1.053 1.706a19.9 19.9 0 0 0 4.882-2.469c.4-5.09-.683-8.753-2.524-11.131ZM9.861 13.623c-.96 0-1.748-.88-1.748-1.957 0-1.078.77-1.958 1.748-1.958.978 0 1.766.88 1.748 1.958 0 1.078-.77 1.957-1.748 1.957Zm4.295 0c-.96 0-1.748-.88-1.748-1.957 0-1.078.77-1.958 1.748-1.958s1.748.88 1.748 1.958c0 1.078-.77 1.957-1.748 1.957Z"/>
                </svg>
                <span>Discordにシェア</span>
            </button>
        </div>
    </div>
</div>

<script>
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    let items = [];
    let popularItems = [];
    let nextCursor = null;
    let loading = false;
    let popularLoading = false;
    let hashtagsLoading = false;
    let initialized = false;
    
    function loadFeed(cursor = null) {
        if (loading) return;
        loading = true;
        document.getElementById('loading-indicator').style.display = 'block';
        
        // URLパラメータからハッシュタグを取得（大文字小文字を保持）
        const urlParams = new URLSearchParams(window.location.search);
        let hashtag = urlParams.get('hashtag');
        if (hashtag) {
            hashtag = hashtag.trim();
        }
        
        let url = cursor 
            ? `/api/feed/?cursor=${encodeURIComponent(cursor)}`
            : '/api/feed/';
        
        if (hashtag) {
            url += (url.includes('?') ? '&' : '?') + `hashtag=${encodeURIComponent(hashtag)}`;
            // ハッシュタグフィルターを表示
            document.getElementById('hashtag-filter').style.display = 'flex';
            document.getElementById('hashtag-filter-tag').textContent = `#${hashtag}`;
        } else {
            document.getElementById('hashtag-filter').style.display = 'none';
        }
        
        fetch(url, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token') || ''}`,
                'X-CSRFToken': csrftoken
            }
        })
        .then(res => {
            if (res.status === 401) {
                clearAuth();
                window.location.href = '/login/';
                return null;
            }
            if (res.status === 403) {
                // 403エラーの場合は課金ページにリダイレクト
                window.location.href = '/upgrade/';
                return null;
            }
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            if (!data) return;
            
            if (cursor) {
                const existingIds = new Set(items.map(x => x.id));
                const incoming = (data.items || []).filter(x => !existingIds.has(x.id));
                items = [...items, ...incoming];
            } else {
                items = data.items || [];
            }
            
            nextCursor = data.nextCursor || null;
            renderFeed();
            initialized = true;
        })
        .catch(err => {
            console.error(err);
            // エラー時の表示を更新
            const feed = document.getElementById('feed-main-entry');
            if (feed) {
                feed.innerHTML = '<div class="loading" style="grid-column: 1 / -1; color: #ef4444;">フィードの読み込みに失敗しました。ページをリロードしてください。</div>';
            }
        })
        .finally(() => {
            loading = false;
            document.getElementById('loading-indicator').style.display = 'none';
        });
    }
    
    function loadPopularFeed() {
        if (popularLoading) return;
        popularLoading = true;
        
        const token = localStorage.getItem('access_token');
        if (!token) {
            popularLoading = false;
            return;
        }
        
        fetch('/api/feed/popular/?limit=12', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'X-CSRFToken': csrftoken
            }
        })
        .then(res => {
            if (res.status === 401 || res.status === 403) {
                return null;
            }
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            if (!data) return;
            popularItems = data.items || [];
            renderPopularFeed();
        })
        .catch(err => {
            console.error('Failed to load popular feed:', err);
            const popularFeed = document.getElementById('popular-feed');
            if (popularFeed) {
                popularFeed.innerHTML = '<div class="loading" style="grid-column: 1 / -1; color: #ef4444;">人気作品の読み込みに失敗しました</div>';
            }
        })
        .finally(() => {
            popularLoading = false;
        });
    }
    
    function renderPopularFeed() {
        const popularFeed = document.getElementById('popular-feed');
        if (!popularFeed) return;
        
        if (popularItems.length === 0) {
            popularFeed.innerHTML = '<div class="loading" style="grid-column: 1 / -1;">人気作品はまだありません</div>';
            return;
        }
        
        popularFeed.innerHTML = popularItems.map(item => renderFeedItem(item)).join('');
    }
    
    function renderFeedItem(item) {
        const isGame = item.gameUrl;
        const isVideo = item.videoUrl;
        const itemClass = isGame ? 'game' : (isVideo ? 'video' : '');
        
        let content = '';
        const displayImageUrl = item.displayImageUrl || item.imageUrl;
        if (isGame) {
            // サムネイル画像があれば表示、なければアイコンを表示
            if (displayImageUrl) {
                content = `<img src="${displayImageUrl}" alt="ゲームサムネイル" class="feed-item-image" onclick="openLightbox('${item.gameUrl}', 'game', '${item.id}')">`;
            } else {
                content = `
                    <div class="feed-item-game-container" onclick="openLightbox('${item.gameUrl}', 'game', '${item.id}')" style="cursor: pointer;">
                        <div class="feed-item-game-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .69.28 1.32.73 1.77.45.45 1.08.73 1.77.73H21a2 2 0 1 1 0 4h-.09c-.69 0-1.32.28-1.77.73-.45.45-.73 1.08-.73 1.77z"/>
                            </svg>
                            <div class="feed-item-game-label">GAME</div>
                        </div>
                    </div>
                `;
            }
        } else if (isVideo) {
            content = `
                <div class="feed-item-video-container" onclick="openLightbox('${item.videoUrl}', 'video', '${item.id}')">
                    <video src="${item.videoUrl}" class="feed-item-video" muted preload="metadata"></video>
                    <div class="feed-item-play-overlay">
                        <div class="feed-item-play-button">
                            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 22px; height: 22px;">
                                <path d="M8 5v14l11-7z" />
                            </svg>
                        </div>
                    </div>
                </div>
            `;
        } else {
            content = `<img src="${item.imageUrl || item.displayImageUrl || ''}" alt="投稿画像" class="feed-item-image" onclick="openLightbox('${item.imageUrl || item.displayImageUrl || ''}', 'image', '${item.id}')" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'display: flex; align-items: center; justify-content: center; height: 100%; color: var(--steam-iron-300); font-size: 0.875rem;\\'>画像を読み込めませんでした</div>';">`;
        }
        
        return `
            <div class="feed-item ${itemClass}">
                <div class="feed-item-ring"></div>
                <div class="feed-item-header">
                    <a href="/profile/view/?user=${encodeURIComponent(item.anonId || 'unknown')}">${item.displayName || item.anonId || 'Unknown'}</a>
                </div>
                ${content}
                <button class="feed-like-btn ${item.liked ? 'liked' : ''}" onclick="toggleLike('${item.id}', ${item.liked || false})">
                    <svg viewBox="0 0 24 24" fill="${item.liked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z" />
                    </svg>
                    <span>${item.likesCount || 0}</span>
                </button>
                ${isGame ? `
                    <a href="${item.gameUrl}" target="_blank" rel="noreferrer" class="feed-game-link" title="ゲームを開く" onclick="event.stopPropagation()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .69.28 1.32.73 1.77.45.45 1.08.73 1.77.73H21a2 2 0 1 1 0 4h-.09c-.69 0-1.32.28-1.77.73-.45.45-.73 1.08-.73 1.77z"/>
                        </svg>
                        開く
                    </a>
                ` : ''}
            </div>
        `;
    }
    
    function renderFeed() {
        const feed = document.getElementById('feed-main-entry');
        if (items.length === 0 && initialized) {
            feed.innerHTML = '<div class="loading" style="grid-column: 1 / -1;">投稿はまだありません</div>';
            return;
        }
        
        feed.innerHTML = items.map(item => renderFeedItem(item)).join('');
        
        // 最初のいいねボタンにIDを追加（オンボーディング用）
        const firstLikeBtn = feed.querySelector('.feed-like-btn');
        if (firstLikeBtn && !firstLikeBtn.id) {
            firstLikeBtn.id = 'like-button-entry';
        }
    }
    
    function toggleLike(submissionId, currentLiked) {
        const token = localStorage.getItem('access_token');
        if (!token) {
            alert('ログインが必要です');
            return;
        }
        
        // itemsとpopularItemsの両方を検索
        const itemInFeed = items.find(x => x.id === submissionId);
        const itemInPopular = popularItems.find(x => x.id === submissionId);
        
        // どちらにも存在しない場合は終了
        if (!itemInFeed && !itemInPopular) return;
        
        // 楽観的更新（即座にカウントを更新）
        // 両方の配列に存在する場合は、両方とも更新
        const newLiked = !currentLiked;
        const likesCountDelta = currentLiked ? -1 : 1;
        
        if (itemInFeed) {
            itemInFeed.liked = newLiked;
            itemInFeed.likesCount = Math.max(0, (itemInFeed.likesCount || 0) + likesCountDelta);
        }
        if (itemInPopular) {
            itemInPopular.liked = newLiked;
            itemInPopular.likesCount = Math.max(0, (itemInPopular.likesCount || 0) + likesCountDelta);
        }
        
        // ライトボックスが開いていて、同じ提出物の場合はライトボックス内のいいねも更新
        if (currentLightboxAssetId === submissionId) {
            const likeBtn = document.getElementById('lightbox-like-btn');
            const likeCount = document.getElementById('lightbox-like-count');
            if (likeBtn && likeCount) {
                likeCount.textContent = itemInFeed ? itemInFeed.likesCount : (itemInPopular ? itemInPopular.likesCount : 0);
                if (newLiked) {
                    likeBtn.classList.add('liked');
                    likeBtn.querySelector('svg').setAttribute('fill', 'currentColor');
                } else {
                    likeBtn.classList.remove('liked');
                    likeBtn.querySelector('svg').setAttribute('fill', 'none');
                }
            }
        }
        
        // 両方のレンダリングを更新
        renderFeed();
        renderPopularFeed();
        
        const method = currentLiked ? 'DELETE' : 'POST';
        fetch(`/api/submissions/${encodeURIComponent(submissionId)}/like/`, {
            method: method,
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
            },
            body: method === 'POST' ? JSON.stringify({}) : undefined
        })
        .then(res => res.json())
        .then(data => {
            if (data.ok !== undefined && data.likesCount !== undefined) {
                // サーバーからの結果で両方の配列を更新
                const newLikedState = data.liked || false;
                const newLikesCount = data.likesCount || 0;
                
                if (itemInFeed) {
                    itemInFeed.liked = newLikedState;
                    itemInFeed.likesCount = newLikesCount;
                }
                if (itemInPopular) {
                    itemInPopular.liked = newLikedState;
                    itemInPopular.likesCount = newLikesCount;
                }
                
                // ライトボックスが開いていて、同じ提出物の場合はライトボックス内のいいねも更新
                if (currentLightboxAssetId === submissionId) {
                    const likeBtn = document.getElementById('lightbox-like-btn');
                    const likeCount = document.getElementById('lightbox-like-count');
                    if (likeBtn && likeCount) {
                        likeCount.textContent = newLikesCount;
                        if (newLikedState) {
                            likeBtn.classList.add('liked');
                            likeBtn.querySelector('svg').setAttribute('fill', 'currentColor');
                        } else {
                            likeBtn.classList.remove('liked');
                            likeBtn.querySelector('svg').setAttribute('fill', 'none');
                        }
                    }
                }
                
                // 両方のレンダリングを更新
                renderFeed();
                renderPopularFeed();
            }
        })
        .catch(err => {
            // エラー時はロールバック（両方の配列を元に戻す）
            if (itemInFeed) {
                itemInFeed.liked = currentLiked;
                itemInFeed.likesCount = Math.max(0, (itemInFeed.likesCount || 0) + (currentLiked ? 1 : -1));
            }
            if (itemInPopular) {
                itemInPopular.liked = currentLiked;
                itemInPopular.likesCount = Math.max(0, (itemInPopular.likesCount || 0) + (currentLiked ? 1 : -1));
            }
            
            // ライトボックスが開いていて、同じ提出物の場合はライトボックス内のいいねもロールバック
            if (currentLightboxAssetId === submissionId) {
                const likeBtn = document.getElementById('lightbox-like-btn');
                const likeCount = document.getElementById('lightbox-like-count');
                if (likeBtn && likeCount) {
                    const rollbackCount = itemInFeed ? itemInFeed.likesCount : (itemInPopular ? itemInPopular.likesCount : 0);
                    likeCount.textContent = rollbackCount;
                    if (currentLiked) {
                        likeBtn.classList.add('liked');
                        likeBtn.querySelector('svg').setAttribute('fill', 'currentColor');
                    } else {
                        likeBtn.classList.remove('liked');
                        likeBtn.querySelector('svg').setAttribute('fill', 'none');
                    }
                }
            }
            
            // 両方のレンダリングを更新
            renderFeed();
            renderPopularFeed();
            console.error('Failed to toggle like:', err);
        });
    }
    
    // ライトボックス機能
    let currentLightboxAssetId = null;
    
    async function openLightbox(src, type, assetId) {
        const lightbox = document.getElementById('lightbox');
        const lightboxImage = document.getElementById('lightbox-image');
        const lightboxVideo = document.getElementById('lightbox-video');
        const lightboxActions = document.getElementById('lightbox-actions');
        const lightboxInfo = document.getElementById('lightbox-info');
        const lightboxTitle = document.getElementById('lightbox-title');
        const lightboxCaption = document.getElementById('lightbox-caption');
        const lightboxHashtags = document.getElementById('lightbox-hashtags');
        const lightboxGame = document.getElementById('lightbox-game');
        const lightboxGameLink = document.getElementById('lightbox-game-link');
        
        currentLightboxAssetId = assetId;
        
        if (type === 'video') {
            lightboxImage.style.display = 'none';
            lightboxVideo.style.display = 'block';
            if (lightboxGame) lightboxGame.style.display = 'none';
            lightboxVideo.src = src;
            lightboxVideo.load();
        } else if (type === 'game') {
            lightboxImage.style.display = 'none';
            lightboxVideo.style.display = 'none';
            if (lightboxGame) {
                lightboxGame.style.display = 'flex';
                if (lightboxGameLink && src) {
                    lightboxGameLink.href = src;
                }
                // サムネイルは投稿詳細情報取得後に設定
            }
        } else {
            lightboxImage.style.display = 'block';
            lightboxVideo.style.display = 'none';
            if (lightboxGame) lightboxGame.style.display = 'none';
            lightboxImage.src = src;
        }
        
        // いいねボタンとDiscordシェアボタンを表示（すべてのタイプでいいねボタンを表示）
        lightboxActions.style.display = 'flex';
        
        // Discordシェアボタンは画像と動画のみ表示
        const discordShareBtn = document.getElementById('discord-share-btn');
        if (discordShareBtn) {
            if (type === 'image' || type === 'video') {
                discordShareBtn.style.display = 'inline-flex';
            } else {
                discordShareBtn.style.display = 'none';
            }
        }
        
        // 投稿詳細情報を取得
        if (assetId) {
            // まず、カード上のデータからいいね状態を取得（優先）
            const itemInFeed = items.find(x => x.id === assetId);
            const itemInPopular = popularItems.find(x => x.id === assetId);
            const cardItem = itemInFeed || itemInPopular;
            
            // カード上のいいね状態をライトボックスに反映
            const likeBtn = document.getElementById('lightbox-like-btn');
            const likeCount = document.getElementById('lightbox-like-count');
            if (likeBtn && likeCount && cardItem) {
                const isLiked = cardItem.liked || false;
                const likesCount = cardItem.likesCount || cardItem.likes_count || 0;
                
                likeCount.textContent = likesCount;
                if (isLiked) {
                    likeBtn.classList.add('liked');
                    likeBtn.querySelector('svg').setAttribute('fill', 'currentColor');
                } else {
                    likeBtn.classList.remove('liked');
                    likeBtn.querySelector('svg').setAttribute('fill', 'none');
                }
            }
            
            try {
                const token = localStorage.getItem('access_token');
                const res = await fetch(`/api/submissions/${assetId}/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (res.ok) {
                    const data = await res.json();
                    
                    // カード上のデータがない場合のみ、APIから取得したデータを使用
                    if (!cardItem && likeBtn && likeCount) {
                        const isLiked = data.liked || false;
                        const likesCount = data.likes_count || data.likesCount || 0;
                        
                        likeCount.textContent = likesCount;
                        if (isLiked) {
                            likeBtn.classList.add('liked');
                            likeBtn.querySelector('svg').setAttribute('fill', 'currentColor');
                        } else {
                            likeBtn.classList.remove('liked');
                            likeBtn.querySelector('svg').setAttribute('fill', 'none');
                        }
                    }
                    
                    // ゲーム投稿の場合、サムネイルを表示
                    if (type === 'game') {
                        const thumbnailImg = document.getElementById('lightbox-game-thumbnail');
                        const gameIcon = document.getElementById('lightbox-game-icon');
                        const displayImageUrl = data.display_image_url || data.thumbnail_url || (data.thumbnail ? data.thumbnail : null);
                        
                        if (thumbnailImg && gameIcon) {
                            if (displayImageUrl) {
                                thumbnailImg.src = displayImageUrl;
                                thumbnailImg.style.display = 'block';
                                gameIcon.style.display = 'none';
                            } else {
                                thumbnailImg.style.display = 'none';
                                gameIcon.style.display = 'flex';
                            }
                        }
                    }
                    
                    // タイトルを表示
                    if (data.title) {
                        lightboxTitle.textContent = data.title;
                        lightboxTitle.style.display = 'block';
                    } else {
                        lightboxTitle.style.display = 'none';
                    }
                    // キャプションを表示
                    if (data.caption) {
                        lightboxCaption.textContent = data.caption;
                        lightboxCaption.style.display = 'block';
                    } else {
                        lightboxCaption.style.display = 'none';
                    }
                    // ハッシュタグを表示（大文字小文字を保持）
                    lightboxHashtags.innerHTML = '';
                    if (data.hashtags && Array.isArray(data.hashtags) && data.hashtags.length > 0) {
                        data.hashtags.forEach(tag => {
                            if (tag && tag.trim()) {
                                const tagNormalized = tag.trim();  // 大文字小文字を保持
                                const tagEl = document.createElement('span');
                                tagEl.textContent = `#${tagNormalized}`;
                                tagEl.style.cssText = 'display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; background: var(--steam-gold-500); color: black; font-size: 0.75rem; cursor: pointer; font-weight: 600;';
                                tagEl.onclick = (e) => {
                                    e.stopPropagation();
                                    filterByHashtag(tagNormalized);
                                    closeLightbox();
                                };
                                lightboxHashtags.appendChild(tagEl);
                            }
                        });
                    }
                    lightboxInfo.style.display = 'block';
                } else {
                    lightboxInfo.style.display = 'none';
                }
            } catch (err) {
                console.error('Failed to load submission details:', err);
                lightboxInfo.style.display = 'none';
            }
        } else {
            lightboxInfo.style.display = 'none';
        }
        
        lightbox.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    
    // ハッシュタグで絞り込む関数
    function filterByHashtag(tag) {
        // 大文字小文字を保持
        tag = tag.trim();
        // URLパラメータにハッシュタグを追加してフィードページに遷移
        window.location.href = `/feed/?hashtag=${encodeURIComponent(tag)}`;
    }
    
    // ハッシュタグフィルターをクリア
    function clearHashtagFilter() {
        // 状態をリセット
        items = [];
        nextCursor = null;
        loading = false;
        initialized = false;
        
        // URLを変更してページをリロード
        window.location.href = '/feed/';
    }
    
    function closeLightbox() {
        const lightbox = document.getElementById('lightbox');
        const lightboxVideo = document.getElementById('lightbox-video');
        
        lightbox.style.display = 'none';
        document.body.style.overflow = '';
        
        // 動画を停止
        if (lightboxVideo) {
            lightboxVideo.pause();
            lightboxVideo.src = '';
        }
        
        currentLightboxAssetId = null;
    }
    
    // ESCキーで閉じる
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const lightbox = document.getElementById('lightbox');
            if (lightbox.style.display === 'flex') {
                closeLightbox();
            }
        }
    });
    
    // ライトボックス内のいいね機能
    async function toggleLightboxLike(event) {
        event.stopPropagation();
        
        if (!currentLightboxAssetId) return;
        
        const token = localStorage.getItem('access_token');
        if (!token) {
            alert('ログインが必要です');
            return;
        }
        
        const likeBtn = document.getElementById('lightbox-like-btn');
        const likeCount = document.getElementById('lightbox-like-count');
        if (!likeBtn || !likeCount) return;
        
        const isCurrentlyLiked = likeBtn.classList.contains('liked');
        const currentCount = parseInt(likeCount.textContent) || 0;
        
        // 楽観的更新
        const newLiked = !isCurrentlyLiked;
        const newCount = Math.max(0, currentCount + (isCurrentlyLiked ? -1 : 1));
        
        likeCount.textContent = newCount;
        if (newLiked) {
            likeBtn.classList.add('liked');
            likeBtn.querySelector('svg').setAttribute('fill', 'currentColor');
        } else {
            likeBtn.classList.remove('liked');
            likeBtn.querySelector('svg').setAttribute('fill', 'none');
        }
        
        // フィード内のアイテムも更新
        const itemInFeed = items.find(x => x.id === currentLightboxAssetId);
        const itemInPopular = popularItems.find(x => x.id === currentLightboxAssetId);
        
        if (itemInFeed) {
            itemInFeed.liked = newLiked;
            itemInFeed.likesCount = newCount;
        }
        if (itemInPopular) {
            itemInPopular.liked = newLiked;
            itemInPopular.likesCount = newCount;
        }
        
        // レンダリングを更新
        renderFeed();
        renderPopularFeed();
        
        // API呼び出し
        try {
            const method = isCurrentlyLiked ? 'DELETE' : 'POST';
            const response = await fetch(`/api/submissions/${encodeURIComponent(currentLightboxAssetId)}/like/`, {
                method: method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
                body: method === 'POST' ? JSON.stringify({}) : undefined
            });
            
            const data = await response.json();
            if (data.ok !== undefined && data.likesCount !== undefined) {
                // サーバーからの結果で更新
                const serverLiked = data.liked || false;
                const serverCount = data.likesCount || 0;
                
                likeCount.textContent = serverCount;
                if (serverLiked) {
                    likeBtn.classList.add('liked');
                    likeBtn.querySelector('svg').setAttribute('fill', 'currentColor');
                } else {
                    likeBtn.classList.remove('liked');
                    likeBtn.querySelector('svg').setAttribute('fill', 'none');
                }
                
                // フィード内のアイテムも更新
                if (itemInFeed) {
                    itemInFeed.liked = serverLiked;
                    itemInFeed.likesCount = serverCount;
                }
                if (itemInPopular) {
                    itemInPopular.liked = serverLiked;
                    itemInPopular.likesCount = serverCount;
                }
                
                renderFeed();
                renderPopularFeed();
            }
        } catch (err) {
            console.error('Failed to toggle like:', err);
            // エラー時はロールバック
            likeCount.textContent = currentCount;
            if (isCurrentlyLiked) {
                likeBtn.classList.add('liked');
                likeBtn.querySelector('svg').setAttribute('fill', 'currentColor');
            } else {
                likeBtn.classList.remove('liked');
                likeBtn.querySelector('svg').setAttribute('fill', 'none');
            }
            
            if (itemInFeed) {
                itemInFeed.liked = isCurrentlyLiked;
                itemInFeed.likesCount = currentCount;
            }
            if (itemInPopular) {
                itemInPopular.liked = isCurrentlyLiked;
                itemInPopular.likesCount = currentCount;
            }
            
            renderFeed();
            renderPopularFeed();
        }
    }
    
    // Discordシェア機能
    async function shareToDiscord() {
        if (!currentLightboxAssetId) {
            alert('アセットIDが見つかりません');
            return;
        }
        
        const btn = document.getElementById('discord-share-btn');
        const originalText = btn.innerHTML;
        const token = localStorage.getItem('access_token');
        
        if (!token) {
            alert('ログインが必要です');
            return;
        }
        
        try {
            btn.disabled = true;
            btn.innerHTML = '<span>送信中…</span>';
            
            const response = await fetch('/api/share/discord/', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    assetId: currentLightboxAssetId
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.ok) {
                alert('Discordにシェアしました');
                if (data.discordMessageId) {
                    console.log('Discord message ID:', data.discordMessageId);
                }
            } else {
                const errorMsg = data.message || data.error || 'Discordへのシェアに失敗しました';
                
                if (errorMsg.includes('25MB') || errorMsg.includes('20MB')) {
                    alert('ファイルサイズが大きすぎます（25MB以下）');
                } else {
                    alert(errorMsg);
                }
            }
        } catch (err) {
            console.error('Discord share error:', err);
            alert('Discordへのシェアに失敗しました');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
    
    // 無限スクロール
    const observer = new IntersectionObserver((entries) => {
        for (const entry of entries) {
            if (entry.isIntersecting && nextCursor && !loading) {
                loadFeed(nextCursor);
            }
        }
    }, { root: null, rootMargin: '200px', threshold: 0 });
    
    document.addEventListener('DOMContentLoaded', function() {
        // ロールチェック：一般ユーザー（FREE_USER）はこのページにアクセスできない
        const token = localStorage.getItem('access_token');
        if (!token) {
            // トークンがない場合はログインページにリダイレクト
            window.location.href = '/login/';
            return;
        }
        
        // ロールチェックを実行（並行してfeedも読み込み開始）
        let roleCheckCompleted = false;
        let shouldRedirect = false;
        
        const roleCheckPromise = fetch('/api/users/me/', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(res => {
            if (res.ok) {
                return res.json();
            }
            throw new Error(`HTTP ${res.status}`);
        })
        .then(userData => {
            roleCheckCompleted = true;
            if (userData.role === 'FREE_USER') {
                shouldRedirect = true;
                window.location.href = '/upgrade/';
                return;
            }
            // 課金ユーザー以上の場合は通常の処理を続行
            if (!feedInitialized) {
                initializeFeed();
            }
        })
        .catch(err => {
            console.error('Error fetching user data:', err);
            roleCheckCompleted = true;
            // エラーが発生した場合は通常の処理を続行（API側でチェックされる）
            if (!feedInitialized) {
                initializeFeed();
            }
        });
        
        // タイムアウトを設定（1秒以内にロールチェックが完了しない場合は続行）
        setTimeout(() => {
            if (!roleCheckCompleted && !shouldRedirect && !feedInitialized) {
                console.warn('Role check timeout, proceeding with feed load');
                roleCheckCompleted = true;
                initializeFeed();
            }
        }, 1000);
        
        let feedInitialized = false;
        
        function initializeFeed() {
            if (feedInitialized) return;
            feedInitialized = true;
            loadFeed();
            loadPopularFeed(); // 人気作品を読み込む
            loadPopularHashtags(); // 人気ハッシュタグを読み込む
            observer.observe(document.getElementById('sentinel'));
            
            // すべて表示済みのチェック
            const checkEnd = setInterval(() => {
                if (initialized && !loading && !nextCursor && items.length > 0) {
                    document.getElementById('end-message').style.display = 'block';
                    clearInterval(checkEnd);
                }
            }, 100);
        }
        
        function loadPopularHashtags() {
            if (hashtagsLoading) return;
            hashtagsLoading = true;
            
            const token = localStorage.getItem('access_token');
            if (!token) {
                hashtagsLoading = false;
                return;
            }
            
            fetch('/api/feed/hashtags/?limit=20', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'X-CSRFToken': csrftoken
                }
            })
            .then(res => {
                if (res.status === 401 || res.status === 403) {
                    return null;
                }
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                if (!data) return;
                const hashtagsContainer = document.getElementById('popular-hashtags');
                if (!hashtagsContainer) return;
                
                if (data.hashtags && data.hashtags.length > 0) {
                    hashtagsContainer.innerHTML = data.hashtags.map(hashtag => {
                        // ハッシュタグを大文字小文字を保持して表示
                        if (!hashtag || !hashtag.tag) return '';
                        const tag = String(hashtag.tag).trim();
                        if (!tag) return '';  // 空の場合はスキップ
                        
                        const safeTag = tag.replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        return `
                            <button onclick="filterByHashtag('${safeTag}')" 
                                    style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.375rem 0.75rem; border-radius: 4px; background: var(--steam-iron-800); border: 1px solid var(--steam-iron-700); color: var(--steam-gold-300); font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                    onmouseover="this.style.background='var(--steam-iron-700)'; this.style.borderColor='var(--steam-gold-400)'"
                                    onmouseout="this.style.background='var(--steam-iron-800)'; this.style.borderColor='var(--steam-iron-700)'">
                                <span>#${safeTag}</span>
                                <span style="font-size: 0.75rem; color: var(--steam-iron-300); font-weight: normal;">(${hashtag.count || 0})</span>
                            </button>
                        `;
                    }).filter(html => html).join('');  // 空の要素を除外
                } else {
                    hashtagsContainer.innerHTML = '<div style="font-size: 0.875rem; color: var(--steam-iron-300);">ハッシュタグはまだありません</div>';
                }
            })
            .catch(err => {
                console.error('Failed to load popular hashtags:', err);
                const hashtagsContainer = document.getElementById('popular-hashtags');
                if (hashtagsContainer) {
                    hashtagsContainer.innerHTML = '<div style="font-size: 0.875rem; color: var(--steam-iron-300);">ハッシュタグの読み込みに失敗しました</div>';
                }
            })
            .finally(() => {
                hashtagsLoading = false;
            });
        }
    });
</script>
{% endblock %}

