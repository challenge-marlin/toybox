{% extends 'frontend/base.html' %}
{% load static %}

{% block title %}アカウント作成 - ToyBox{% endblock %}

{% block extra_css %}
<style>
    .signup-container {
        max-width: 28rem;
        margin: 0 auto;
        padding: 1.5rem;
    }
    
    .signup-title {
        margin-bottom: 1rem;
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--steam-gold-300);
    }
    
    .signup-message {
        margin-bottom: 0.75rem;
        padding: 0.5rem;
        border-radius: 4px;
        border: 1px solid var(--steam-iron-700);
        background: var(--steam-iron-900);
        font-size: 0.875rem;
        color: var(--steam-gold-300);
    }
    
    .signup-error {
        margin-bottom: 0.75rem;
        padding: 0.5rem;
        border-radius: 4px;
        border: 1px solid #991b1b;
        background: #7f1d1d;
        font-size: 0.875rem;
        color: #fecaca;
    }
    
    .signup-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .signup-field {
        display: flex;
        flex-direction: column;
    }
    
    .signup-label {
        display: block;
        font-size: 0.875rem;
        color: var(--steam-gold-300);
        margin-bottom: 0.25rem;
    }
    
    .signup-input {
        width: 100%;
        padding: 0.5rem;
        border-radius: 4px;
        border: 1px solid var(--steam-iron-700);
        background: var(--steam-iron-900);
        color: var(--steam-iron-100);
        font-size: 1rem;
    }
    
    .signup-input:focus {
        outline: none;
        border-color: var(--steam-gold-500);
    }
    
    .signup-button {
        width: 100%;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        background: var(--steam-gold-500);
        color: #000;
        font-size: 1rem;
        border: none;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .signup-button:hover:not(:disabled) {
        background: var(--steam-gold-400);
    }
    
    .signup-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="signup-container">
    <h1 class="signup-title">アカウント作成</h1>
    <div id="signup-message" class="signup-message" style="display: none;"></div>
    <div id="signup-error" class="signup-error" style="display: none;"></div>
    <form id="signup-form" class="signup-form" onsubmit="handleSubmit(event)">
        {% csrf_token %}
        <div class="signup-field">
            <label class="signup-label" for="username">ユーザーID（英数_ 3-30文字）</label>
            <input 
                type="text" 
                id="username" 
                name="username" 
                class="signup-input" 
                required 
                minlength="3" 
                maxlength="30" 
                pattern="[a-z0-9_]+"
                title="英数字とアンダースコアのみ使用可能です"
            />
        </div>
        <div class="signup-field">
            <label class="signup-label" for="display_name">表示名</label>
            <input 
                type="text" 
                id="display_name" 
                name="display_name" 
                class="signup-input" 
                maxlength="50"
            />
        </div>
        <div class="signup-field">
            <label class="signup-label" for="password">パスワード（8文字以上）</label>
            <input 
                type="password" 
                id="password" 
                name="password" 
                class="signup-input" 
                required 
                minlength="8" 
                maxlength="128"
            />
        </div>
        <button type="submit" id="signup-button" class="signup-button">作成</button>
    </form>
</div>

<script>
    // ページ読み込み時に認証チェック
    document.addEventListener('DOMContentLoaded', function() {
        redirectIfAuthenticated();
    });
    
    async function handleSubmit(e) {
        e.preventDefault();
        
        const messageDiv = document.getElementById('signup-message');
        const errorDiv = document.getElementById('signup-error');
        const button = document.getElementById('signup-button');
        const form = document.getElementById('signup-form');
        
        // Hide previous messages
        messageDiv.style.display = 'none';
        errorDiv.style.display = 'none';
        
        // Get form data
        const formData = new FormData(form);
        const username = formData.get('username').trim().toLowerCase();
        const displayName = formData.get('display_name').trim();
        const password = formData.get('password');
        
        // Validate username format
        if (!/^[a-z0-9_]+$/.test(username)) {
            errorDiv.textContent = 'ユーザーIDは英数字とアンダースコアのみ使用可能です';
            errorDiv.style.display = 'block';
            return;
        }
        
        // Disable button
        button.disabled = true;
        button.textContent = '作成中…';
        
        // Get CSRF token
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        
        try {
            const response = await fetch('/api/auth/register/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({
                    username: username,
                    display_name: displayName || username,
                    password: password
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.ok) {
                // Store tokens
                if (data.access) {
                    setAccessToken(data.access);
                }
                if (data.refresh) {
                    setRefreshToken(data.refresh);
                }
                
                // ロールに応じてリダイレクト先を決定
                const redirectUrl = (data.role === 'FREE_USER') ? '/upgrade/' : '/me/';
                const redirectMessage = (data.role === 'FREE_USER') 
                    ? 'アカウントを作成しました。課金についてのページへ移動します…' 
                    : 'アカウントを作成しました。マイページへ移動します…';
                
                // Show success message
                messageDiv.textContent = redirectMessage;
                messageDiv.style.display = 'block';
                
                // Redirect based on role
                setTimeout(() => {
                    window.location.href = redirectUrl;
                }, 1000);
            } else {
                // Show error
                const errorMsg = data.errors ? 
                    (typeof data.errors === 'string' ? data.errors : 
                     Object.values(data.errors).flat().join(', ')) : 
                    (data.message || '登録に失敗しました');
                errorDiv.textContent = errorMsg;
                errorDiv.style.display = 'block';
                button.disabled = false;
                button.textContent = '作成';
            }
        } catch (err) {
            errorDiv.textContent = err.message || 'エラーが発生しました';
            errorDiv.style.display = 'block';
            button.disabled = false;
            button.textContent = '作成';
        }
    }
</script>
{% endblock %}

