# TOYBOXシステム構成図

## 📊 システム全体構成

```
┌─────────────────────────────────────────────────────────────────────┐
│                         インターネット                                │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  │ HTTPS (443/TCP)
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    🌐 Caddy Webサーバー                               │
│              (リバースプロキシ / SSL/TLS / 静的ファイル配信)            │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │                           │
                    ▼                           ▼
        ┌─────────────────────┐     ┌─────────────────────┐
        │  静的ファイル配信     │     │   Django アプリ      │
        │  (/static/*)         │     │   (Gunicorn)         │
        │                      │     │   :8000              │
        │  - CSS               │     └─────────────────────┘
        │  - JavaScript        │                │
        │  - 画像              │                │
        │  - OGP画像           │                │
        └─────────────────────┘                │
                                               │
                    ┌──────────────────────────┼──────────────────────┐
                    │                          │                      │
                    ▼                          ▼                      ▼
        ┌─────────────────────┐   ┌─────────────────────┐  ┌──────────────────┐
        │  📦 PostgreSQL       │   │  🔴 Redis            │  │  🔄 Celery       │
        │  データベース         │   │  キャッシュ           │  │  非同期処理       │
        │  :5432               │   │  セッション管理       │  │                  │
        │                      │   │  :6379               │  │  - Worker        │
        │  - ユーザー情報       │   └─────────────────────┘  │  - Beat          │
        │  - 投稿データ         │                             │  (スケジューラ)   │
        │  - カード情報         │                             └──────────────────┘
        │  - 称号情報           │
        │  - いいね/コメント    │
        └─────────────────────┘
                    ▲
                    │
                    │ SSO連携
                    │
        ┌─────────────────────┐
        │  🔐 StudySphere      │
        │  外部認証システム     │
        │                      │
        │  - チケット検証       │
        │  - ユーザー情報取得   │
        └─────────────────────┘
```

---

## 🏗️ コンテナ構成（Docker Compose）

### バックエンドコンテナ群 (backend_default ネットワーク)

```
┌─────────────────────────────────────────────────────────────┐
│                    backend_default network                  │
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │ backend-db-1 │  │backend-web-1 │  │backend-redis-1│   │
│  │ PostgreSQL   │  │ Django       │  │ Redis         │   │
│  │ :5432        │  │ Gunicorn     │  │ :6379         │   │
│  └──────────────┘  │ :8000        │  └──────────────┘    │
│                    └──────────────┘                        │
│                                                             │
│  ┌──────────────┐  ┌──────────────┐                       │
│  │backend-      │  │backend-beat-1│                       │
│  │worker-1      │  │ Celery Beat  │                       │
│  │ Celery Worker│  │ (スケジュール)│                       │
│  └──────────────┘  └──────────────┘                       │
└─────────────────────────────────────────────────────────────┘
                           ▲
                           │ 接続
                           │
┌─────────────────────────────────────────────────────────────┐
│                        本番環境                              │
│                                                             │
│  ┌──────────────────────────────────────────────────┐      │
│  │  toybox-caddy (Caddyコンテナ)                    │      │
│  │  - ポート 80/443 公開                             │      │
│  │  - backend_defaultネットワークに接続              │      │
│  │  - 静的ファイルボリューム (backend_static_volume) │      │
│  └──────────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

---

## 📁 データボリューム構成

```
┌─────────────────────────────────────────┐
│         Dockerボリューム                 │
├─────────────────────────────────────────┤
│                                         │
│  📦 postgres_data                       │
│     - PostgreSQLデータ永続化            │
│                                         │
│  📦 backend_static_volume               │
│     - Django静的ファイル                │
│     - Caddyと共有                       │
│                                         │
│  📦 media_volume                        │
│     - ユーザーアップロード画像/動画      │
│     - カード画像                        │
│     - 称号画像                          │
│                                         │
│  📦 caddy-data                          │
│     - SSL証明書                         │
│                                         │
│  📦 caddy-config                        │
│     - Caddy設定                         │
└─────────────────────────────────────────┘
```

---

## 🔄 リクエストフロー

### 1. 通常のWebページリクエスト

```
ユーザー (ブラウザ)
    │
    │ HTTPS GET /me/
    ▼
Caddy :443
    │
    │ reverse_proxy
    ▼
Django (Gunicorn) :8000
    │
    ├─ テンプレートレンダリング
    ├─ PostgreSQL クエリ
    └─ レスポンス返却
    │
    ▼
ユーザー (ブラウザ)
```

### 2. APIリクエスト

```
ユーザー (ブラウザ)
    │
    │ HTTPS GET /api/users/me/meta/
    │ Authorization: Bearer [token]
    ▼
Caddy :443
    │
    │ reverse_proxy
    ▼
Django REST API :8000
    │
    ├─ JWT認証
    ├─ PostgreSQL クエリ
    ├─ Redis キャッシュチェック
    └─ JSON レスポンス
    │
    ▼
ユーザー (ブラウザ)
```

### 3. 静的ファイルリクエスト

```
ユーザー (ブラウザ)
    │
    │ HTTPS GET /static/frontend/css/base.css
    ▼
Caddy :443
    │
    │ file_server (backend_static_volumeから直接配信)
    │
    ▼
ユーザー (ブラウザ)
```

### 4. StudySphere SSO認証フロー

```
StudySphereユーザー
    │
    │ TOYBOXボタンをクリック
    ▼
StudySphere
    │
    │ チケット発行 & リダイレクト
    │ ?ticket=[token]
    ▼
TOYBOX (/sso/login/)
    │
    ├─ チケット検証 (StudySphere APIへリクエスト)
    ├─ ユーザー情報取得
    ├─ ログイン処理
    └─ マイページへリダイレクト
    │
    ▼
マイページ (/me/)
```

---

## 🔧 技術スタック

### フロントエンド
- **テンプレートエンジン**: Django Templates
- **スタイル**: CSS (カスタム、Steam風デザイン)
- **スクリプト**: Vanilla JavaScript
- **認証**: JWT (localStorage保存)

### バックエンド
- **フレームワーク**: Django 4.x
- **REST API**: Django REST Framework
- **WSGI サーバー**: Gunicorn (4 workers)
- **非同期処理**: Celery + Redis

### データベース
- **RDBMS**: PostgreSQL 15
- **キャッシュ**: Redis 7

### インフラ
- **Webサーバー**: Caddy 2
- **コンテナ**: Docker + Docker Compose
- **SSL/TLS**: Caddy自動取得 (Let's Encrypt)
- **サーバー**: ConoHa VPS

### 外部連携
- **SSO**: StudySphere (チケットベース認証)
- **Discord**: Webhook連携 (投稿シェア機能)

---

## 🌐 ネットワーク構成

```
┌──────────────────────────────────────────────────────────┐
│              ConoHa VPS (160.251.168.144)                │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  OS: Ubuntu/CentOS                                       │
│  Docker Engine                                           │
│                                                          │
│  ┌────────────────────────────────────────────────┐     │
│  │  backend_default (Docker Network)              │     │
│  │                                                │     │
│  │  - backend-db-1      (172.20.0.x)             │     │
│  │  - backend-web-1     (172.20.0.x)             │     │
│  │  - backend-redis-1   (172.20.0.x)             │     │
│  │  - backend-worker-1  (172.20.0.x)             │     │
│  │  - backend-beat-1    (172.20.0.x)             │     │
│  │  - toybox-caddy      (172.20.0.x)             │     │
│  └────────────────────────────────────────────────┘     │
│                                                          │
│  ポートマッピング:                                       │
│  - 80:80   (HTTP → Caddy)                               │
│  - 443:443 (HTTPS → Caddy)                              │
└──────────────────────────────────────────────────────────┘
```

---

## 📊 データフロー図

```
┌─────────────┐
│   ユーザー   │
└──────┬──────┘
       │
       │ 1. アクセス
       ▼
┌──────────────────┐
│  Caddy Webサーバー│
└──────┬───────────┘
       │
       │ 2. プロキシ/配信
       ▼
┌──────────────────┐      4. データ読み書き     ┌──────────────┐
│  Django アプリ    │◄──────────────────────────►│ PostgreSQL   │
└──────┬───────────┘                            └──────────────┘
       │
       │ 3. キャッシュアクセス
       ▼
┌──────────────────┐
│     Redis        │
└──────────────────┘
       ▲
       │ 5. タスクキュー
       │
┌──────────────────┐
│  Celery Worker   │
└──────────────────┘
```

---

## 🔐 セキュリティ構成

```
┌────────────────────────────────────────────┐
│            セキュリティレイヤー             │
├────────────────────────────────────────────┤
│                                            │
│  1. SSL/TLS暗号化 (Caddy)                  │
│     - Let's Encrypt自動証明書              │
│     - HTTPS強制                            │
│                                            │
│  2. JWT認証 (Django)                       │
│     - Access Token                         │
│     - Refresh Token                        │
│                                            │
│  3. CSRF保護 (Django)                      │
│     - CSRFトークン検証                     │
│                                            │
│  4. パスワードハッシュ化                   │
│     - Django標準 (PBKDF2)                  │
│                                            │
│  5. StudySphere SSO                        │
│     - チケットベース認証                   │
│     - ワンタイムトークン                   │
└────────────────────────────────────────────┘
```

---

## 📈 スケーラビリティ構成

### 現在の構成
- **Gunicorn Workers**: 4
- **Celery Workers**: 1
- **データベース**: シングルインスタンス
- **Redis**: シングルインスタンス

### 将来の拡張計画
- データベースレプリケーション (マスター/スレーブ)
- Celery Workerの追加
- ロードバランサーの導入
- CDN導入 (静的ファイル配信)

---

**作成日**: 2026年1月23日  
**TOYBOX開発チーム**
