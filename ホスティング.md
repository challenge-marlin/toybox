### ToyBox を ConoHa(VPS) にホスティングする手順

このドキュメントは ConoHa VPS 上に ToyBox（一式: MongoDB/Redis/Backend/Frontend）を Docker Compose で常時稼働させるためのチェックリストです。上から順に実施してください。

> 重要: 本書のコマンドは「VPS に SSH 接続した後の Linux bash」で実行します。Windows では PowerShell からサーバへ SSH 接続して、接続先でコマンドを貼り付けてください。

クイックスタート（既に VPS に SSH できる前提）
```bash
# Windows からの接続例（ローカルの PowerShell 等で実行）
ssh app@<VPSのIPまたはホスト名>

# 接続後（VPS上）で一気に起動まで
sudo apt update && sudo apt install -y git
git clone https://github.com/your-org/toybox.git && cd toybox
cp backend/env.example backend/.env && cp frontend/env.example frontend/.env
# 必要に応じて backend/.env と frontend/.env を編集
# 以降の各セクションに沿って Docker/Compose をインストール → 本番用 compose で up
```

---

## 前提
- ConoHa VPS（Ubuntu 22.04/24.04 など）に SSH できること
- ドメインを保有していること（例: `example.com`）
  - フロント: `toybox.example.com`
  - API: `api.toybox.example.com`
- サーバの 80, 443, 22 番ポートが開放されていること（ConoHa コントロールパネル/OS ファイアウォール）

---

## 1) VPS 初期セットアップ（1 回のみ）
1. 新規ユーザー作成と SSH キー設定
   ```bash
   adduser app
   usermod -aG sudo app
   su - app
   mkdir -p ~/.ssh && chmod 700 ~/.ssh
   # ローカルの公開鍵を貼り付け
   nano ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys
   ```
2. 基本パッケージとタイムゾーン
   ```bash
   sudo apt update && sudo apt upgrade -y
   sudo apt install -y git ufw fail2ban ca-certificates curl gnupg
   sudo timedatectl set-timezone Asia/Tokyo
   ```
3. UFW（ファイアウォール）
   ```bash
   sudo ufw allow OpenSSH
   sudo ufw allow 80/tcp
   sudo ufw allow 443/tcp
   echo "y" | sudo ufw enable
   sudo ufw status
   ```
4. スワップ（必要なら）
   ```bash
   sudo fallocate -l 2G /swapfile
   sudo chmod 600 /swapfile
   sudo mkswap /swapfile
   echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
   sudo swapon /swapfile && sudo sysctl vm.swappiness=10
   ```

---

## 2) Docker / Compose のインストール（1 回のみ）
```bash
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo $VERSION_CODENAME) stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
sudo usermod -aG docker $USER
# 一度ログアウト/ログイン
```

---

## 3) プロジェクト配置
```bash
cd ~
git clone https://github.com/your-org/toybox.git
cd toybox
```

永続ディレクトリ（アップロード/DB）を用意します。
```bash
mkdir -p backend/public/uploads
```

---

## 4) 本番用環境変数を設定

Backend の `.env`（`backend/env.example` を参考に作成）：
```env
MONGODB_URI=mongodb://mongo:27017/toybox
MONGODB_DB=toybox
PORT=4000
REDIS_URL=redis://redis:6379

# フロントの本番オリジンをカンマ区切りで（例は 2 つ想定）
CORS_ORIGINS=https://toybox.example.com,https://www.toybox.example.com

# 認証用シークレット（十分に長くランダム）
JWT_SECRET=change_me_in_production_please

# 任意：サイズ制限（MB）
MAX_UPLOAD_MB_POST=1024
MAX_UPLOAD_MB_AVATAR=2
MAX_UPLOAD_MB_HEADER=5
```

Frontend の `.env`（`frontend/env.example` を参考に作成）：
```env
NEXT_PUBLIC_API_BASE=https://api.toybox.example.com
```

メモ:
- Frontend は SSR 時に `BACKEND_INTERNAL_URL` を使用します（Compose で指定）。
- 画像/動画の URL 解決は `NEXT_PUBLIC_API_BASE`（クライアント）と `BACKEND_INTERNAL_URL`（サーバ）で自動判定されます。

---

## 5) docker-compose の本番オーバーライドを用意

以下を `docker-compose.prod.yml` としてリポジトリ直下に作成します（例）。

```yaml
version: "3.8"
services:
  mongo:
    image: mongo:6
    restart: unless-stopped
    volumes:
      - mongo-data:/data/db

  redis:
    image: redis:7
    restart: unless-stopped

  backend:
    build: ./backend
    env_file:
      - ./backend/.env
    environment:
      - NODE_ENV=production
    depends_on:
      - mongo
      - redis
    restart: unless-stopped
    # アップロード先は読み書き可能にする（重要）
    volumes:
      - uploads-data:/app/public/uploads

  worker:
    build: ./backend
    command: node dist/src/workers/notificationWorker.js
    env_file:
      - ./backend/.env
    depends_on:
      - mongo
      - redis
    restart: unless-stopped

  frontend:
    build: ./frontend
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_BASE=https://api.toybox.example.com
      - BACKEND_INTERNAL_URL=http://backend:4000
    depends_on:
      - backend
    restart: unless-stopped

  # 省メンテで自動SSL発行できる Caddy を推奨
  caddy:
    image: caddy:2
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    depends_on:
      - frontend
      - backend

volumes:
  mongo-data:
  uploads-data:
  caddy-data:
  caddy-config:
```

`Caddyfile`（同じくリポジトリ直下に作成）：
```caddy
toybox.example.com {
  encode gzip
  reverse_proxy frontend:3000
}

api.toybox.example.com {
  encode gzip
  reverse_proxy backend:4000
}
```

DNS 設定（ドメイン管理側）
- `toybox.example.com` と `api.toybox.example.com` を VPS のグローバル IP に A レコードで向ける

---

## 6) 起動
```bash
# 初回ビルド＆起動
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build

# 稼働確認
docker compose ps
docker compose logs -f backend
docker compose logs -f frontend
```

ブラウザで確認
- `https://toybox.example.com` → フロントページ
- `https://api.toybox.example.com/api/health`（存在しない場合は `/api/feed` 等）→ 200 レスポンス

---

## 7) 動作チェックリスト（必須）
- 画像/動画のアップロードが成功する（`backend/public/uploads` が書き込み可）
- みんなの投稿で画像/動画が表示できる
- CORS エラーが出ない（`CORS_ORIGINS` にフロントの本番 URL が含まれている）
- ログイン/提出/いいね が動作する

---

## 8) 運用: 更新/再起動/バックアップ

更新（コードを pull して再ビルド）
```bash
git pull origin main
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
```

個別再起動
```bash
docker compose restart backend
docker compose restart frontend
```

MongoDB のバックアップ（簡易）
```bash
# 取得
docker compose exec -T mongo mongodump --archive --db toybox | gzip > toybox_$(date +%Y%m%d_%H%M).gz
# 復元
gunzip -c toybox_YYYYMMDD_HHMM.gz | docker compose exec -T mongo mongorestore --archive --drop
```

アップロード資産のバックアップ
```bash
docker run --rm -v $(pwd)/backend/public/uploads:/data alpine sh -c 'cd /data && tar czf - .'
```

---

## 9) トラブルシュート
- 502/SSL エラー: DNS 伝播前・ポート競合・Caddyfile のホスト名誤りを確認
- アップロード失敗: `uploads-data` が読み取り専用になっていないか、`backend` コンテナの権限を確認
- CORS エラー: `backend/.env` の `CORS_ORIGINS` にフロント URL（https）を追加後、`backend` を再起動
- 画像が表示されない: フロントの `.env` で `NEXT_PUBLIC_API_BASE=https://api...` になっているか確認

---

## 10) セキュリティ/保守の推奨
- `JWT_SECRET` は十分に長いランダム値を使用
- OS セキュリティアップデートを定期適用（`unattended-upgrades` 等）
- バックアップのスケジュール化（Mongo + uploads）
- 監視: `docker compose logs` の定期確認、外形監視（uptime 監視）

---

以上で ConoHa への本番ホスティング準備は完了です。必要に応じて `docker-compose.prod.yml` のリソース制限やスケールを調整してください。


