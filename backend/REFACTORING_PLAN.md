# ToyBox リファクタリング計画

## 📋 現状分析

### 主な問題点

1. **フロントエンドテンプレートの複雑化**
   - HTMLテンプレートに大量のJavaScriptが埋め込まれている
   - コードの再利用性が低い
   - デバッグが困難

2. **URL設定の複雑化**
   - メディアファイル配信の設定が分散している
   - 開発環境と本番環境で異なる設定が必要

3. **重複コード**
   - 認証チェック、エラーハンドリングが各テンプレートで重複
   - API呼び出しパターンが統一されていない

4. **設定ファイルの分散**
   - 環境変数の管理が複雑
   - 設定の優先順位が不明確

## 🎯 リファクタリング目標

1. **コードの可読性向上**
   - テンプレートとロジックの分離
   - 共通機能のモジュール化

2. **保守性の向上**
   - 重複コードの削減
   - 統一されたエラーハンドリング

3. **パフォーマンスの最適化**
   - 静的ファイルの最適化
   - キャッシュ戦略の統一

4. **開発体験の向上**
   - 明確なディレクトリ構造
   - 統一されたコーディング規約

## 📁 新しいディレクトリ構造

```
backend/
├── frontend/
│   ├── static/
│   │   └── frontend/
│   │       ├── js/
│   │       │   ├── common/          # 共通ユーティリティ
│   │       │   │   ├── api.js       # API呼び出しヘルパー
│   │       │   │   ├── auth.js      # 認証関連（既存）
│   │       │   │   ├── utils.js     # 汎用ユーティリティ
│   │       │   │   └── errors.js    # エラーハンドリング
│   │       │   ├── pages/           # ページ固有のスクリプト
│   │       │   │   ├── me.js
│   │       │   │   ├── profile.js
│   │       │   │   ├── feed.js
│   │       │   │   ├── collection.js
│   │       │   │   └── profile_view.js
│   │       │   └── onboarding.js   # オンボーディング（既存）
│   │       └── css/
│   └── templates/
│       └── frontend/                 # HTMLテンプレート（シンプルに）
├── toybox/
│   ├── settings/
│   │   ├── base.py
│   │   ├── dev.py
│   │   └── prod.py
│   ├── urls.py                       # メインURL設定
│   └── media.py                      # メディアファイル配信設定（新規）
└── [その他のアプリ]
```

## 🔧 実装計画

### Phase 1: 共通ユーティリティの作成

1. **API呼び出しヘルパー (`frontend/static/frontend/js/common/api.js`)**
   - 統一されたfetchラッパー
   - 認証トークンの自動付与
   - エラーハンドリングの統一

2. **エラーハンドリング (`frontend/static/frontend/js/common/errors.js`)**
   - 統一されたエラー表示
   - Toast通知の統一

3. **汎用ユーティリティ (`frontend/static/frontend/js/common/utils.js`)**
   - 日付フォーマット
   - 文字数カウント
   - その他の共通関数

### Phase 2: ページ固有スクリプトの分離

1. **各ページのJavaScriptを外部ファイルに分離**
   - `me.html` → `js/pages/me.js`
   - `profile.html` → `js/pages/profile.js`
   - `feed.html` → `js/pages/feed.js`
   - `collection.html` → `js/pages/collection.js`
   - `profile_view.html` → `js/pages/profile_view.js`

2. **テンプレートの簡素化**
   - HTMLテンプレートからJavaScriptを削除
   - データ属性を使用した初期化

### Phase 3: URL設定の整理

1. **メディアファイル配信の統合**
   - `toybox/media.py`を作成
   - 開発環境と本番環境で統一された設定

2. **URLパターンの整理**
   - 論理的なグループ化
   - コメントの追加

### Phase 4: 設定ファイルの整理

1. **環境変数の整理**
   - `.env.example`の更新
   - 設定値のドキュメント化

2. **設定の優先順位の明確化**
   - 環境変数 > 設定ファイル > デフォルト値

## 📝 実装の優先順位

1. **高優先度**
   - 共通ユーティリティの作成
   - ページ固有スクリプトの分離
   - URL設定の整理

2. **中優先度**
   - エラーハンドリングの統一
   - 設定ファイルの整理

3. **低優先度**
   - パフォーマンス最適化
   - ドキュメントの充実

## ✅ 完了基準

- [ ] すべてのJavaScriptが外部ファイルに分離されている
- [ ] 共通ユーティリティが作成され、使用されている
- [ ] URL設定が整理され、ドキュメント化されている
- [ ] エラーハンドリングが統一されている
- [ ] 既存の機能がすべて動作している
- [ ] テストがすべて通過している

## 🚀 次のステップ

1. Phase 1の実装を開始
2. 各ページのスクリプトを段階的に分離
3. 動作確認とテスト
4. ドキュメントの更新

