## ToyBox 開発工程（ワークフロー概要）

本ドキュメントは ToyBox の全体的な作業工程と進め方の指針です。詳細の仕様・指示は `doc/toybox仕様.md` を参照してください。

### フェーズ一覧
- **Phase 0: 準備**
  - Node.js / npm の準備、MongoDB・Redis 環境の用意（必要に応じて）
  - 秘密情報の保存先整理（.env, OS シークレットストア）
- **Phase 1: モノレポ初期化（完了）**
  - `backend/`, `frontend/` の作成
  - `backend/package.json`, `backend/tsconfig.json`
  - `frontend/package.json`, `frontend/tsconfig.json`, `frontend/tailwind.config.js`
- **Phase 2: データモデル & サーバー初期化（完了）**
  - `backend/models/Submission.ts`, `backend/models/UserMeta.ts`
  - `backend/src/server.ts`（Express/CORS/JSON/Mongoose 接続）
- **Phase 3: 抽選・報酬ロジック（完了）**
  - `backend/src/services/lotteryService.ts`
  - 確率: \(P_{final} = \min(0.008 + 0.002 \times k, 0.05)\)
  - 提出後処理: 1日1回チェック→抽選→`lotteryBonusCount` 更新→即時報酬
- **Phase 4: 認証 & API 実装（完了）**
  - 認証ミドルウェア: `requireAnonAuth`
  - `POST /api/submit`（提出→抽選→即時報酬の一括実行）
  - `GET /api/user/me`（匿名ID・称号・カードアルバム・ストリーク）
  - `server.ts` に API ルータ配線
- **Phase 5: フロントエンド UI（完了）**
  - `frontend/src/app` 構成・Tailwind 読み込み
  - `components/SubmitForm.tsx`（送信/結果表示まで）
  - `/api/submit` 連携
- **Phase 6: ジョブキュー/非同期処理（着手）**
  - BullMQ の Queue/Worker 雛形追加、サービスから通知ジョブ投入
- **Phase 7: テスト/品質（着手）**
  - ユニットテスト: `calculateFinalProbability` の境界/上限
  - フロー検証: `handleSubmissionAndLottery` の当日制限/勝ち/負け（DB・Queue モック）
- **Phase 8: 観測性・運用（着手）**
  - 構造化ロガー、リクエスト/エラー処理、`/metrics` と `/ready`
- **Phase 9: セキュリティ/設定（着手）**
  - 入力検証・Rate Limit・CORS 制限
- **Phase 10: デプロイ/起動（着手）**
  - `backend/env.example`, `frontend/env.example`
  - `backend/Dockerfile`, `frontend/Dockerfile`, `docker-compose.yml`
  - `.dockerignore`（backend/frontend）
  - `DEPLOYMENT.md`, `start-all-docker.bat`, `stop-all-docker.bat`

---

### 現在の進捗（概要）
- Backend: ログ/メトリクス・検証・RateLimit/CORS・デプロイ資材を追加
- Frontend: 初期 UI 実装済み（提出/結果表示）
- マイページ: 3カラム構成、リンク/お題/称号/提出物、タイムライン/提出者/ランキング、無限スクロール対応
- ヘッダー/ナビ: ログイン表示・ログアウト、LP/マイページ導線
- プロフィール: `/profile/view`（閲覧用）／`/profile`（設定）
- トピック: （アーカイブ機能は削除済み）
- トップ: `/` をトップに統一。ヘッダー左の「ToyBox」ロゴは `/` に遷移

### 本日の作業ログ（2025-10-02）
- 背景画像が表示されない問題の調査・修正
  - `frontend/src/app/page.tsx` と `frontend/src/app/home/page.tsx` の背景を `next/image` の `fill` 方式へ変更
  - セクションに最小高さ（`min-h`）を付与して確実に描画
  - 直参照 404 回避のため画像を静的インポートに切替（`import bgHero from '../../public/hero/background.png'`）
  - 画像は `frontend/public/hero/background.png`（本日支給の画像）
- Windows パスの `!` による webpack エラーを確認（`C:\\Users\\chama\\Desktop\\ToyBox!`）
  - 推奨: フォルダ名から `!` を除去、または安全なジャンクション `ToyBoxSafe` を作成

### 次アクション（明日ここから再開）
1. 観測性の拡張（/metrics 強化）
   - 追加カウンタ: `feed_served_total`, `profile_view_total`
   - 編集候補: `backend/src/utils/metrics.ts`、`backend/src/api/mypage.ts`、`backend/src/server.ts`
2. API最適化（total/インデックス）
   - `GET /api/feed` / `GET /api/user/submissions/:anonId` に `total` を追加
   - インデックス追加検討: `Submission.createdAt` 降順、必要に応じて複合
3. レスポンシブ/アクセシビリティ微調整
   - 1カラム時の余白/順序、フォーカスリング/aria
4. ホームページ強化（任意）
   - `frontend/src/app/home/page.tsx` のヒーロー/導線を調整
5. 背景画像の最終確認（フォルダ名変更後）
   - フォルダ名を `ToyBox` へ変更、または `ToyBoxSafe` 経由
   - フロント再起動と `.next` クリア後、`http://localhost:3000/home` で表示とネットワーク 200 を確認

メモ: 画像アップロードはモック段階のため後回しでOK

---

### マイページ UI 実装工程（新規）
Pixiv 風レイアウトの「マイページ」を段階的に構築する。添付モックを参考に以下の領域で構成する。

#### 画面セクション
- ヘッダー／ナビ（将来のログイン導線・設定を想定）
- サイドバー（外部リンク）: Discord / AIサイト / 会社LP など
- メインコンテンツ
  - 本日の課題（トピック）
  - タイムライン（コミュニティFeed）
  - ニュース提出者一覧（当日）
  - デイリーランキング
  - 注目ギャラリー（“光るフレーム”を重畳）
  - 自分の提出物一覧（直近）

#### Backend 追加タスク
1) API 設計/実装（既存モデルの拡張中心）
  - GET `/api/topic/work` お仕事系のお題
  - GET `/api/topic/play` ゲームのお題
   - GET `/api/feed?cursor=...` 提出の降順フィード（`Submission` の createdAt でページング）
   - GET `/api/submissions/me?limit=...` 自分の提出(anonId)の最新 N 件
   - GET `/api/ranking/daily?date=YYYY-MM-DD` 当日のいいね数等でランキング（暫定は提出数/乱数で疑似）
   - GET `/api/submitters/today` 当日の提出者一覧（anonId のみ）
  - GET `/api/user/profile/:anonId` 公開プロフィール（avatar/header/bio/displayName/activeTitle）
  - GET `/api/user/submissions/:anonId` 指定ユーザーの提出一覧（ページング）
  - （`/api/topics` は削除済み）
   - 補助: GET `/api/links`（サイドバーリンクを返す）※当面はフロント固定でも可
2) モデル/インデックス
   - `Submission` に index: `{ createdAt: -1 }`、当日範囲検索用の複合 index を検討
   - ランキング指標が増えた場合のフィールド（likes/views 等）は後続で拡張
3) セキュリティ/制限
   - 既存の `requireAnonAuth` と `rateLimitByAnonOrIp` を API 群へ適用
   - CORS は `CORS_ORIGINS` により許可

#### Frontend 追加タスク（Next.js 14 / Tailwind）
1) ルーティング/レイアウト
   - `app/login/page.tsx` ログイン（匿名IDの設定/保存）
   - `app/mypage/page.tsx` マイページ（3カラム・中央広め）
   - まずは1ファイルにまとめてセクション実装（後続で分割）
   - `app/user/[anonId]/page.tsx` プロフィール
- （`app/topics/page.tsx` は削除済み）
   - `app/home/page.tsx` トップページ（実装済み）
2) 取得/状態
   - ログイン状態: localStorage に `anonId` を保存/参照
   - `NEXT_PUBLIC_API_BASE` を使用し `fetch` で API 連携（SWR は任意）
   - ローディング/エラー/空表示の 3 状態を実装
   - PC/モバイルのレスポンシブ対応（2/3 カラム -> 1 カラム）
3) スタイル/UX
   - Tailwind トークン（steam.*）を活用し配色統一
   - ギャラリーの “光るフレーム” は CSS レイヤーで表現
   - アクセシビリティ（aria/コントラスト/フォーカス）
4) 既存フォーム連携
   - `SubmitForm` をショートカット導線として配置（モーダル or 別ページ遷移は後続）

5) 画像フォルダ
   - `frontend/public/uploads/` を作成
   - サンプル画像: `sample_1.svg`, `sample_2.svg`, `sample_3.svg`

#### 検証/品質
- API ユニットテスト: `/api/feed` 範囲・ページング、`/api/submissions/me` の anonId フィルタ
- UI スナップショット/インタラクション（軽量で良い）
- パフォーマンス: Feed/Gallery はページング+lazy load、画像は後続最適化
  - タイムライン無限スクロールのカーソル継続を確認

---

### 起動・確認ショートカット（明日の動作確認）
```powershell
cd toybox-app
docker compose up -d    # すべて起動
docker compose ps       # 状態確認

# 確認URL
# Backend: http://localhost:4000/health, /metrics
# Frontend: http://localhost:3000/, /mypage, /profile, /profile/view
```

#### デリバリー順（推奨）
1. Backend: `/api/submissions/me`, `/api/feed`（最低限）
2. Frontend: `app/mypage/page.tsx` と `Sidebar/TodayTopic/MySubmissions`
3. Backend: `/api/topic/today`, `/api/submitters/today`, `/api/ranking/daily`
4. Frontend: `Timeline/DailyRanking/Gallery` を段階追加

#### 受け入れ基準（Definition of Done）
- `http://localhost:3000/mypage` でモック相当の各セクションが表示される
- API レスポンスが 200 で最小データを返却し、UI がローディング/空/正常を表現
- 主要ブラウザ（Chromium/Edge）でレイアウトが崩れない

#### リスク/メモ
- ランキング指標（likes 等）は将来要件。暫定は提出数/乱数で占位
- 画像アセットはダミーで開始し、後続で最適化/CDN 方針を決める

### ルール/規約（簡易）
- **ブランチ運用**: `main` 安定 / `feature/*` 機能単位
- **コードスタイル**: TypeScript 厳格、意味のある命名、早期 return
- **コミット**: 小さく一貫性ある単位で、英語ベースの要約

### 依存関係のインストール（必要になった段階で）
```powershell
# backend
cd toybox-app\backend
npm i

# frontend
cd ..\frontend
npm i
```

### 実行（ローカル）
```powershell
# backend 開発モード
cd toybox-app\backend
npm run dev

# frontend 開発モード
cd ..\frontend
npm run dev
```

### 参考
- 仕様の詳細: `doc/toybox仕様.md`
- セットアップと概要: 必要に応じて `toybox-app/README.md` を再生成

---

### 開発モード起動手順（ローカル開発）

#### 前提
- Node.js 20 以上（フロント/バックエンドのローカル起動時）
- Docker / Docker Compose（DB・Redis と Docker 経由の起動に使用）
- Windows では PowerShell を使用（本リポジトリは `!` を含むパスだと一部ツールが不安定になる可能性あり。可能なら `ToyBox` へリネームまたはジャンクション経由を推奨）

#### 1) 依存関係のインストール（初回のみ）
```powershell
# backend
cd toybox-app\backend
npm i

# frontend
cd ..\frontend
npm i
```

#### 2) 環境変数の確認
- バックエンド: `toybox-app/backend/env.example` を参照して `.env` を必要に応じて作成
  - 既定値: `PORT=4000`, `MONGODB_URI=mongodb://mongo:27017/toybox`, `REDIS_URL=redis://redis:6379`, `CORS_ORIGINS=http://localhost:3000`
- フロントエンド: `toybox-app/frontend/env.example` を参照（`NEXT_PUBLIC_API_BASE=http://localhost:4000`）

#### 3) Docker（Mongo/Redis/Backend/Frontend 全体）で開発起動
```powershell
cd toybox-app
.\n+start-all-docker.bat          # すべてDockerで起動（初回は build 付きで: "start-all-docker.bat build"）
```
- 確認URL
  - Backend: `http://localhost:4000/health`, `http://localhost:4000/metrics`
  - Frontend: `http://localhost:3000/`、`/mypage`、`/topics`
- 終了:
```powershell
cd toybox-app
.\n+stop-all-docker.bat
```

補足:
- フロントをホットリロードで素早く立ち上げたい場合は `start-frontend-dev.bat` を使用可能（Docker の `frontend` サービスのみ dev 起動）
  - 内部で `docker-compose.yml` + `docker-compose.dev.yml` を読み込み、`frontend` を Node 公式イメージ上で `npm run dev` します

#### 4) ローカル Node で個別起動（Docker 併用/不使用の両方に対応）
バックエンド・フロントエンドをホスト上の Node で動かす場合:
```powershell
# backend（別ターミナル）
cd toybox-app\backend
npm run dev          # tsx watch src/server.ts で 4000 番ポート

# frontend（別ターミナル）
cd toybox-app\frontend
npm run dev          # Next.js dev サーバ 3000 番
```
- その場合、Mongo/Redis を Docker で起動するなら:
```powershell
cd toybox-app
docker compose up -d mongo redis
```
- バックエンドの `.env` で `MONGODB_URI`/`REDIS_URL` が上記に向くようにしておくこと

#### 5) トラブルシュート
- フォルダ名に `!` が含まれているとビルド/ウォッチが不安定になる場合がある
  - 対処: プロジェクトフォルダ名を `ToyBox` に変更、またはジャンクションを作成
- ポート競合: 3000/4000 が使用中の場合は停止するかポートを変更
- 初回 Docker 起動で依存が不足する場合は `start-all-docker.bat build` を実行

---