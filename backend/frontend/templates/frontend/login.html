{% extends 'frontend/base.html' %}
{% load static %}

{% block title %}ToyBox - ログイン{% endblock %}

{% block extra_css %}
<style>
    .login-container {
        max-width: 400px;
        margin: 4rem auto;
        padding: 2rem;
        background: var(--steam-iron-900);
        border-radius: 8px;
        border: 1px solid var(--steam-iron-700);
    }
    
    .login-container h1 {
        font-size: 1.5rem;
        color: var(--steam-gold-300);
        margin-bottom: 1.5rem;
        text-align: center;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--steam-gold-300);
        font-size: 0.875rem;
    }
    
    .error {
        color: #dc2626;
        margin-top: 0.5rem;
        font-size: 0.875rem;
        padding: 0.5rem;
        border-radius: 4px;
        background: rgba(220, 38, 38, 0.1);
        border: 1px solid rgba(220, 38, 38, 0.3);
    }
    
    .success {
        color: #16a34a;
        margin-top: 0.5rem;
        font-size: 0.875rem;
        padding: 0.5rem;
        border-radius: 4px;
        background: rgba(22, 163, 74, 0.1);
        border: 1px solid rgba(22, 163, 74, 0.3);
    }
    
    .back-link {
        text-align: center;
        margin-top: 1rem;
    }
    
    .back-link a {
        color: var(--steam-iron-400);
        text-decoration: none;
    }
    
    .back-link a:hover {
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block content %}
<div class="login-container">
    <h1>ToyBox</h1>
    <form id="loginForm">
        <div class="form-group">
            <label for="display_id">ID</label>
            <input type="text" id="display_id" name="display_id" required autocomplete="username">
        </div>
        <div class="form-group">
            <label for="password">パスワード</label>
            <input type="password" id="password" name="password" required autocomplete="current-password">
        </div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="success" class="success" style="display: none;"></div>
        <button type="submit" class="btn btn-primary" id="submitBtn" style="width: 100%; padding: 0.75rem;">ログイン</button>
    </form>
    <div class="back-link">
        <a href="/">トップページに戻る</a>
    </div>
</div>

<script>
    // ページ読み込み時に認証チェック
    document.addEventListener('DOMContentLoaded', function() {
        redirectIfAuthenticated();
    });
    
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const displayId = document.getElementById('display_id').value;
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('error');
        const successDiv = document.getElementById('success');
        const submitBtn = document.getElementById('submitBtn');
        
        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';
        submitBtn.disabled = true;
        submitBtn.textContent = 'ログイン中...';
        
        try {
            const response = await fetch('/api/auth/login/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    display_id: displayId,
                    password: password
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.access) {
                setAccessToken(data.access);
                if (data.refresh) {
                    setRefreshToken(data.refresh);
                }
                successDiv.textContent = 'ログイン成功！マイページへ移動します...';
                successDiv.style.display = 'block';
                setTimeout(() => {
                    // ログイン後は直接マイページにリダイレクト
                    window.location.href = '/me/';
                }, 1000);
            } else {
                errorDiv.textContent = data.detail || data.non_field_errors?.[0] || 'ログインに失敗しました';
                errorDiv.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'ログイン';
            }
        } catch (err) {
            errorDiv.textContent = 'エラーが発生しました';
            errorDiv.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = 'ログイン';
        }
    });
</script>
{% endblock %}

