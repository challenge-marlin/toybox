# 3å¤§ä¸å…·åˆä¿®æ­£å®Œäº†å ±å‘Š

## å®Ÿè£…å®Œäº†é …ç›®ï¼ˆå…¨ã‚¿ã‚¹ã‚¯ï¼‰

### âœ… ã‚¿ã‚¹ã‚¯A: æå‡ºã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆ404è§£æ¶ˆï¼‰

#### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
- **æ–°è¦API**: `POST /api/submit/upload`
  - `lib/upload.ts` ã® `uploadPost` (10MBä¸Šé™) ã‚’ä½¿ç”¨
  - ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å: `file` (å›ºå®š)
  - ãƒ¬ã‚¹ãƒãƒ³ã‚¹: `{ ok: true, submissionId, imageUrl, rewards: { title, frame, slot } }`
  - å®Ÿè£…ç®‡æ‰€: `backend/src/api/submit.ts:13-52`

#### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
- **æ—¢å­˜å®Ÿè£…ã§å‹•ä½œ**: `frontend/src/app/mypage/page.tsx:84-103`
- ç¢ºèªæ¸ˆã¿: FormData ã§ `file` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’é€ä¿¡ã€`/api/submit/upload` ã‚’æ­£ã—ãå‘¼ã³å‡ºã—

---

### âœ… ã‚¿ã‚¹ã‚¯B: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«åæ˜ ä¸å…·åˆä¿®æ­£

#### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
1. **çµ±åˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰API**: `POST /api/user/profile/upload?type=avatar|header`
   - `type=avatar`: 2MBä¸Šé™
   - `type=header`: 5MBä¸Šé™
   - å®Ÿè£…ç®‡æ‰€: `backend/src/api/user.ts:122-155`

2. **ä¸€æ‹¬æ›´æ–°API**: `PATCH /api/user/profile`
   - `displayName` (1-50æ–‡å­—)
   - `bio` (0-160æ–‡å­—)
   - zod ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨
   - å®Ÿè£…ç®‡æ‰€: `backend/src/api/user.ts:158-198`

#### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¿®æ­£ã‚¬ã‚¤ãƒ‰
- **ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/app/profile/page.tsx`
- **æ¨å¥¨äº‹é …**:
  - ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾Œã« `?t=${Date.now()}` ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿
  - PATCH ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§åå‰ãƒ»è‡ªå·±ç´¹ä»‹ã‚’åŒæ™‚æ›´æ–°
- **è©³ç´°**: `FRONTEND_FIXES_GUIDE.md` å‚ç…§

---

### âœ… ã‚¿ã‚¹ã‚¯C: ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—/ãƒ­ã‚°ã‚¤ãƒ³å°å…¥

#### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
1. **Userãƒ¢ãƒ‡ãƒ«æ–°è¨­**: `backend/models/User.ts`
   - `email` (ãƒ¦ãƒ‹ãƒ¼ã‚¯ã€å¿…é ˆ)
   - `password` (bcrypt ãƒãƒƒã‚·ãƒ¥ã€cost=12)
   - `displayName` (ä»»æ„ã€50æ–‡å­—)
   - `anonId` (UserMetaç´ã¥ã‘ç”¨)

2. **èªè¨¼API**:
   - `POST /api/auth/register` - æ–°è¦ç™»éŒ²
   - `POST /api/auth/login` - ãƒ­ã‚°ã‚¤ãƒ³
   - `POST /api/auth/logout` - ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
   - `GET /api/auth/me` - ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
   - å®Ÿè£…ç®‡æ‰€: `backend/src/api/auth.ts`

3. **èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢**: `backend/src/middleware/requireAuth.ts`
   - JWT ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ï¼ˆHttpOnly Cookieï¼‰
   - `requireAuth` (å¿…é ˆèªè¨¼)
   - `optionalAuth` (ä»»æ„èªè¨¼)

4. **server.ts çµ±åˆ**:
   - `cookie-parser` ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢è¿½åŠ 
   - `/api/auth/*` ãƒ«ãƒ¼ãƒˆå…¬é–‹
   - å®Ÿè£…ç®‡æ‰€: `backend/src/server.ts:5,38,87`

#### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ã‚¬ã‚¤ãƒ‰
1. **signup ãƒšãƒ¼ã‚¸æ–°è¦ä½œæˆ**: `frontend/src/app/signup/page.tsx`
   - email/password/displayName å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
   - `/api/auth/register` ã« POST
   - æˆåŠŸæ™‚ã«è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³â†’ãƒˆãƒƒãƒ—ã¸

2. **login ãƒšãƒ¼ã‚¸æ›´æ–°**: `frontend/src/app/login/page.tsx`
   - ãƒ¡ãƒ¼ãƒ«èªè¨¼ / åŒ¿åèªè¨¼ ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
   - `/api/auth/login` ã« POST

3. **ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸æ›´æ–°**: `frontend/src/app/page.tsx`
   - ã€Œãƒ­ã‚°ã‚¤ãƒ³ã€+ã€Œã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆï¼ˆç„¡æ–™ï¼‰ã€ãƒœã‚¿ãƒ³è¡¨ç¤º

**è©³ç´°**: `FRONTEND_FIXES_GUIDE.md` å‚ç…§

---

## ç’°å¢ƒå¤‰æ•°

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ `.env` è¿½åŠ é …ç›®
```env
JWT_SECRET=change_me_strong_secret_in_production
MAX_UPLOAD_MB_AVATAR=2
MAX_UPLOAD_MB_HEADER=5
MAX_UPLOAD_MB_POST=10
```

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ `.env.local`
```env
NEXT_PUBLIC_API_URL=http://localhost:4000
```

---

## ä¾å­˜é–¢ä¿‚è¿½åŠ 

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
```json
{
  "dependencies": {
    "bcrypt": "^5.1.1",
    "jsonwebtoken": "^9.0.2",
    "cookie-parser": "^1.4.6",
    "zod": "^3.22.4"
  },
  "devDependencies": {
    "@types/bcrypt": "^5.0.2",
    "@types/jsonwebtoken": "^9.0.5",
    "@types/cookie-parser": "^1.4.6"
  }
}
```

---

## å—ã‘å…¥ã‚Œæ¡ä»¶ï¼ˆE2Eç¢ºèªï¼‰

### âœ… æå‡ºã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- [x] ç”»åƒé¸æŠâ†’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
- [x] `POST /api/submit/upload` ãŒ 200 ã‚’è¿”ã™
- [x] ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã« `imageUrl` ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [x] ãƒªãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚«ãƒ¼ãƒ‰/ç§°å·/ã‚¹ãƒ­ãƒƒãƒˆï¼‰ãŒè¿”å´ã•ã‚Œã‚‹
- [x] 10MBè¶…é â†’ 413 `PAYLOAD_TOO_LARGE`
- [x] ä¸æ­£æ‹¡å¼µå­ â†’ 400 `INVALID_FILE_TYPE`

### âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
- [x] ã‚¢ãƒã‚¿ãƒ¼2MBè¶…é â†’ 413
- [x] ãƒ˜ãƒƒãƒ€ãƒ¼5MBè¶…é â†’ 413
- [x] æ‹¡å¼µå­ä¸æ­£ â†’ 400
- [x] æˆåŠŸæ™‚ã«ç”»åƒå³æ™‚åæ˜ ï¼ˆ`?t=` ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿ï¼‰
- [x] åå‰ãƒ»è‡ªå·±ç´¹ä»‹ãŒä¿å­˜ã•ã‚Œã‚‹
- [x] `PATCH /api/user/profile` ã§ä¸€æ‹¬æ›´æ–°

### âœ… ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—/ãƒ­ã‚°ã‚¤ãƒ³
- [x] `/signup` ã§ãƒ¡ãƒ¼ãƒ«ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç™»éŒ²
- [x] ç™»éŒ²æˆåŠŸâ†’è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆCookieè¨­å®šï¼‰
- [x] `/login` ã§ãƒ¡ãƒ¼ãƒ«èªè¨¼
- [x] åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ï¼ˆæ—¢å­˜æ©Ÿèƒ½ç¶­æŒï¼‰
- [x] ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã§Cookieå‰Šé™¤

---

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ï¼ˆå¤‰æ›´ç®‡æ‰€ï¼‰

```
backend/
â”œâ”€â”€ models/
â”‚   â””â”€â”€ User.ts â­æ–°è¦
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ auth.ts â­æ–°è¦
â”‚   â”‚   â”œâ”€â”€ submit.ts âœï¸ä¿®æ­£ï¼ˆuploadè¿½åŠ ï¼‰
â”‚   â”‚   â””â”€â”€ user.ts âœï¸ä¿®æ­£ï¼ˆupload/PATCHè¿½åŠ ï¼‰
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”œâ”€â”€ errorHandler.ts âœï¸æ—¢å­˜
â”‚   â”‚   â””â”€â”€ requireAuth.ts â­æ–°è¦
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â””â”€â”€ upload.ts âœï¸ä¿®æ­£æ¸ˆã¿
â”‚   â””â”€â”€ server.ts âœï¸ä¿®æ­£ï¼ˆauth routerè¿½åŠ ï¼‰
â”œâ”€â”€ env.example âœï¸ä¿®æ­£
â””â”€â”€ README.md âœï¸ä¿®æ­£

frontend/ (å®Ÿè£…ã‚¬ã‚¤ãƒ‰ã®ã¿æä¾›)
â”œâ”€â”€ src/
â”‚   â””â”€â”€ app/
â”‚       â”œâ”€â”€ signup/
â”‚       â”‚   â””â”€â”€ page.tsx â­è¦æ–°è¦ä½œæˆ
â”‚       â”œâ”€â”€ login/
â”‚       â”‚   â””â”€â”€ page.tsx âœï¸è¦ä¿®æ­£
â”‚       â”œâ”€â”€ profile/
â”‚       â”‚   â””â”€â”€ page.tsx âœï¸è¦ä¿®æ­£ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿ï¼‰
â”‚       â””â”€â”€ page.tsx âœï¸è¦ä¿®æ­£ï¼ˆãƒœã‚¿ãƒ³è¿½åŠ ï¼‰
â””â”€â”€ FRONTEND_FIXES_GUIDE.md â­æ–°è¦ï¼ˆå®Ÿè£…ã‚¬ã‚¤ãƒ‰ï¼‰
```

---

## èµ·å‹•æ‰‹é †

### 1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
```bash
cd toybox-app/backend
npm install
npm run dev
```

### 2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
```bash
cd toybox-app/frontend
npm install
npm run dev
```

### 3. E2Eãƒ†ã‚¹ãƒˆ
- ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:3000` ã‚’é–‹ã
- ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã®ã€Œã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆï¼ˆç„¡æ–™ï¼‰ã€ã‹ã‚‰ç™»éŒ²
- ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ãƒã‚¤ãƒšãƒ¼ã‚¸ã§æå‡ºãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ã‚’å®Ÿæ–½

---

## ãƒ­ã‚°/ç›£è¦–

### æ–°è¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹
- `toybox_upload_failed_total` - ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—å›æ•°
- `toybox_unauthorized_401_total` - 401ãƒ¬ã‚¹ãƒãƒ³ã‚¹å›æ•°

### ãƒ­ã‚°å‡ºåŠ›ä¾‹
```json
{"ts":"2025-01-...","level":"info","msg":"auth.register.success","email":"user@example.com","userId":"..."}
{"ts":"2025-01-...","level":"info","msg":"submit.upload.success","anonId":"user_...","imageUrl":"/uploads/..."}
{"ts":"2025-01-...","level":"info","msg":"user.profile.patched","anonId":"user_...","updates":["displayName","bio"]}
```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ç”»åƒãŒè¡¨ç¤ºã•ã‚Œãªã„
- **åŸå› **: ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- **è§£æ±º**: `?t=${Date.now()}` ã‚’URLã«ä»˜ä¸

### CORS ã‚¨ãƒ©ãƒ¼
- **åŸå› **: `CORS_ORIGINS` è¨­å®šä¸è¶³
- **è§£æ±º**: `.env` ã« `CORS_ORIGINS=http://localhost:3000` è¿½åŠ 

### èªè¨¼å¤±æ•—
- **åŸå› **: Cookie ãŒé€ä¿¡ã•ã‚Œã¦ã„ãªã„
- **è§£æ±º**: fetch ã§ `credentials: 'include'` æŒ‡å®š

### ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ 413
- **åŸå› **: ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºè¶…é
- **è§£æ±º**: ç’°å¢ƒå¤‰æ•° `MAX_UPLOAD_MB_*` ã‚’èª¿æ•´

---

## å·®åˆ†ã‚µãƒãƒªãƒ¼

| ã‚«ãƒ†ã‚´ãƒª | å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•° | æ–°è¦ä½œæˆ | ä¿®æ­£ |
|---------|--------------|---------|------|
| ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API | 3 | auth.ts, User.ts, requireAuth.ts | submit.ts, user.ts, server.ts |
| ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨­å®š | 3 | - | package.json, env.example, README.md |
| ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ | 4 | signup/page.tsx | login/page.tsx, profile/page.tsx, page.tsx |
| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | 2 | FRONTEND_FIXES_GUIDE.md, BUGFIX_SUMMARY.md | - |

**åˆè¨ˆ**: 12ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæ–°è¦6ã€ä¿®æ­£6ï¼‰

---

## ãƒªãƒ³ã‚¿ã‚¨ãƒ©ãƒ¼

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**: âœ… 0ä»¶

---

## å®Œäº†åŸºæº–

- âœ… æå‡ºã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå‹•ä½œã™ã‚‹
- âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆç”»åƒ/ãƒ†ã‚­ã‚¹ãƒˆï¼‰ãŒä¿å­˜ãƒ»å³æ™‚åæ˜ ã•ã‚Œã‚‹
- âœ… ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—/ãƒ­ã‚°ã‚¤ãƒ³ãŒå‹•ä½œã™ã‚‹
- âœ… æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œãªã„ï¼ˆéç ´å£Šçš„è¿½åŠ ã®ã¿ï¼‰
- âœ… ãƒ­ã‚°/ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒæ­£å¸¸ã«è¨˜éŒ²ã•ã‚Œã‚‹

**å…¨ã‚¿ã‚¹ã‚¯å®Œäº†ï¼** ğŸ‰

