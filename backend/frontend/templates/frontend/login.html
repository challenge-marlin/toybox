{% extends 'frontend/base.html' %}
{% load static %}

{% block title %}ToyBox - „É≠„Ç∞„Ç§„É≥{% endblock %}

{% block extra_css %}
<style>
    .login-container {
        max-width: 400px;
        margin: 4rem auto;
        padding: 2rem;
        background: var(--steam-iron-900);
        border-radius: 8px;
        border: 1px solid var(--steam-iron-700);
    }
    
    .login-container h1 {
        font-size: 1.5rem;
        color: var(--steam-gold-300);
        margin-bottom: 1.5rem;
        text-align: center;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--steam-gold-300);
        font-size: 0.875rem;
    }
    
    .error {
        color: #dc2626;
        margin-top: 0.5rem;
        font-size: 0.875rem;
        padding: 0.5rem;
        border-radius: 4px;
        background: rgba(220, 38, 38, 0.1);
        border: 1px solid rgba(220, 38, 38, 0.3);
    }
    
    .success {
        color: #16a34a;
        margin-top: 0.5rem;
        font-size: 0.875rem;
        padding: 0.5rem;
        border-radius: 4px;
        background: rgba(22, 163, 74, 0.1);
        border: 1px solid rgba(22, 163, 74, 0.3);
    }
    
    .back-link {
        text-align: center;
        margin-top: 1rem;
    }
    
    .back-link a {
        color: var(--steam-iron-400);
        text-decoration: none;
    }
    
    .back-link a:hover {
        text-decoration: underline;
    }
    
    .penalty-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    
    .penalty-modal.show {
        display: flex;
    }
    
    .penalty-modal-content {
        background: var(--steam-iron-900);
        border: 2px solid var(--steam-gold-300);
        border-radius: 8px;
        padding: 2rem;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    .penalty-modal-header {
        color: var(--steam-gold-300);
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .penalty-modal-header.warning {
        color: #fbbf24;
    }
    
    .penalty-modal-header.suspend {
        color: #f59e0b;
    }
    
    .penalty-modal-header.ban {
        color: #dc2626;
    }
    
    .penalty-modal-body {
        color: var(--steam-iron-100);
        font-size: 1rem;
        line-height: 1.8;
        white-space: pre-wrap;
        margin-bottom: 1.5rem;
    }
    
    .penalty-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }
    
    .penalty-modal-button {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        transition: opacity 0.2s;
    }
    
    .penalty-modal-button:hover {
        opacity: 0.9;
    }
    
    .penalty-modal-button-primary {
        background: var(--steam-gold-500);
        color: #000;
    }
</style>
{% endblock %}

{% block content %}
<div class="login-container">
    <h1>ToyBox</h1>
    <form id="loginForm">
        <div class="form-group">
            <label for="display_id">ID</label>
            <input type="text" id="display_id" name="display_id" required autocomplete="username">
        </div>
        <div class="form-group">
            <label for="password">„Éë„Çπ„ÉØ„Éº„Éâ</label>
            <input type="password" id="password" name="password" required autocomplete="current-password">
        </div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="success" class="success" style="display: none;"></div>
        <button type="submit" class="btn btn-primary" id="submitBtn" style="width: 100%; padding: 0.75rem;">„É≠„Ç∞„Ç§„É≥</button>
    </form>
    <div class="back-link">
        <a href="/">„Éà„ÉÉ„Éó„Éö„Éº„Ç∏„Å´Êàª„Çã</a>
    </div>
</div>

<!-- Ë≠¶Âëä„É°„ÉÉ„Çª„Éº„Ç∏„É¢„Éº„ÉÄ„É´ -->
<div id="penaltyModal" class="penalty-modal">
    <div class="penalty-modal-content">
        <div id="penaltyModalHeader" class="penalty-modal-header"></div>
        <div id="penaltyModalBody" class="penalty-modal-body"></div>
        <div class="penalty-modal-footer">
            <button id="penaltyModalClose" class="penalty-modal-button penalty-modal-button-primary">‰∫ÜËß£„Åó„Åæ„Åó„Åü</button>
        </div>
    </div>
</div>

<script>
    // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´Ë™çË®º„ÉÅ„Çß„ÉÉ„ÇØ
    document.addEventListener('DOMContentLoaded', function() {
        redirectIfAuthenticated();
    });
    
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const displayId = document.getElementById('display_id').value;
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('error');
        const successDiv = document.getElementById('success');
        const submitBtn = document.getElementById('submitBtn');
        
        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';
        submitBtn.disabled = true;
        submitBtn.textContent = '„É≠„Ç∞„Ç§„É≥‰∏≠...';
        
        try {
            const response = await fetch('/api/auth/login/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    display_id: displayId,
                    password: password
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.access) {
                setAccessToken(data.access);
                if (data.refresh) {
                    setRefreshToken(data.refresh);
                }
                
                // Ë≠¶Âëä„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØË°®Á§∫
                if (data.penalty && data.penalty.message) {
                    showPenaltyModal(data.penalty.type, data.penalty.message);
                } else {
                    // „É≠„Éº„É´„Å´Âøú„Åò„Å¶„É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÂÖà„ÇíÊ±∫ÂÆö
                    const redirectUrl = (data.role === 'FREE_USER') ? '/upgrade/' : '/me/';
                    const redirectMessage = (data.role === 'FREE_USER') 
                        ? '„É≠„Ç∞„Ç§„É≥ÊàêÂäüÔºÅË™≤Èáë„Å´„Å§„ÅÑ„Å¶„ÅÆ„Éö„Éº„Ç∏„Å∏ÁßªÂãï„Åó„Åæ„Åô...' 
                        : '„É≠„Ç∞„Ç§„É≥ÊàêÂäüÔºÅ„Éû„Ç§„Éö„Éº„Ç∏„Å∏ÁßªÂãï„Åó„Åæ„Åô...';
                    
                    successDiv.textContent = redirectMessage;
                    successDiv.style.display = 'block';
                    setTimeout(() => {
                        window.location.href = redirectUrl;
                    }, 1000);
                }
            } else {
                errorDiv.textContent = data.detail || data.non_field_errors?.[0] || '„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
                errorDiv.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = '„É≠„Ç∞„Ç§„É≥';
            }
        } catch (err) {
            errorDiv.textContent = '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
            errorDiv.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = '„É≠„Ç∞„Ç§„É≥';
        }
    });
    
    function showPenaltyModal(type, message) {
        const modal = document.getElementById('penaltyModal');
        const header = document.getElementById('penaltyModalHeader');
        const body = document.getElementById('penaltyModalBody');
        const closeBtn = document.getElementById('penaltyModalClose');
        
        // „Çø„Ç§„Éó„Å´Âøú„Åò„Åü„Éò„ÉÉ„ÉÄ„Éº„ÇíË®≠ÂÆö
        let headerText = '';
        let headerClass = '';
        if (type === 'WARNING') {
            headerText = '‚ö†Ô∏è Ë≠¶Âëä';
            headerClass = 'warning';
        } else if (type === 'SUSPEND') {
            headerText = '‚õî „Ç¢„Ç´„Ç¶„É≥„ÉàÂÅúÊ≠¢';
            headerClass = 'suspend';
        } else if (type === 'BAN') {
            headerText = 'üö´ BANÔºà„Ç¢„Ç´„Ç¶„É≥„ÉàÂâäÈô§Ôºâ';
            headerClass = 'ban';
        } else {
            headerText = '‚ö†Ô∏è „ÅäÁü•„Çâ„Åõ';
            headerClass = 'warning';
        }
        
        header.textContent = headerText;
        header.className = 'penalty-modal-header ' + headerClass;
        body.textContent = message;
        
        modal.classList.add('show');
        
        // Èñâ„Åò„Çã„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà
        closeBtn.onclick = function() {
            modal.classList.remove('show');
            
            // „Çø„Ç§„Éó„Å´Âøú„Åò„Å¶Áï∞„Å™„ÇãÂá¶ÁêÜ
            if (type === 'WARNING') {
                // Ë≠¶Âëä„ÅÆÂ†¥Âêà„ÅØ„Éû„Ç§„Éö„Éº„Ç∏„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
                const successDiv = document.getElementById('success');
                successDiv.textContent = '„É≠„Ç∞„Ç§„É≥ÊàêÂäüÔºÅ„Éû„Ç§„Éö„Éº„Ç∏„Å∏ÁßªÂãï„Åó„Åæ„Åô...';
                successDiv.style.display = 'block';
                setTimeout(() => {
                    window.location.href = '/me/';
                }, 500);
            } else if (type === 'SUSPEND' || type === 'BAN') {
                // „Ç¢„Ç´„Ç¶„É≥„ÉàÂÅúÊ≠¢„Åæ„Åü„ÅØBAN„ÅÆÂ†¥Âêà„ÅØ„Éà„Éº„ÇØ„É≥„ÇíÂâäÈô§„Åó„Å¶„É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏„Å´Êàª„Çã
                clearAuth();
                const errorDiv = document.getElementById('error');
                if (type === 'SUSPEND') {
                    errorDiv.textContent = '„Ç¢„Ç´„Ç¶„É≥„Éà„ÅåÂÅúÊ≠¢„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏„Å´Êàª„Çä„Åæ„Åô„ÄÇ';
                } else {
                    errorDiv.textContent = '„Ç¢„Ç´„Ç¶„É≥„Éà„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„Åü„ÄÇ„É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏„Å´Êàª„Çä„Åæ„Åô„ÄÇ';
                }
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    window.location.href = '/login/';
                }, 2000);
            }
        };
        
        // „É¢„Éº„ÉÄ„É´Â§ñ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„ÇÇÈñâ„Åò„Å™„ÅÑÔºàÈáçË¶Å„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ„Åü„ÇÅÔºâ
    }
</script>
{% endblock %}

