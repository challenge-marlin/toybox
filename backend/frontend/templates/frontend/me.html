{% extends 'frontend/base.html' %}
{% load static %}

{% block title %}ToyBox - マイページ{% endblock %}

{% block extra_css %}
<style>
    .me-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem;
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    @media (min-width: 768px) {
        .me-container {
            grid-template-columns: 3fr 6fr 3fr;
        }
    }
    
    .me-section {
        border-radius: 8px;
        border: 1px solid var(--steam-iron-700);
        background: var(--steam-iron-900);
        padding: 0.75rem;
        margin-bottom: 1rem;
    }
    
    .me-section h2 {
        margin-bottom: 0.5rem;
        color: var(--steam-gold-300);
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    .profile-avatar {
        height: 200px;
        width: 200px;
        overflow: hidden;
        border-radius: 50%;
        border: 1px solid var(--steam-iron-700);
        background: var(--steam-iron-800);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        color: var(--steam-iron-400);
        margin: 0.5rem auto;
    }
    
    .profile-avatar img {
        height: 100%;
        width: 100%;
        object-fit: cover;
    }
    
    .submissions-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }
    
    @media (min-width: 768px) {
        .submissions-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }
    
    .submission-item {
        position: relative;
        border-radius: 8px;
        border: 1px solid var(--steam-iron-700);
        background: var(--steam-iron-900);
        aspect-ratio: 1;
        overflow: hidden;
    }
    
    .submission-item.game {
        border-color: #a855f7;
    }
    
    .submission-item.video {
        border-color: #0ea5e9;
    }
    
    .upload-area {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        border: 2px dashed var(--steam-iron-700);
        background: var(--steam-iron-900);
        padding: 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .upload-area.dragging {
        border-color: var(--steam-gold-500);
        background: rgba(31, 35, 42, 0.5);
    }
    
    .timeline-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--steam-iron-100);
        margin-bottom: 0.5rem;
    }
    
    .timeline-avatar {
        height: 1.5rem;
        width: 1.5rem;
        overflow: hidden;
        border-radius: 50%;
        border: 1px solid var(--steam-iron-700);
        background: var(--steam-iron-800);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--steam-iron-300);
        font-size: 0.625rem;
        flex-shrink: 0;
    }
    
    .timeline-avatar img {
        height: 100%;
        width: 100%;
        object-fit: cover;
    }
    
    .upload-overlay {
        position: fixed;
        inset: 0;
        z-index: 2000;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
    }
    
    .upload-overlay.show {
        display: flex;
    }
    
    .upload-overlay-content {
        border-radius: 8px;
        border: 1px solid var(--steam-iron-700);
        background: var(--steam-iron-900);
        color: var(--steam-gold-200);
        padding: 1.5rem 2rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
    }
    
    /* ライトボックス */
    #lightbox {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 9999;
        cursor: pointer;
        align-items: center;
        justify-content: center;
    }
    
    #lightbox.show {
        display: flex;
    }
    
    #lightbox-content {
        position: relative;
        max-width: 90vw;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }
    
    #lightbox-image,
    #lightbox-video {
        max-width: 90vw;
        max-height: 80vh;
        object-fit: contain;
        border-radius: 8px;
        cursor: default;
    }
    
    #lightbox-video {
        background: black;
    }
    
    #lightbox-close {
        position: absolute;
        top: -2.5rem;
        right: 0;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 0.5rem 1rem;
        font-size: 1rem;
        cursor: pointer;
    }
    
    #lightbox-close:hover {
        background: rgba(0, 0, 0, 0.8);
    }
    
    #lightbox-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    
    .discord-share-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: #5865F2;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .discord-share-btn:hover:not(:disabled) {
        background: #4752C4;
    }
    
    .discord-share-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="me-container">
    <!-- 左カラム -->
    <aside>
        <!-- プロフィール -->
        <section class="me-section">
            <h2>プロフィール</h2>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem; margin-top: 0.5rem;">
                <div class="profile-avatar" id="profile-avatar">
                    <span>未設定</span>
                </div>
                <div style="color: var(--steam-iron-100); font-weight: 600; font-size: 0.875rem;" id="profile-name">—</div>
                <div style="font-size: 0.75rem; line-height: 1.6; color: var(--steam-iron-200); text-align: center; padding: 0 0.25rem;">
                    <span id="profile-bio">—</span>
                    <span id="profile-bio-more" style="display: none; margin-top: 0.25rem;">
                        <a href="/profile/view/" style="color: var(--steam-gold-400); text-decoration: underline; font-size: 0.6875rem;">続きを見る</a>
                    </span>
                </div>
                <div style="font-size: 0.875rem; color: var(--steam-gold-300);" id="profile-title">称号: —</div>
                <div style="font-size: 0.75rem; color: var(--steam-iron-300);" id="profile-title-until"></div>
            </div>
        </section>
        
        <!-- Discord参加 -->
        <section class="me-section">
            <h2>Discord</h2>
            <a href="https://discord.gg/{{ DISCORD_INVITE_CODE|default:'' }}" target="_blank" rel="noreferrer" class="discord-join-btn" style="display: inline-flex; align-items: center; gap: 0.5rem; width: 100%; justify-content: center; background: #5865F2; color: white; border: none; border-radius: 8px; padding: 0.75rem 1rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; text-decoration: none; transition: background 0.2s; margin-top: 0.5rem;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                </svg>
                <span>Discord TOYBOXサーバーに参加する</span>
            </a>
        </section>
        
        <!-- お仕事系のお題 -->
        <section class="me-section">
            <h2>お仕事系のお題</h2>
            <div id="topic-work" style="color: var(--steam-iron-100); font-size: 0.875rem; display: none;"></div>
            <a href="https://ayatori-inc.co.jp/toybox-std/" target="_blank" rel="noreferrer" onclick="fetchTopic('work')" style="display: inline-block; margin-top: 0.75rem; border-radius: 4px; background: var(--steam-brown-500); padding: 0.5rem 1rem; color: white; text-decoration: none; font-size: 1rem;">お題を見る</a>
        </section>
        
        <!-- ゲームのお題 -->
        <section class="me-section">
            <h2>ゲームのお題</h2>
            <div id="topic-play" style="color: var(--steam-iron-100); font-size: 0.875rem; display: none;"></div>
            <a href="https://ayatori-inc.co.jp/toybox-game/" target="_blank" rel="noreferrer" onclick="fetchTopic('play')" style="display: inline-block; margin-top: 0.75rem; border-radius: 4px; background: var(--steam-brown-500); padding: 0.5rem 1rem; color: white; text-decoration: none; font-size: 1rem;">お題を見る</a>
        </section>
    </aside>
    
    <!-- 中央カラム -->
    <section>
        <!-- お知らせ表示エリア -->
        <div style="margin-bottom: 1.5rem;">
            <h2 style="color: var(--steam-gold-300); font-weight: 600; margin-bottom: 0.75rem; font-size: 1.25rem;">お知らせ</h2>
            <div id="announcements-container">
                <!-- お知らせがここに表示されます -->
            </div>
        </div>
        
        <div style="margin-bottom: 0.75rem; display: flex; align-items: center; justify-content: space-between;">
            <h2 style="color: var(--steam-gold-300); font-weight: 600;">自分の提出物</h2>
            <a href="/profile/" style="font-size: 0.75rem; color: var(--steam-gold-400); text-decoration: underline;">プロフィール設定</a>
        </div>
        <div class="submissions-grid" id="submissions-grid">
            <!-- 提出物がここに表示されます -->
        </div>
    </section>
    
    <!-- 右カラム -->
    <aside>
        <!-- 本日の課題提出 -->
        <section class="me-section">
            <h2>本日の課題提出</h2>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <input id="upload-input" type="file" accept="image/png,image/jpeg,video/mp4,video/webm,video/ogg" style="display: none;">
                <div id="upload-area" class="upload-area" onclick="document.getElementById('upload-input').click()">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="color: var(--steam-gold-400); margin-bottom: 0.5rem;">
                        <path d="M12 16V4" />
                        <path d="M8 8l4-4 4 4" />
                        <rect x="3" y="16" width="18" height="4" rx="1" ry="1" />
                    </svg>
                    <div style="font-size: 0.875rem; color: var(--steam-gold-200);">課題をアップロード（PNG/JPEG/MP4）</div>
                    <div style="font-size: 0.75rem; color: var(--steam-iron-300);">ここにドラッグ＆ドロップ、またはクリックして選択</div>
                    <div id="upload-status" style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--steam-iron-200); display: none;">アップロード中…</div>
                </div>
                <div id="upload-error" style="font-size: 0.75rem; color: #dc2626; display: none;"></div>
                <p style="font-size: 0.75rem; color: var(--steam-iron-300);">選んだ画像は「自分の提出物」に即時反映・ローカル保存されます。</p>
            </div>
        </section>
        
        <!-- ゲームZIPアップロード -->
        <section class="me-section">
            <h2>ゲームをアップロード（ZIP）</h2>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <input id="upload-game-input" type="file" accept=".zip,application/zip" style="display: none;">
                <div id="upload-game-area" class="upload-area" onclick="document.getElementById('upload-game-input').click()" style="border-color: #a855f7; cursor: pointer;">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="color: #a855f7; margin-bottom: 0.5rem;">
                        <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .69.28 1.32.73 1.77.45.45 1.08.73 1.77.73H21a2 2 0 1 1 0 4h-.09c-.69 0-1.32.28-1.77.73-.45.45-.73 1.08-.73 1.77z"/>
                    </svg>
                    <div style="font-size: 0.875rem; color: #a855f7; font-weight: 600;">ZIPファイルを選択</div>
                    <div style="font-size: 0.75rem; color: var(--steam-iron-300);">ゲームをアップロード</div>
                </div>
                <div id="upload-game-error" style="font-size: 0.75rem; color: #dc2626; display: none;"></div>
                <p style="font-size: 0.75rem; color: var(--steam-iron-300);">必ずindex.htmlを含む <strong style="color: var(--steam-gold-300);">Webブラウザでできるミニゲームで構成されたZIPファイル</strong> をアップロードするようにしてください。</p>
            </div>
        </section>
        
        <!-- タイムライン -->
        <section class="me-section">
            <h2>タイムライン</h2>
            <ul id="timeline-list" style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem; color: var(--steam-iron-100);">
                <li>データなし</li>
            </ul>
        </section>
        
        <!-- 提出者（当日） -->
        <section class="me-section">
            <h2>提出者（当日）</h2>
            <div style="font-size: 0.875rem; color: var(--steam-iron-100); margin-bottom: 0.5rem;" id="submitters-count">0名</div>
            <ul id="submitters-list" style="display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.75rem; color: var(--steam-iron-200); max-height: 10rem; overflow: auto;">
                <li>データなし</li>
            </ul>
        </section>
        
        <!-- デイリーランキング -->
        <section class="me-section">
            <h2>デイリーランキング</h2>
            <ol id="ranking-list" style="list-style: decimal; padding-left: 1.25rem; display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.875rem; color: var(--steam-iron-100);">
                <li>データなし</li>
            </ol>
        </section>
    </aside>
</div>

<!-- アップロード中オーバーレイ -->
<div id="upload-overlay" class="upload-overlay">
    <div class="upload-overlay-content">
        アップロード中…完了までお待ちください
    </div>
</div>

<!-- 報酬演出オーバーレイ -->
<div id="reward-overlay" class="upload-overlay" style="background: rgba(0, 0, 0, 0.6); z-index: 3000;">
    <div id="reward-content" style="border-radius: 8px; border: 1px solid var(--steam-iron-700); background: var(--steam-iron-800); color: var(--steam-gold-200); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); padding: 1.5rem; max-width: 600px; width: 90%;">
        <!-- カード演出 -->
        <div id="card-reveal" style="display: none; text-align: center;">
            <div style="color: var(--steam-gold-300); font-weight: 600; font-size: 1.25rem; margin-bottom: 0.5rem;" id="card-rarity">N 獲得！</div>
            <div style="position: relative; width: 280px; height: 400px; background: var(--steam-iron-800); overflow: hidden; border-radius: 8px; margin: 0 auto; perspective: 1000px;">
                <img id="card-image" src="" alt="card" style="position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; animation: cardSpinIn 0.6s ease-out;">
            </div>
            <div style="margin-top: 0.5rem; text-align: center; color: var(--steam-iron-100);" id="card-name">Card</div>
            <div style="text-align: center; margin-top: 0.75rem;">
                <button onclick="nextToTitle()" style="border-radius: 4px; background: var(--steam-brown-500); padding: 0.5rem 1rem; color: white; border: none; cursor: pointer; font-size: 1rem;">閉じる</button>
            </div>
        </div>
        
        <!-- 称号演出 -->
        <div id="title-reveal" style="display: none; text-align: center;">
            <div style="color: var(--steam-gold-300); font-weight: 600; font-size: 1.25rem; margin-bottom: 0.5rem;">称号を取得しました！</div>
            <div style="margin-top: 0.5rem; display: flex; justify-content: center;">
                <img src="{% static 'frontend/hero/toybox-title.png' %}" alt="title" style="height: 6rem; width: auto; opacity: 0.8;">
            </div>
            <div style="margin-top: 0.25rem; font-size: 1.5rem; font-weight: bold; color: var(--steam-gold-300);" id="title-name">—</div>
            <div style="margin-top: 1rem;">
                <button onclick="closeRewardFlow()" style="border-radius: 4px; background: var(--steam-brown-500); padding: 0.5rem 1rem; color: white; border: none; cursor: pointer; font-size: 1rem;">OK</button>
            </div>
        </div>
    </div>
</div>

<style>
@keyframes cardSpinIn {
    from {
        transform: rotateY(90deg);
        opacity: 0;
    }
    to {
        transform: rotateY(0deg);
        opacity: 1;
    }
}
</style>

<script>
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    const token = getAccessToken();
    
    // 認証チェック
    if (!requireAuth()) {
        // requireAuth()がfalseを返した場合、既にリダイレクトされている
        // ここで処理を停止
    }
    
    // 初期データ読み込み
    document.addEventListener('DOMContentLoaded', function() {
        // リダイレクトチェック中フラグをチェック（無限ループ防止）
        if (sessionStorage.getItem('toybox_role_checking') === '1') {
            sessionStorage.removeItem('toybox_role_checking');
            // チェック中の場合は通常の処理を続行
            initializePage();
            return;
        }
        
        // 強制リロードフラグをチェック
        try {
            const shouldReload = localStorage.getItem('toybox_me_force_reload') === '1';
            if (shouldReload) {
                localStorage.removeItem('toybox_me_force_reload');
                // ページをリロードして最新のプロフィール情報を取得
                window.location.reload();
                return;
            }
        } catch (e) {}
        
        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = '/login/';
            return;
        }
        
        // まず、ユーザーのロールを確認してリダイレクトが必要かチェック
        sessionStorage.setItem('toybox_role_checking', '1');
        fetch('/api/users/me/', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(res => {
            sessionStorage.removeItem('toybox_role_checking');
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }
            return res.json();
        })
        .then(userData => {
            console.log('User data:', userData);
            // ロールがFREE_USERの場合は問い合わせページにリダイレクト
            if (userData.role === 'FREE_USER') {
                console.log('User is FREE_USER, redirecting to /upgrade/');
                // リダイレクト前にフラグを設定して無限ループを防ぐ
                sessionStorage.setItem('toybox_redirecting_to_upgrade', '1');
                window.location.href = '/upgrade/';
                return;
            }
            // それ以外の場合は通常の処理を続行
            initializePage();
        })
        .catch(err => {
            sessionStorage.removeItem('toybox_role_checking');
            console.error('Error fetching user data:', err);
            // エラーが発生した場合は通常の処理を続行（サーバー側でリダイレクトされる可能性がある）
            initializePage();
        });
        
        function initializePage() {
            loadProfile();
            loadAnnouncements();
            loadSubmissions();
            loadTimeline();
            loadSubmitters();
            loadRanking();
            
            // アップロード機能
            setupUpload();
            setupGameUpload();
        }
    });
    
    function loadProfile() {
        // まず自分のanonIdを取得
        fetch('/api/users/me/meta/', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'X-CSRFToken': csrftoken
            }
        })
        .then(res => {
            if (!res.ok) {
                console.error('Failed to fetch user meta:', res.status, res.statusText);
                return null;
            }
            return res.json();
        })
        .then(metaData => {
            if (!metaData) {
                console.error('No metaData received');
                return;
            }
            
            console.log('User meta data received:', metaData);
            const anonId = metaData.display_id;
            if (!anonId) {
                console.error('No display_id found in metaData:', metaData);
                return;
            }
            
            // プロフィール情報を取得
            return fetch(`/api/user/profile/${encodeURIComponent(anonId)}/`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'X-CSRFToken': csrftoken
                }
            });
        })
        .then(res => {
            if (!res) return null;
            return res.json();
        })
        .then(data => {
            if (!data) return;
            
            console.log('Profile data received:', data);
            
            // ユーザー名を表示
            if (data.displayName) {
                document.getElementById('profile-name').textContent = data.displayName;
                console.log('Set profile name to:', data.displayName);
            } else if (data.anonId) {
                document.getElementById('profile-name').textContent = data.anonId;
                console.log('Set profile name to anonId:', data.anonId);
            }
            
            // プロフィール文を表示
            if (data.bio) {
                const bioElement = document.getElementById('profile-bio');
                const bioMoreElement = document.getElementById('profile-bio-more');
                const bio = data.bio;
                const isLong = bio.length > 100;
                const short = isLong ? bio.slice(0, 100) + '…' : bio;
                bioElement.textContent = short;
                console.log('Set profile bio to:', short);
                if (isLong && bioMoreElement) {
                    bioMoreElement.style.display = 'block';
                } else if (bioMoreElement) {
                    bioMoreElement.style.display = 'none';
                }
            } else {
                document.getElementById('profile-bio').textContent = '—';
                const bioMoreElement = document.getElementById('profile-bio-more');
                if (bioMoreElement) bioMoreElement.style.display = 'none';
                console.log('No bio data, set to —');
            }
            
            // アバター画像を表示
            const avatarDiv = document.getElementById('profile-avatar');
            if (data.avatarUrl) {
                avatarDiv.innerHTML = `<img src="${data.avatarUrl}" alt="avatar" style="height: 100%; width: 100%; object-fit: cover;">`;
            } else {
                avatarDiv.innerHTML = '<span>未設定</span>';
            }
            
            // 称号を表示（期限切れチェック）
            const titleElement = document.getElementById('profile-title');
            const titleUntilElement = document.getElementById('profile-title-until');
            
            if (data.activeTitle && data.activeTitleUntil) {
                const expiresAt = new Date(data.activeTitleUntil);
                const now = new Date();
                
                if (expiresAt > now) {
                    // 有効期限内
                    if (titleElement) {
                        titleElement.textContent = `称号: ${data.activeTitle}`;
                        titleElement.style.display = 'block';
                    }
                    if (titleUntilElement) {
                        titleUntilElement.textContent = `有効期限: ${expiresAt.toLocaleDateString()}`;
                        titleUntilElement.style.display = 'block';
                    }
                } else {
                    // 期限切れ
                    if (titleElement) {
                        titleElement.textContent = '称号: —';
                        titleElement.style.display = 'block';
                    }
                    if (titleUntilElement) {
                        titleUntilElement.textContent = '';
                        titleUntilElement.style.display = 'none';
                    }
                }
            } else if (data.activeTitle) {
                // expires_atがない場合は表示
                if (titleElement) {
                    titleElement.textContent = `称号: ${data.activeTitle}`;
                    titleElement.style.display = 'block';
                }
                if (titleUntilElement) {
                    titleUntilElement.textContent = '';
                    titleUntilElement.style.display = 'none';
                }
            } else {
                // 称号がない場合
                if (titleElement) {
                    titleElement.textContent = '称号: —';
                    titleElement.style.display = 'block';
                }
                if (titleUntilElement) {
                    titleUntilElement.textContent = '';
                    titleUntilElement.style.display = 'none';
                }
            }
        })
        .catch(err => console.error('Failed to load profile:', err));
    }
    
    function loadAnnouncements() {
        fetch('/api/announcements/', {
            headers: {
                'Authorization': `Bearer ${token}`,
            }
        })
        .then(res => {
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            const container = document.getElementById('announcements-container');
            if (!container) {
                console.error('Announcements container not found');
                return;
            }
            
            if (data.announcements && data.announcements.length > 0) {
                container.innerHTML = data.announcements.map(announcement => {
                    const date = new Date(announcement.created_at);
                    const dateStr = date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
                    return `
                        <div style="background: var(--steam-iron-800); border: 1px solid var(--steam-iron-600); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;">
                            <a href="/announcement/${announcement.id}/" style="display: flex; align-items: center; justify-content: space-between; text-decoration: none; color: inherit;">
                                <h3 style="color: var(--steam-gold-300); font-size: 1rem; font-weight: 600; margin: 0; text-decoration: underline;">${announcement.title}</h3>
                                <span style="font-size: 0.75rem; color: var(--steam-iron-300);">${dateStr}</span>
                            </a>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = '<div style="color: var(--steam-iron-300); font-size: 0.875rem; padding: 1rem; text-align: center;">お知らせはありません</div>';
            }
        })
        .catch(err => {
            console.error('Failed to load announcements:', err);
            const container = document.getElementById('announcements-container');
            if (container) {
                container.innerHTML = '';
            }
        });
    }
    
    function loadSubmissions() {
        // 自分のユーザーIDを取得
        fetch('/api/users/me/meta/', {
            headers: {
                'Authorization': `Bearer ${token}`,
            }
        })
        .then(res => res.json())
        .then(metaData => {
            if (!metaData.display_id) {
                document.getElementById('submissions-grid').innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--steam-iron-300);">提出物がありません</div>';
                return;
            }
            
            // 自分の提出物を取得
            return fetch(`/api/user/submissions/${encodeURIComponent(metaData.display_id)}/?limit=12`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                }
            });
        })
        .then(res => {
            if (!res) return;
            return res.json();
        })
        .then(data => {
            if (!data) return;
            const grid = document.getElementById('submissions-grid');
            if (data.items && data.items.length > 0) {
                // ゲーム名を取得する関数
                function getGameName(item) {
                    // captionフィールドがあればそれを使用
                    if (item.caption && item.caption.trim()) {
                        return item.caption.trim();
                    }
                    // ゲームURLから推測（例: /media/games/ayatori/1763521258/tetris/index.html）
                    if (item.gameUrl) {
                        const urlParts = item.gameUrl.split('/');
                        const gameNameIndex = urlParts.findIndex(part => part === 'games');
                        if (gameNameIndex >= 0 && gameNameIndex + 2 < urlParts.length) {
                            const potentialName = urlParts[gameNameIndex + 2];
                            if (potentialName && potentialName !== 'index.html') {
                                return potentialName;
                            }
                        }
                    }
                    return 'GAME';
                }
                
                grid.innerHTML = data.items.map(item => {
                    const isGame = item.gameUrl;
                    const isVideo = item.videoUrl;
                    const itemClass = isGame ? 'game' : (isVideo ? 'video' : '');
                    const imageUrl = item.displayImageUrl || item.imageUrl;
                    
                    let content = '';
                    let onClickHandler = '';
                    let assetType = '';
                    let assetUrl = '';
                    
                    if (isGame) {
                        const gameName = getGameName(item);
                        content = `<div style="width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; padding: 0.75rem; user-select: none;"><div style="display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--steam-iron-200);"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: var(--steam-gold-300); margin-bottom: 0.25rem;"><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .69.28 1.32.73 1.77.45.45 1.08.73 1.77.73H21a2 2 0 1 1 0 4h-.09c-.69 0-1.32.28-1.77.73-.45.45-.73 1.08-.73 1.77z"/></svg><div style="font-size: 0.75rem; letter-spacing: 0.1em; font-weight: 600; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding: 0 0.25rem;">${gameName}</div></div></div>`;
                        assetType = 'game';
                        assetUrl = item.gameUrl || '';
                    } else if (isVideo) {
                        assetUrl = item.videoUrl || '';
                        assetType = 'video';
                        onClickHandler = `onclick="openLightbox('${assetUrl}', 'video', '${item.id}')"`;
                        content = `<div style="width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; padding: 0.75rem; cursor: pointer; position: relative;" ${onClickHandler}><video src="${assetUrl}" style="max-height: 100%; max-width: 100%; object-fit: contain; border-radius: 8px;" muted preload="metadata"></video><div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;"><div style="height: 3rem; width: 3rem; border-radius: 50%; background: rgba(0, 0, 0, 0.6); color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);"><svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z" /></svg></div></div></div>`;
                    } else {
                        assetUrl = imageUrl || '';
                        assetType = 'image';
                        onClickHandler = `onclick="openLightbox('${assetUrl}', 'image', '${item.id}')"`;
                        content = `<img src="${assetUrl}" alt="submission" style="width: 100%; height: 100%; object-fit: contain; padding: 0.75rem; cursor: zoom-in;" ${onClickHandler}>`;
                    }
                    
                    return `
                        <div class="submission-item ${itemClass}" style="position: relative;">
                            ${content}
                            ${isGame && assetUrl ? `
                                <a href="${assetUrl}" target="_blank" rel="noreferrer" style="position: absolute; top: 0.5rem; left: 0.5rem; z-index: 10; display: inline-flex; align-items: center; gap: 0.25rem; border-radius: 4px; background: rgba(0, 0, 0, 0.6); color: white; font-size: 0.75rem; padding: 0.25rem 0.5rem; text-decoration: none; cursor: pointer; pointer-events: auto;" onclick="event.stopPropagation()" title="ゲームを開く">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="3"></circle>
                                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .69.28 1.32.73 1.77.45.45 1.08.73 1.77.73H21a2 2 0 1 1 0 4h-.09c-.69 0-1.32.28-1.77.73-.45.45-.73 1.08-.73 1.77z"/>
                                    </svg>
                                    開く
                                </a>
                            ` : ''}
                            <button onclick="deleteSubmission('${item.id}')" style="display: none; position: absolute; top: 0.5rem; right: 0.5rem; border-radius: 4px; background: rgba(220, 38, 38, 0.9); color: white; font-size: 0.75rem; padding: 0.25rem 0.5rem; border: none; cursor: pointer; z-index: 10; pointer-events: auto;" class="submission-delete-btn">削除</button>
                        </div>
                    `;
                }).join('');
                
                // ホバーで削除ボタン表示
                document.querySelectorAll('.submission-item').forEach(item => {
                    item.addEventListener('mouseenter', function() {
                        const btn = this.querySelector('.submission-delete-btn');
                        if (btn) btn.style.display = 'block';
                    });
                    item.addEventListener('mouseleave', function() {
                        const btn = this.querySelector('.submission-delete-btn');
                        if (btn) btn.style.display = 'none';
                    });
                });
            } else {
                grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--steam-iron-300);">提出物がありません</div>';
            }
        })
        .catch(err => {
            console.error('Failed to load submissions:', err);
            document.getElementById('submissions-grid').innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--steam-iron-300);">提出物の読み込みに失敗しました</div>';
        });
    }
    
    function loadTimeline() {
        fetch('/api/timeline/', {
            headers: {
                'Authorization': `Bearer ${token}`,
            }
        })
        .then(res => res.json())
        .then(data => {
            const list = document.getElementById('timeline-list');
            if (data.items && data.items.length > 0) {
                list.innerHTML = data.items.map(item => {
                    const displayName = item.displayName || item.anonId;
                    const typeText = item.type === 'ゲーム' ? 'ゲーム' : (item.type === '動画' ? '動画' : '画像');
                    const avatarUrl = item.avatarUrl || item.avatar_url;
                    
                    let avatarHtml = '';
                    if (avatarUrl) {
                        avatarHtml = `<div class="timeline-avatar"><img src="${avatarUrl}" alt="${displayName}" onerror="this.parentElement.innerHTML='<span>${displayName.charAt(0)}</span>'"></div>`;
                    } else {
                        avatarHtml = `<div class="timeline-avatar"><span>${displayName.charAt(0)}</span></div>`;
                    }
                    
                    return `<li class="timeline-item">
                        ${avatarHtml}
                        <a href="/profile/view/?user=${encodeURIComponent(item.anonId)}" style="color: var(--steam-gold-400); text-decoration: underline;">${displayName}</a>
                        <span>さんが${typeText}を投稿しました。</span>
                    </li>`;
                }).join('');
            } else {
                list.innerHTML = '<li>データなし</li>';
            }
        })
        .catch(err => {
            console.error('Failed to load timeline:', err);
            document.getElementById('timeline-list').innerHTML = '<li>データなし</li>';
        });
    }
    
    function loadSubmitters() {
        fetch('/api/submitters/today/', {
            headers: {
                'Authorization': `Bearer ${token}`,
            }
        })
        .then(res => res.json())
        .then(data => {
            const list = document.getElementById('submitters-list');
            const countElement = document.getElementById('submitters-count');
            if (data.submitters && data.submitters.length > 0) {
                // カウントを更新
                if (countElement) {
                    countElement.textContent = `${data.submitters.length}名`;
                }
                list.innerHTML = data.submitters.map(s => {
                    const displayName = s.displayName || s.anonId;
                    return `<li style="display: flex; align-items: center; gap: 0.5rem;">
                        <a href="/profile/view/?user=${encodeURIComponent(s.anonId)}" style="color: var(--steam-gold-400); text-decoration: underline;">${displayName}</a>
                    </li>`;
                }).join('');
            } else {
                // カウントを0に更新
                if (countElement) {
                    countElement.textContent = '0名';
                }
                list.innerHTML = '<li>データなし</li>';
            }
        })
        .catch(err => {
            console.error('Failed to load submitters:', err);
            const countElement = document.getElementById('submitters-count');
            if (countElement) {
                countElement.textContent = '0名';
            }
            document.getElementById('submitters-list').innerHTML = '<li>データなし</li>';
        });
    }
    
    function loadRanking() {
        fetch('/api/ranking/daily/', {
            headers: {
                'Authorization': `Bearer ${token}`,
            }
        })
        .then(res => res.json())
        .then(data => {
            const list = document.getElementById('ranking-list');
            if (data.ranking && data.ranking.length > 0) {
                list.innerHTML = data.ranking.map((r, index) => {
                    const displayName = r.displayName || r.anonId;
                    return `<li style="display: flex; align-items: center; gap: 0.5rem;">
                        <a href="/profile/view/?user=${encodeURIComponent(r.anonId)}" style="color: var(--steam-gold-400); text-decoration: underline;">${displayName}</a>
                        <span style="color: var(--steam-iron-300); font-size: 0.75rem;">(${r.count}件)</span>
                    </li>`;
                }).join('');
            } else {
                list.innerHTML = '<li>データなし</li>';
            }
        })
        .catch(err => {
            console.error('Failed to load ranking:', err);
            document.getElementById('ranking-list').innerHTML = '<li>データなし</li>';
        });
    }
    
    function setupUpload() {
        const uploadInput = document.getElementById('upload-input');
        const uploadArea = document.getElementById('upload-area');
        let isDragging = false;
        
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            isDragging = true;
            uploadArea.classList.add('dragging');
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            isDragging = false;
            uploadArea.classList.remove('dragging');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            isDragging = false;
            uploadArea.classList.remove('dragging');
            const file = e.dataTransfer.files?.[0];
            if (file) handleUpload(file);
        });
        
        uploadInput.addEventListener('change', function(e) {
            const file = e.target.files?.[0];
            if (file) handleUpload(file);
            e.target.value = '';
        });
    }
    
    async function handleUpload(file) {
        // ファイルタイプの検証
        const isJpeg = file.type === 'image/jpeg' || /\.(jpe?g)$/i.test(file.name);
        const isPng = file.type === 'image/png' || /\.(png)$/i.test(file.name);
        const isMp4 = file.type === 'video/mp4' || /\.(mp4)$/i.test(file.name);
        const isWebm = file.type === 'video/webm' || /\.(webm)$/i.test(file.name);
        const isOgg = file.type === 'video/ogg' || /\.(ogg)$/i.test(file.name);
        const isVideo = isMp4 || isWebm || isOgg;
        
        if (!(isJpeg || isPng || isVideo)) {
            document.getElementById('upload-error').textContent = 'PNG / JPEG / MP4 / WEBM / OGG のみ対応しています';
            document.getElementById('upload-error').style.display = 'block';
            return;
        }
        
        // ファイルサイズの検証（1GB制限）
        if (file.size > 1024 * 1024 * 1024) {
            document.getElementById('upload-error').textContent = 'ファイルサイズが大きすぎます（最大1GB）';
            document.getElementById('upload-error').style.display = 'block';
            return;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        
        document.getElementById('upload-overlay').classList.add('show');
        document.getElementById('upload-status').style.display = 'block';
        document.getElementById('upload-error').style.display = 'none';
        
        try {
            // 1. Upload file to /api/submit/upload
            const uploadRes = await fetch('/api/submit/upload', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                },
                body: formData
            });
            
            if (!uploadRes.ok) {
                let msg = 'アップロードに失敗しました';
                try {
                    const ct = uploadRes.headers.get('Content-Type') || '';
                    if (ct.includes('application/json')) {
                        const j = await uploadRes.json();
                        msg = j?.message || j?.error || msg;
                    } else {
                        msg = await uploadRes.text();
                    }
                } catch {}
                throw new Error(msg || `HTTP ${uploadRes.status}`);
            }
            
            const uploadData = await uploadRes.json();
            const imageUrl = uploadData.imageUrl;
            const videoUrl = uploadData.videoUrl;
            const displayImageUrl = uploadData.displayImageUrl || imageUrl || videoUrl;
            
            // 2. Submit with imageUrl/videoUrl to get rewards
            const submitRes = await fetch('/api/submit/', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    aim: isVideo ? '動画提出' : '画像提出',
                    steps: ['準備', '実行', '完了'],
                    frameType: 'none',
                    ...(imageUrl ? { imageUrl } : {}),
                    ...(videoUrl ? { videoUrl } : {})
                })
            });
            
            if (!submitRes.ok) {
                throw new Error('提出に失敗しました');
            }
            
            const submitData = await submitRes.json();
            
            // 3. Hide upload overlay
            document.getElementById('upload-overlay').classList.remove('show');
            document.getElementById('upload-status').style.display = 'none';
            
            // 4. Show reward flow (card → title)
            if (submitData.rewardCard || submitData.rewardTitle) {
                showRewardFlow(submitData);
            } else {
                // 報酬がない場合も提出物をリロード
                loadSubmissions();
                loadProfile();
                loadSubmitters();
                loadRanking();
            }
        } catch (err) {
            document.getElementById('upload-overlay').classList.remove('show');
            document.getElementById('upload-status').style.display = 'none';
            document.getElementById('upload-error').textContent = err.message || 'アップロードに失敗しました';
            document.getElementById('upload-error').style.display = 'block';
            console.error('Upload error:', err);
        }
    }
    
    function deleteSubmission(id) {
        if (!confirm('この提出を削除します。よろしいですか？')) return;
        
        fetch(`/api/submissions/${id}/`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`,
                'X-CSRFToken': csrftoken
            }
        })
        .then(res => {
            if (res.ok) {
                loadSubmissions();
            } else {
                alert('削除に失敗しました');
            }
        })
        .catch(err => {
            console.error(err);
            alert('エラーが発生しました');
        });
    }
    
    function setupGameUpload() {
        const uploadGameInput = document.getElementById('upload-game-input');
        const uploadGameArea = document.getElementById('upload-game-area');
        
        if (!uploadGameInput || !uploadGameArea) return;
        
        uploadGameInput.addEventListener('change', function(e) {
            const file = e.target.files?.[0];
            if (file) handleGameUpload(file);
            e.target.value = '';
        });
    }
    
    async function handleGameUpload(file) {
        // ZIPファイルの検証
        if (!file.name.toLowerCase().endsWith('.zip')) {
            document.getElementById('upload-game-error').textContent = 'ZIPファイルを選択してください';
            document.getElementById('upload-game-error').style.display = 'block';
            return;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        
        document.getElementById('upload-overlay').classList.add('show');
        document.getElementById('upload-game-error').style.display = 'none';
        
        try {
            // 1. ZIPファイルをアップロード
            const uploadRes = await fetch('/api/submit/uploadGame', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                },
                body: formData
            });
            
            if (!uploadRes.ok) {
                let msg = 'ZIPファイルのアップロードに失敗しました';
                try {
                    const ct = uploadRes.headers.get('Content-Type') || '';
                    if (ct.includes('application/json')) {
                        const j = await uploadRes.json();
                        msg = j?.message || j?.error || msg;
                    } else {
                        msg = await uploadRes.text();
                    }
                } catch {}
                throw new Error(msg || `HTTP ${uploadRes.status}`);
            }
            
            const uploadData = await uploadRes.json();
            const gameUrl = uploadData.gameUrl;
            
            if (!gameUrl) {
                throw new Error('ゲームURLの取得に失敗しました');
            }
            
            // 2. Submit with gameUrl to get rewards
            const submitRes = await fetch('/api/submit/', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    aim: 'ゲーム提出',
                    steps: ['準備', '実行', '完了'],
                    frameType: 'none',
                    gameUrl: gameUrl
                })
            });
            
            if (!submitRes.ok) {
                throw new Error('提出に失敗しました');
            }
            
            const submitData = await submitRes.json();
            
            // 3. Hide upload overlay
            document.getElementById('upload-overlay').classList.remove('show');
            
            // 4. Show reward flow (card → title)
            if (submitData.rewardCard || submitData.rewardTitle) {
                showRewardFlow(submitData);
            } else {
                // 報酬がない場合も提出物をリロード
                loadSubmissions();
                loadProfile();
                loadSubmitters();
                loadRanking();
            }
        } catch (err) {
            document.getElementById('upload-overlay').classList.remove('show');
            document.getElementById('upload-game-error').textContent = err.message || 'ゲームのアップロードに失敗しました';
            document.getElementById('upload-game-error').style.display = 'block';
            console.error('Game upload error:', err);
        }
    }
    
    function fetchTopic(type) {
        const element = document.getElementById(`topic-${type}`);
        element.style.display = 'block';
        element.textContent = '読み込み中…';
        // 実際のAPI呼び出しは実装が必要
    }
    
    // 報酬演出フロー
    function showRewardFlow(submitData) {
        const overlay = document.getElementById('reward-overlay');
        const cardReveal = document.getElementById('card-reveal');
        const titleReveal = document.getElementById('title-reveal');
        
        // カード演出を表示
        if (submitData.rewardCard) {
            const card = submitData.rewardCard;
            const rarityText = card.rarity || 'N';
            const isEpic = rarityText === 'SSR' || rarityText === 'SR';
            
            document.getElementById('card-rarity').textContent = `${rarityText} 獲得！`;
            document.getElementById('card-rarity').style.color = isEpic ? 'var(--steam-gold-500)' : 'var(--steam-gold-300)';
            document.getElementById('card-name').textContent = card.card_name || 'Card';
            
            // カード画像URLを解決
            let imageUrl = null;
            if (card.image_url && card.image_url !== '-' && card.image_url !== '') {
                // image_urlが設定されている場合
                imageUrl = card.image_url.startsWith('http') ? card.image_url : card.image_url;
            } else {
                // image_urlがない場合はデフォルトパスを使用
                imageUrl = `/uploads/cards/${card.card_id || 'C001'}.png`;
            }
            
            // Effectカードの画像が存在しない場合はCharacterカードのデフォルト画像を使用
            if (card.card_id && card.card_id.startsWith('E')) {
                // Effectカードの場合は、Characterカードのデフォルト画像を試す
                imageUrl = `/uploads/cards/C001.png`; // プレースホルダー
            }
            
            document.getElementById('card-image').src = imageUrl;
            document.getElementById('card-image').style.display = 'block';
            document.getElementById('card-image').onerror = function() {
                // 画像読み込みエラー時は非表示にする
                console.warn('Failed to load card image:', imageUrl);
                this.style.display = 'none';
            };
            
            cardReveal.style.display = 'block';
            titleReveal.style.display = 'none';
        } else {
            // カードがない場合は直接称号へ
            cardReveal.style.display = 'none';
            if (submitData.rewardTitle) {
                document.getElementById('title-name').textContent = submitData.rewardTitle;
                titleReveal.style.display = 'block';
            }
        }
        
        overlay.style.display = 'flex';
    }
    
    function nextToTitle() {
        const cardReveal = document.getElementById('card-reveal');
        const titleReveal = document.getElementById('title-reveal');
        
        cardReveal.style.display = 'none';
        titleReveal.style.display = 'block';
    }
    
    function closeRewardFlow() {
        const overlay = document.getElementById('reward-overlay');
        overlay.style.display = 'none';
        
        // 最新のデータを再読み込み（ページリロードではなく）
        loadProfile();
        loadSubmissions();
        loadSubmitters();
        loadRanking();
    }
    
    // ライトボックス機能
    let currentLightboxAssetId = null;
    
    function openLightbox(url, type, assetId) {
        const lightbox = document.getElementById('lightbox');
        const lightboxImage = document.getElementById('lightbox-image');
        const lightboxVideo = document.getElementById('lightbox-video');
        const lightboxActions = document.getElementById('lightbox-actions');
        
        currentLightboxAssetId = assetId;
        
        if (type === 'video') {
            lightboxImage.style.display = 'none';
            lightboxVideo.style.display = 'block';
            lightboxVideo.src = url;
            lightboxVideo.load();
        } else {
            lightboxImage.style.display = 'block';
            lightboxVideo.style.display = 'none';
            lightboxImage.src = url;
        }
        
        // Discordシェアボタンを表示（画像と動画のみ）
        if (type === 'image' || type === 'video') {
            lightboxActions.style.display = 'flex';
        } else {
            lightboxActions.style.display = 'none';
        }
        
        lightbox.classList.add('show');
        document.body.style.overflow = 'hidden';
    }
    
    function closeLightbox() {
        const lightbox = document.getElementById('lightbox');
        const lightboxVideo = document.getElementById('lightbox-video');
        
        lightbox.classList.remove('show');
        document.body.style.overflow = '';
        
        // 動画を停止
        if (lightboxVideo) {
            lightboxVideo.pause();
            lightboxVideo.src = '';
        }
        
        currentLightboxAssetId = null;
    }
    
    // ESCキーで閉じる
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const lightbox = document.getElementById('lightbox');
            if (lightbox.classList.contains('show')) {
                closeLightbox();
            }
        }
    });
    
    // Discordシェア機能
    async function shareToDiscord() {
        if (!currentLightboxAssetId) {
            alert('アセットIDが見つかりません');
            return;
        }
        
        const btn = document.getElementById('discord-share-btn');
        const originalText = btn.innerHTML;
        
        try {
            btn.disabled = true;
            btn.innerHTML = '<span>送信中…</span>';
            
            const response = await fetch('/api/share/discord/', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    assetId: currentLightboxAssetId
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.ok) {
                alert('Discordにシェアしました');
                if (data.discordMessageId) {
                    // Discordで開くリンクを表示（オプション）
                    console.log('Discord message ID:', data.discordMessageId);
                }
            } else {
                const errorMsg = data.error || 'Discordへのシェアに失敗しました';
                if (errorMsg.includes('25MB') || errorMsg.includes('20MB')) {
                    alert('ファイルサイズが大きすぎます（25MB以下）');
                } else {
                    alert(errorMsg);
                }
            }
        } catch (err) {
            console.error('Discord share error:', err);
            alert('Discordへのシェアに失敗しました');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
</script>

<!-- ライトボックス -->
<div id="lightbox" onclick="closeLightbox()">
    <div id="lightbox-content" onclick="event.stopPropagation()">
        <button id="lightbox-close" onclick="closeLightbox()" aria-label="閉じる">×</button>
        <img id="lightbox-image" src="" alt="" style="display: none;">
        <video id="lightbox-video" controls style="display: none;"></video>
        <div id="lightbox-actions" style="display: none;">
            <button id="discord-share-btn" class="discord-share-btn" onclick="shareToDiscord()">
                <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.317 4.369A19.791 19.791 0 0 0 16.558 3c-.2.363-.43.85-.59 1.23a18.33 18.33 0 0 0-5.934 0A9.145 9.145 0 0 0 9.464 3a19.736 19.736 0 0 0-3.759 1.369C2.83 8.165 2.18 11.86 2.454 15.5a19.9 19.9 0 0 0 4.883 2.469c.395-.54.747-1.11 1.053-1.706a12.7 12.7 0 0 1-1.66-.8c.14-.103.277-.211.408-.322 3.219 1.5 6.711 1.5 9.896 0 .133.111.27.219.41.322-.53.31-1.09.583-1.668.8.306.596.658 1.166 1.053 1.706a19.9 19.9 0 0 0 4.882-2.469c.4-5.09-.683-8.753-2.524-11.131ZM9.861 13.623c-.96 0-1.748-.88-1.748-1.957 0-1.078.77-1.958 1.748-1.958.978 0 1.766.88 1.748 1.958 0 1.078-.77 1.957-1.748 1.957Zm4.295 0c-.96 0-1.748-.88-1.748-1.957 0-1.078.77-1.958 1.748-1.958s1.748.88 1.748 1.958c0 1.078-.77 1.957-1.748 1.957Z"/>
                </svg>
                <span>Discordにシェア</span>
            </button>
        </div>
    </div>
</div>

{% endblock %}

