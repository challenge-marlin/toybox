### ToyBox やることリスト

- 記法: チェックボックス [ ] / [x]、優先度 P0(最優先) / P1 / P2
- 方針: 既存データは消さない、マイグレーションで安全に拡張（ダウンタイム最小）
- 時刻: 表示・集計とも日本時間(JST)基準で統一（バックエンドはUTC保存/JST判定）

---

### 現状サマリー（2025-10-28）
- [x] みんなの投稿（`/feed`）実装・表示OK
- [x] いいね機能・通知（ベル）実装済み
- [x] ConoHa ホスティング手順ドキュメントを作成（`ホスティング.md`）
- [x] フィードの画像URL解決エラー修正（`assets.resolveUploadUrl` のエクスポート不備を修正）
- [x] プロフィール画像の即時反映を全ページで統一（キャッシュ対策の仕上げ）

---

### P0（最優先）
- [x] フィード実行時エラー「resolveUploadUrl is not a function」を修正（2025-10-28）
  - 対応: `frontend/src/lib/assets.ts` で `resolveUploadUrl` を名前付きエクスポート
  - 影響: `/feed`・`/profile/view` でのランタイム例外解消

- [x] アイコン画像が反映されない問題を解決
  - 目的: プロフィール画像更新後に即時反映される状態にする
  - 想定原因: ブラウザ/プロキシキャッシュ、静的ファイルの同名上書き、`Cache-Control`/`ETag` 未調整、アップロードパス不整合
  - 対応案:
    - アップロード後のURLにバージョン付与（`?v=updatedAt` 等）
    - `Cache-Control: no-store`（アバターのみ）または短い `max-age` を設定
    - ファイル名にハッシュ/タイムスタンプを埋め込む（指紋付け）
    - `next/image` 使用時のドメイン/パス設定確認、`Image` の `unoptimized` 検証
  - 受け入れ条件: 更新直後のF5・強制リロード無しで新画像が表示される（全主要ブラウザ）

- [x] みんなの投稿広場ページを実装（一覧フィード）
  - 目的: 全ユーザーの投稿を時系列で閲覧できる公開ページを提供
  - 仕様（初期版）:
    - ルート: `/feed`（仮）
    - データ: `GET /api/feed` を使用（ページング必須）
    - 要素: サムネイル、本文要約、投稿者名/アイコン、投稿日、いいね数
    - 並び: 新着順（将来: 人気順）
  - 受け入れ条件: 20件/ページ表示、次ページ読み込みで重複無し、空状態のUI

- [x] いいね機能を実装
  - モデル/DB:
    - `Submission`: `likesCount:number` を追加（既存データは0でバックフィル）
    - `UserMeta` などに `likedSubmissionIds: ObjectId[]`（匿名ID単位で一意）
  - API（匿名認証対応）:
    - `POST /api/submissions/:id/like`（冪等: 既にいいね済みなら200）
    - `DELETE /api/submissions/:id/like`（未いいねなら200）
    - レート制限、監査ログ/メトリクス追加
  - フロント:
    - いいねボタン（トグル）、カウント表示、楽観的更新、エラー時ロールバック
  - 受け入れ条件: 多重クリック/並行リクエストでも整合性維持、再読込後も状態一致

- [x] 本番ホスティング手順を整備（ConoHa 版）（2025-10-28）
  - 成果物: ルート直下 `ホスティング.md`（やさしい版、Caddy/Composeテンプレ付き）

---

### P1（重要）
- [x] 画像URL解決の共通化（`assets.resolveUploadUrl` に統一、`mypage/page.tsx` のローカル関数廃止）
- [x] 本番ファイル同梱（今はドキュメント内のテンプレ）
  - `docker-compose.prod.yml` と `Caddyfile` を実ファイルで追加
  - [x] 完了（`docker-compose.prod.yml` と `Caddyfile` を追加）
- [x] CORS/環境変数の本番値を最終確定
  - `backend/.env` の `CORS_ORIGINS` を本番ドメインへ、`JWT_SECRET` を十分長い乱数へ
  - [x] 完了（`env.example` に本番例を追記、compose とホスティング手順と整合）
- [x] 無限スクロール/ページング改善（`/feed`）
  - IntersectionObserver で連続ロード、ロード中/終端表示、重複排除
- [x] 投稿詳細モーダル/ページ
  - URL直リンク可能、OGP対応、前後投稿ナビ
  - [x] 完了（/s/[id] を追加、OGPメタ/前後ナビ、単一投稿API）
- [x] 画像最適化
  - WebP/AVIF 優先、`next/image` 設定、サムネイル生成とリサイズパイプライン
  - [x] 完了（sharpでWebP/AVIF生成・w640優先、API/フロント参照、next.config更新）
- [x] 通知（任意）: 自分の投稿がいいねされたら通知
  - ヘッダーにベル＋未読バッジ、ドロップダウン一覧、開時既読化、もっと見る
  - API: `GET /api/notifications`, `POST /api/notifications/read`
- [x] エラーUI/トーストの統一（成功/失敗/警告パターン）
  - [x] 完了（共通ToastProvider導入、layoutに組込み、mypage/profileに適用）
- [x] フロント/バックの入力バリデーション整合（zodスキーマ共有の検討）
  - [x] 完了（bio最大1000/表示名50に統一、フロントzod導入・事前検証）

---

### P2（改善）
- [ ] ドキュメント拡充（図解/スクショ追加）
  - `ホスティング.md` に画面キャプチャと失敗例Q&Aを追加
  - [x] 完了（スクショ差し込み口と詳細Q&A/ヘルスチェック追記）
- [ ] アクセシビリティ改善（キーボード操作、ラベル、コントラスト）
  - [x] 完了（Skipリンク、ダイアログのEsc/Tab対応、focus-visible強化）
- [ ] E2Eテスト導入（Playwright/Cypress）と主要ユーザーフローの自動化
  - [x] 完了（Playwright 設定・/feed表示・/health疎通の基本テスト追加）
- [x] メトリクス拡充（いいね操作、フィード表示時間、CLS/LCP）
- [x] OGP/SEO強化（タイトル/説明、サムネ、構造化データ）
- [x] Docker/デプロイ整備（アップロード永続化、`CORS_ORIGINS` 見直し、ヘルスチェック）
- [x] `.env` テンプレ充実（frontend/backend）とREADME更新
  - [x] README 更新（2025-10-22の変更反映）

---

### 運用/技術タスク（横断）
- [ ] 既存データを消さない方針でのマイグレーション設計
  - likes系フィールドの追加/バックフィル、ロールバック手順、リハーサル
- [ ] 画像アップロードの最大サイズ/拡張子の明確化とエラーメッセージ統一
- [ ] タイムゾーン一貫性: 表示はJST、サーバ判定/日次制限もJST基準
- [ ] ロギング粒度見直し（PII除外、相関ID、レート制限ログ）
- [ ] 主要フローのユニットテスト追加（like、feed、プロフィール更新）

---

### メモ/依存関係
- みんなの投稿広場（`/feed`）→ いいね数表示のため likes 実装が望ましい
- アイコン反映問題はUI改修のみで解決しない場合が多く、バックエンドのキャッシュヘッダやファイル名指紋付けが必要
- 匿名認証（`x-anon-id`）前提のいいねは、端末切替で状態が変わる点に注意（将来サインイン連携検討）
