{% extends 'frontend/base.html' %}
{% load static %}

{% block title %}ToyBox - みんなの投稿{% endblock %}

{% block extra_css %}
<style>
    .feed-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem;
    }
    
    .feed-title {
        margin-bottom: 1rem;
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--steam-gold-300);
    }
    
    .feed-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }
    
    @media (min-width: 768px) {
        .feed-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }
    
    @media (min-width: 1024px) {
        .feed-grid {
            grid-template-columns: repeat(6, 1fr);
        }
    }
    
    .feed-item {
        position: relative;
        border-radius: 8px;
        border: 1px solid var(--steam-iron-700);
        background: var(--steam-iron-900);
        overflow: hidden;
        aspect-ratio: 1;
    }
    
    .feed-item.game {
        border-color: #a855f7;
    }
    
    .feed-item.video {
        border-color: #0ea5e9;
    }
    
    .feed-item-header {
        position: absolute;
        top: 0.5rem;
        left: 0.5rem;
        z-index: 10;
        font-size: 0.625rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.6);
        color: white;
    }
    
    .feed-item-header a {
        color: white;
        text-decoration: none;
    }
    
    .feed-item-header a:hover {
        text-decoration: underline;
    }
    
    .feed-item-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
        padding: 0.75rem;
        cursor: zoom-in;
    }
    
    .feed-item-video-container {
        width: 100%;
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem;
        cursor: pointer;
        position: relative;
    }
    
    .feed-item-video {
        max-height: 100%;
        max-width: 100%;
        object-fit: contain;
        border-radius: 8px;
    }
    
    .feed-item-play-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .feed-item-play-button {
        height: 3rem;
        width: 3rem;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    .feed-item-game-container {
        width: 100%;
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem;
        user-select: none;
    }
    
    .feed-item-game-icon {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--steam-iron-200);
    }
    
    .feed-item-game-icon svg {
        width: 40px;
        height: 40px;
        color: var(--steam-gold-300);
        margin-bottom: 0.25rem;
    }
    
    .feed-item-game-label {
        font-size: 0.75rem;
        letter-spacing: 0.1em;
        font-weight: 600;
    }
    
    .feed-item-ring {
        position: absolute;
        inset: 0;
        pointer-events: none;
        border-radius: 8px;
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    .feed-item.game .feed-item-ring {
        box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.7);
    }
    
    .feed-item.video .feed-item-ring {
        box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.7);
    }
    
    .feed-item:not(.game):not(.video) .feed-item-ring {
        box-shadow: 0 0 0 2px rgba(224, 168, 0, 0.6);
    }
    
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
    }
    
    .feed-like-btn {
        position: absolute;
        bottom: 0.5rem;
        right: 0.5rem;
        z-index: 10;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.6);
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        color: white;
        border: none;
        cursor: pointer;
    }
    
    .feed-like-btn:hover {
        background: rgba(0, 0, 0, 0.8);
    }
    
    .feed-like-btn svg {
        width: 16px;
        height: 16px;
    }
    
    .feed-like-btn.liked svg {
        fill: #fb7185;
        color: #fb7185;
    }
    
    .feed-game-link {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        z-index: 10;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.6);
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        color: white;
        text-decoration: none;
    }
    
    .feed-game-link:hover {
        background: rgba(0, 0, 0, 0.8);
    }
    
    .feed-game-link svg {
        width: 14px;
        height: 14px;
    }
    
    .loading {
        text-align: center;
        padding: 2rem;
        color: var(--steam-iron-300);
        font-size: 0.875rem;
    }
    
    .feed-sentinel {
        height: 4px;
    }
    
    .feed-end-message {
        margin-top: 1rem;
        text-align: center;
        font-size: 0.75rem;
        color: var(--steam-iron-400);
    }
</style>
{% endblock %}

{% block content %}
<div class="feed-container">
    <h1 class="feed-title">みんなの投稿</h1>
    
    <!-- 人気作品セクション -->
    <section id="popular-section" style="margin-bottom: 2rem;">
        <h2 style="margin-bottom: 0.75rem; font-size: 1.25rem; font-weight: 600; color: var(--steam-gold-300);">人気作品</h2>
        <div id="popular-feed" class="feed-grid">
            <div class="loading">読み込み中...</div>
        </div>
    </section>
    
    <!-- 通常の投稿一覧 -->
    <section>
        <h2 style="margin-bottom: 0.75rem; font-size: 1.25rem; font-weight: 600; color: var(--steam-gold-300);">最新の投稿</h2>
        <div id="feed" class="feed-grid">
            <div class="loading">読み込み中...</div>
        </div>
    </section>
    <div id="sentinel" class="feed-sentinel"></div>
    <div id="loading-indicator" class="loading" style="display: none;">読み込み中…</div>
    <div id="end-message" class="feed-end-message" style="display: none;">すべて表示しました</div>
</div>

<!-- ライトボックス -->
<div id="lightbox" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; cursor: pointer; align-items: center; justify-content: center;" onclick="closeLightbox()">
    <div id="lightbox-content" onclick="event.stopPropagation()" style="position: relative; max-width: 90vw; max-height: 90vh; display: flex; flex-direction: column; align-items: center; gap: 1rem;">
        <button id="lightbox-close" onclick="closeLightbox()" aria-label="閉じる" style="position: absolute; top: -2.5rem; right: 0; background: rgba(0, 0, 0, 0.6); color: white; border: none; border-radius: 9999px; padding: 0.5rem 1rem; font-size: 1rem; cursor: pointer;">×</button>
        <img id="lightbox-image" src="" alt="" style="max-width: 90vw; max-height: 80vh; object-fit: contain; border-radius: 8px; cursor: default; display: none;">
        <video id="lightbox-video" controls style="max-width: 90vw; max-height: 80vh; background: black; border-radius: 8px; cursor: default; display: none;"></video>
        <div id="lightbox-actions" style="display: none; gap: 0.5rem; align-items: center;">
            <button id="discord-share-btn" class="discord-share-btn" onclick="shareToDiscord()" style="display: inline-flex; align-items: center; gap: 0.5rem; background: #5865F2; color: white; border: none; border-radius: 9999px; padding: 0.5rem 1rem; font-size: 0.875rem; cursor: pointer;">
                <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.317 4.369A19.791 19.791 0 0 0 16.558 3c-.2.363-.43.85-.59 1.23a18.33 18.33 0 0 0-5.934 0A9.145 9.145 0 0 0 9.464 3a19.736 19.736 0 0 0-3.759 1.369C2.83 8.165 2.18 11.86 2.454 15.5a19.9 19.9 0 0 0 4.883 2.469c.395-.54.747-1.11 1.053-1.706a12.7 12.7 0 0 1-1.66-.8c.14-.103.277-.211.408-.322 3.219 1.5 6.711 1.5 9.896 0 .133.111.27.219.41.322-.53.31-1.09.583-1.668.8.306.596.658 1.166 1.053 1.706a19.9 19.9 0 0 0 4.882-2.469c.4-5.09-.683-8.753-2.524-11.131ZM9.861 13.623c-.96 0-1.748-.88-1.748-1.957 0-1.078.77-1.958 1.748-1.958.978 0 1.766.88 1.748 1.958 0 1.078-.77 1.957-1.748 1.957Zm4.295 0c-.96 0-1.748-.88-1.748-1.957 0-1.078.77-1.958 1.748-1.958s1.748.88 1.748 1.958c0 1.078-.77 1.957-1.748 1.957Z"/>
                </svg>
                <span>Discordにシェア</span>
            </button>
        </div>
    </div>
</div>

<script>
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    let items = [];
    let popularItems = [];
    let nextCursor = null;
    let loading = false;
    let popularLoading = false;
    let initialized = false;
    
    function loadFeed(cursor = null) {
        if (loading) return;
        loading = true;
        document.getElementById('loading-indicator').style.display = 'block';
        
        const url = cursor 
            ? `/api/feed/?cursor=${encodeURIComponent(cursor)}`
            : '/api/feed/';
        
        fetch(url, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token') || ''}`,
                'X-CSRFToken': csrftoken
            }
        })
        .then(res => {
            if (res.status === 401) {
                clearAuth();
                window.location.href = '/login/';
                return null;
            }
            if (res.status === 403) {
                // 403エラーの場合は課金ページにリダイレクト
                window.location.href = '/upgrade/';
                return null;
            }
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            if (!data) return;
            
            if (cursor) {
                const existingIds = new Set(items.map(x => x.id));
                const incoming = (data.items || []).filter(x => !existingIds.has(x.id));
                items = [...items, ...incoming];
            } else {
                items = data.items || [];
            }
            
            nextCursor = data.nextCursor || null;
            renderFeed();
            initialized = true;
        })
        .catch(err => {
            console.error(err);
        })
        .finally(() => {
            loading = false;
            document.getElementById('loading-indicator').style.display = 'none';
        });
    }
    
    function loadPopularFeed() {
        if (popularLoading) return;
        popularLoading = true;
        
        const token = localStorage.getItem('access_token');
        if (!token) {
            popularLoading = false;
            return;
        }
        
        fetch('/api/feed/popular/?limit=12', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'X-CSRFToken': csrftoken
            }
        })
        .then(res => {
            if (res.status === 401 || res.status === 403) {
                return null;
            }
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            if (!data) return;
            popularItems = data.items || [];
            renderPopularFeed();
        })
        .catch(err => {
            console.error('Failed to load popular feed:', err);
            const popularFeed = document.getElementById('popular-feed');
            if (popularFeed) {
                popularFeed.innerHTML = '<div class="loading" style="grid-column: 1 / -1; color: #ef4444;">人気作品の読み込みに失敗しました</div>';
            }
        })
        .finally(() => {
            popularLoading = false;
        });
    }
    
    function renderPopularFeed() {
        const popularFeed = document.getElementById('popular-feed');
        if (!popularFeed) return;
        
        if (popularItems.length === 0) {
            popularFeed.innerHTML = '<div class="loading" style="grid-column: 1 / -1;">人気作品はまだありません</div>';
            return;
        }
        
        popularFeed.innerHTML = popularItems.map(item => renderFeedItem(item)).join('');
    }
    
    function renderFeedItem(item) {
        const isGame = item.gameUrl;
        const isVideo = item.videoUrl;
        const itemClass = isGame ? 'game' : (isVideo ? 'video' : '');
        
        let content = '';
        if (isGame) {
            content = `
                <div class="feed-item-game-container">
                    <div class="feed-item-game-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .69.28 1.32.73 1.77.45.45 1.08.73 1.77.73H21a2 2 0 1 1 0 4h-.09c-.69 0-1.32.28-1.77.73-.45.45-.73 1.08-.73 1.77z"/>
                        </svg>
                        <div class="feed-item-game-label">GAME</div>
                    </div>
                </div>
            `;
        } else if (isVideo) {
            content = `
                <div class="feed-item-video-container" onclick="openLightbox('${item.videoUrl}', 'video', '${item.id}')">
                    <video src="${item.videoUrl}" class="feed-item-video" muted preload="metadata"></video>
                    <div class="feed-item-play-overlay">
                        <div class="feed-item-play-button">
                            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 22px; height: 22px;">
                                <path d="M8 5v14l11-7z" />
                            </svg>
                        </div>
                    </div>
                </div>
            `;
        } else {
            content = `<img src="${item.imageUrl || item.displayImageUrl || ''}" alt="submission" class="feed-item-image" onclick="openLightbox('${item.imageUrl || item.displayImageUrl || ''}', 'image', '${item.id}')">`;
        }
        
        return `
            <div class="feed-item ${itemClass}">
                <div class="feed-item-ring"></div>
                <div class="feed-item-header">
                    <a href="/users/${item.anonId || 'unknown'}/">${item.displayName || item.anonId || 'Unknown'}</a>
                </div>
                ${content}
                <button class="feed-like-btn ${item.liked ? 'liked' : ''}" onclick="toggleLike('${item.id}', ${item.liked || false})">
                    <svg viewBox="0 0 24 24" fill="${item.liked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z" />
                    </svg>
                    <span>${item.likesCount || 0}</span>
                </button>
                ${isGame ? `
                    <a href="${item.gameUrl}" target="_blank" rel="noreferrer" class="feed-game-link" title="ゲームを開く" onclick="event.stopPropagation()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .69.28 1.32.73 1.77.45.45 1.08.73 1.77.73H21a2 2 0 1 1 0 4h-.09c-.69 0-1.32.28-1.77.73-.45.45-.73 1.08-.73 1.77z"/>
                        </svg>
                        開く
                    </a>
                ` : ''}
            </div>
        `;
    }
    
    function renderFeed() {
        const feed = document.getElementById('feed');
        if (items.length === 0 && initialized) {
            feed.innerHTML = '<div class="loading" style="grid-column: 1 / -1;">投稿はまだありません</div>';
            return;
        }
        
        feed.innerHTML = items.map(item => renderFeedItem(item)).join('');
    }
    
    function toggleLike(submissionId, currentLiked) {
        const token = localStorage.getItem('access_token');
        if (!token) {
            alert('ログインが必要です');
            return;
        }
        
        const item = items.find(x => x.id === submissionId);
        if (!item) return;
        
        // 楽観的更新（即座にカウントを更新）
        item.liked = !currentLiked;
        item.likesCount = Math.max(0, (item.likesCount || 0) + (currentLiked ? -1 : 1));
        renderFeed();
        
        const method = currentLiked ? 'DELETE' : 'POST';
        fetch(`/api/submissions/${encodeURIComponent(submissionId)}/like/`, {
            method: method,
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
            },
            body: method === 'POST' ? JSON.stringify({}) : undefined
        })
        .then(res => res.json())
        .then(data => {
            if (data.ok !== undefined && data.likesCount !== undefined) {
                // サーバーからの結果で更新
                item.liked = data.liked || false;
                item.likesCount = data.likesCount || 0;
                renderFeed();
            }
        })
        .catch(err => {
            // エラー時はロールバック
            item.liked = currentLiked;
            item.likesCount = Math.max(0, (item.likesCount || 0) + (currentLiked ? 1 : -1));
            renderFeed();
            console.error('Failed to toggle like:', err);
        });
    }
    
    // ライトボックス機能
    let currentLightboxAssetId = null;
    
    function openLightbox(src, type, assetId) {
        const lightbox = document.getElementById('lightbox');
        const lightboxImage = document.getElementById('lightbox-image');
        const lightboxVideo = document.getElementById('lightbox-video');
        const lightboxActions = document.getElementById('lightbox-actions');
        
        currentLightboxAssetId = assetId;
        
        if (type === 'video') {
            lightboxImage.style.display = 'none';
            lightboxVideo.style.display = 'block';
            lightboxVideo.src = src;
            lightboxVideo.load();
        } else {
            lightboxImage.style.display = 'block';
            lightboxVideo.style.display = 'none';
            lightboxImage.src = src;
        }
        
        // Discordシェアボタンを表示（画像と動画のみ）
        if (type === 'image' || type === 'video') {
            lightboxActions.style.display = 'flex';
        } else {
            lightboxActions.style.display = 'none';
        }
        
        lightbox.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    
    function closeLightbox() {
        const lightbox = document.getElementById('lightbox');
        const lightboxVideo = document.getElementById('lightbox-video');
        
        lightbox.style.display = 'none';
        document.body.style.overflow = '';
        
        // 動画を停止
        if (lightboxVideo) {
            lightboxVideo.pause();
            lightboxVideo.src = '';
        }
        
        currentLightboxAssetId = null;
    }
    
    // ESCキーで閉じる
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const lightbox = document.getElementById('lightbox');
            if (lightbox.style.display === 'flex') {
                closeLightbox();
            }
        }
    });
    
    // Discordシェア機能
    async function shareToDiscord() {
        if (!currentLightboxAssetId) {
            alert('アセットIDが見つかりません');
            return;
        }
        
        const btn = document.getElementById('discord-share-btn');
        const originalText = btn.innerHTML;
        const token = localStorage.getItem('access_token');
        
        if (!token) {
            alert('ログインが必要です');
            return;
        }
        
        try {
            btn.disabled = true;
            btn.innerHTML = '<span>送信中…</span>';
            
            const response = await fetch('/api/share/discord/', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    assetId: currentLightboxAssetId
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.ok) {
                alert('Discordにシェアしました');
                if (data.discordMessageId) {
                    console.log('Discord message ID:', data.discordMessageId);
                }
            } else {
                const errorMsg = data.error || 'Discordへのシェアに失敗しました';
                if (errorMsg.includes('25MB') || errorMsg.includes('20MB')) {
                    alert('ファイルサイズが大きすぎます（25MB以下）');
                } else {
                    alert(errorMsg);
                }
            }
        } catch (err) {
            console.error('Discord share error:', err);
            alert('Discordへのシェアに失敗しました');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
    
    // 無限スクロール
    const observer = new IntersectionObserver((entries) => {
        for (const entry of entries) {
            if (entry.isIntersecting && nextCursor && !loading) {
                loadFeed(nextCursor);
            }
        }
    }, { root: null, rootMargin: '200px', threshold: 0 });
    
    document.addEventListener('DOMContentLoaded', function() {
        // ロールチェック：一般ユーザー（FREE_USER）はこのページにアクセスできない
        const token = localStorage.getItem('access_token');
        if (!token) {
            // トークンがない場合はログインページにリダイレクト
            window.location.href = '/login/';
            return;
        }
        
        // ロールチェックを実行（並行してfeedも読み込み開始）
        let roleCheckCompleted = false;
        let shouldRedirect = false;
        
        const roleCheckPromise = fetch('/api/users/me/', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(res => {
            if (res.ok) {
                return res.json();
            }
            throw new Error(`HTTP ${res.status}`);
        })
        .then(userData => {
            roleCheckCompleted = true;
            if (userData.role === 'FREE_USER') {
                shouldRedirect = true;
                window.location.href = '/upgrade/';
                return;
            }
            // 課金ユーザー以上の場合は通常の処理を続行
            if (!feedInitialized) {
                initializeFeed();
            }
        })
        .catch(err => {
            console.error('Error fetching user data:', err);
            roleCheckCompleted = true;
            // エラーが発生した場合は通常の処理を続行（API側でチェックされる）
            if (!feedInitialized) {
                initializeFeed();
            }
        });
        
        // タイムアウトを設定（1秒以内にロールチェックが完了しない場合は続行）
        setTimeout(() => {
            if (!roleCheckCompleted && !shouldRedirect && !feedInitialized) {
                console.warn('Role check timeout, proceeding with feed load');
                roleCheckCompleted = true;
                initializeFeed();
            }
        }, 1000);
        
        let feedInitialized = false;
        
        function initializeFeed() {
            if (feedInitialized) return;
            feedInitialized = true;
            loadFeed();
            loadPopularFeed(); // 人気作品を読み込む
            observer.observe(document.getElementById('sentinel'));
            
            // すべて表示済みのチェック
            const checkEnd = setInterval(() => {
                if (initialized && !loading && !nextCursor && items.length > 0) {
                    document.getElementById('end-message').style.display = 'block';
                    clearInterval(checkEnd);
                }
            }, 100);
        }
    });
</script>
{% endblock %}

