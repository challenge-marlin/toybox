{% extends 'frontend/base.html' %}
{% load static %}

{% block title %}TOYBOXï¼ - æŠ½é¸{% endblock %}

{% block extra_css %}
<style>
    .lottery-container {
        max-width: 600px;
        margin: 2rem auto;
        padding: 0 1rem;
    }
    
    .lottery-card {
        background: var(--steam-iron-900);
        border-radius: 8px;
        padding: 2rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        text-align: center;
        border: 1px solid var(--steam-iron-700);
    }
    
    .lottery-card h2 {
        margin-bottom: 2rem;
        color: var(--steam-gold-300);
        font-size: 1.5rem;
    }
    
    .lottery-card p {
        margin-bottom: 2rem;
        color: var(--steam-iron-300);
    }
    
    .lottery-btn {
        padding: 1rem 2rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.125rem;
        transition: all 0.2s;
        background: var(--steam-gold-500);
        color: #000;
    }
    
    .lottery-btn:hover {
        background: var(--steam-gold-400);
        transform: scale(1.05);
    }
    
    .lottery-btn:disabled {
        background: var(--steam-iron-600);
        cursor: not-allowed;
        transform: none;
    }
    
    .lottery-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
    }
    
    .lottery-modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--steam-iron-900);
        padding: 2rem;
        border-radius: 8px;
        max-width: 400px;
        width: 90%;
        border: 1px solid var(--steam-iron-700);
    }
    
    .lottery-modal.show {
        display: block;
    }
    
    .lottery-result-won {
        color: #10b981;
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 1rem;
    }
    
    .lottery-result-lost {
        color: var(--steam-iron-300);
        font-size: 1.125rem;
        margin-bottom: 1rem;
    }
    
    .lottery-close-btn {
        margin-top: 1rem;
        padding: 0.5rem 1rem;
        background: var(--steam-iron-600);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="lottery-container">
    <div class="lottery-card">
        <h2>æŠ½é¸</h2>
        <p>1æ—¥1å›æŠ½é¸ã§ãã¾ã™</p>
        <button id="drawBtn" class="lottery-btn" onclick="drawLottery()">æŠ½é¸ã™ã‚‹</button>
    </div>
</div>

<div id="resultModal" class="lottery-modal">
    <div class="lottery-modal-content">
        <div id="resultContent"></div>
        <button class="lottery-close-btn" onclick="closeModal()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    
    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    if (!requireAuth()) {
        // requireAuth()ãŒfalseã‚’è¿”ã—ãŸå ´åˆã€æ—¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¦ã„ã‚‹
    }
    
    function drawLottery() {
        if (!hasValidToken()) {
            window.location.href = '/login/';
            return;
        }
        
        const btn = document.getElementById('drawBtn');
        btn.disabled = true;
        btn.textContent = 'æŠ½é¸ä¸­...';
        
        fetch('/api/lottery/draw/', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        })
        .then(res => res.json())
        .then(data => {
            btn.disabled = false;
            btn.textContent = 'æŠ½é¸ã™ã‚‹';
            
            const modal = document.getElementById('resultModal');
            const content = document.getElementById('resultContent');
            
            if (data.won) {
                content.innerHTML = `
                    <div class="lottery-result-won">ğŸ‰ å½“é¸ã—ã¾ã—ãŸï¼</div>
                    <p>ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆã«å½“é¸ã—ã¾ã—ãŸï¼</p>
                    <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--steam-iron-300);">
                        ãƒ”ãƒ³å›ºå®šæœŸé™: ${new Date(data.pinned_until).toLocaleString('ja-JP')}
                    </p>
                `;
            } else {
                content.innerHTML = `
                    <div class="lottery-result-lost">æ®‹å¿µã€ä»Šå›ã¯å¤–ã‚Œã¾ã—ãŸ</div>
                    <p>ç¢ºç‡: ${(data.probability * 100).toFixed(2)}%</p>
                    <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--steam-iron-300);">
                        ãƒœãƒ¼ãƒŠã‚¹ã‚«ã‚¦ãƒ³ãƒˆ: ${data.bonusCount || 0}
                    </p>
                `;
            }
            
            modal.classList.add('show');
        })
        .catch(err => {
            btn.disabled = false;
            btn.textContent = 'æŠ½é¸ã™ã‚‹';
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message);
        });
    }
    
    function closeModal() {
        document.getElementById('resultModal').classList.remove('show');
    }
</script>
{% endblock %}

