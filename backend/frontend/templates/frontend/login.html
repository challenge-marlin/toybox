{% extends 'frontend/base.html' %}
{% load static %}

{% block title %}ToyBox - „É≠„Ç∞„Ç§„É≥{% endblock %}

{% block extra_css %}
<style>
    .login-container {
        max-width: 400px;
        margin: 4rem auto;
        padding: 2rem;
        background: var(--steam-iron-900);
        border-radius: 8px;
        border: 1px solid var(--steam-iron-700);
    }
    
    .login-container h1 {
        font-size: 1.5rem;
        color: var(--steam-gold-300);
        margin-bottom: 1.5rem;
        text-align: center;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--steam-gold-300);
        font-size: 0.875rem;
    }
    
    .error {
        color: #dc2626;
        margin-top: 0.5rem;
        font-size: 0.875rem;
        padding: 0.5rem;
        border-radius: 4px;
        background: rgba(220, 38, 38, 0.1);
        border: 1px solid rgba(220, 38, 38, 0.3);
    }
    
    .success {
        color: #16a34a;
        margin-top: 0.5rem;
        font-size: 0.875rem;
        padding: 0.5rem;
        border-radius: 4px;
        background: rgba(22, 163, 74, 0.1);
        border: 1px solid rgba(22, 163, 74, 0.3);
    }
    
    .back-link {
        text-align: center;
        margin-top: 1rem;
    }
    
    .back-link a {
        color: var(--steam-iron-400);
        text-decoration: none;
    }
    
    .back-link a:hover {
        text-decoration: underline;
    }
    
    .penalty-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    
    .penalty-modal.show {
        display: flex;
    }
    
    .penalty-modal-content {
        background: var(--steam-iron-900);
        border: 2px solid var(--steam-gold-300);
        border-radius: 8px;
        padding: 2rem;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    .penalty-modal-header {
        color: var(--steam-gold-300);
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .penalty-modal-header.warning {
        color: #fbbf24;
    }
    
    .penalty-modal-header.suspend {
        color: #f59e0b;
    }
    
    .penalty-modal-header.ban {
        color: #dc2626;
    }
    
    .penalty-modal-body {
        color: var(--steam-iron-100);
        font-size: 1rem;
        line-height: 1.8;
        white-space: pre-wrap;
        margin-bottom: 1.5rem;
    }
    
    .penalty-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }
    
    .penalty-modal-button {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        transition: opacity 0.2s;
    }
    
    .penalty-modal-button:hover {
        opacity: 0.9;
    }
    
    .penalty-modal-button-primary {
        background: var(--steam-gold-500);
        color: #000;
    }
</style>
{% endblock %}

{% block content %}
<div class="login-container">
    <h1>ToyBox</h1>
    <form id="loginForm">
        <div class="form-group">
            <label for="display_id">ID</label>
            <input type="text" id="display_id" name="display_id" required autocomplete="username">
        </div>
        <div class="form-group">
            <label for="password">„Éë„Çπ„ÉØ„Éº„Éâ</label>
            <input type="password" id="password" name="password" required autocomplete="current-password">
        </div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="success" class="success" style="display: none;"></div>
        <button type="submit" class="btn btn-primary" id="submitBtn" style="width: 100%; padding: 0.75rem;">„É≠„Ç∞„Ç§„É≥</button>
    </form>
    <div class="back-link">
        <a href="/">„Éà„ÉÉ„Éó„Éö„Éº„Ç∏„Å´Êàª„Çã</a>
    </div>
</div>

<!-- Ë≠¶Âëä„É°„ÉÉ„Çª„Éº„Ç∏„É¢„Éº„ÉÄ„É´ -->
<div id="penaltyModal" class="penalty-modal">
    <div class="penalty-modal-content">
        <div id="penaltyModalHeader" class="penalty-modal-header"></div>
        <div id="penaltyModalBody" class="penalty-modal-body"></div>
        <div class="penalty-modal-footer">
            <button id="penaltyModalClose" class="penalty-modal-button penalty-modal-button-primary">‰∫ÜËß£„Åó„Åæ„Åó„Åü</button>
        </div>
    </div>
</div>

<script>
    // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´Ë™çË®º„ÉÅ„Çß„ÉÉ„ÇØ
    document.addEventListener('DOMContentLoaded', function() {
        // „ÉÅ„Ç±„ÉÉ„Éà„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØSSOÂá¶ÁêÜ„ÇíÂÑ™ÂÖà
        const urlParams = new URLSearchParams(window.location.search);
        const hasTicket = urlParams.get('ticket');
        
        if (!hasTicket) {
            // „ÉÅ„Ç±„ÉÉ„Éà„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÈÄöÂ∏∏„ÅÆË™çË®º„ÉÅ„Çß„ÉÉ„ÇØ
            redirectIfAuthenticated();
        }
        
        hideLoginPageNavigation();
        checkSSOTicket(); // StudySphere„Åã„Çâ„ÅÆ„ÉÅ„Ç±„ÉÉ„Éà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
    });
    
    // „É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏„Åß„Éò„ÉÉ„ÉÄ„Éº„ÅÆ„Äå„Åø„Çì„Å™„ÅÆÊäïÁ®ø„Äç„ÇíÈùûË°®Á§∫„Å´„Åô„Çã
    function hideLoginPageNavigation() {
        // „Äå„Åø„Çì„Å™„ÅÆÊäïÁ®ø„Äç„É™„É≥„ÇØ„ÇíÈùûË°®Á§∫
        const feedLink = document.querySelector('a[href="/feed/"]');
        if (feedLink) {
            feedLink.style.display = 'none';
        }
    }
    
    function applySSOLoginState(ticket, ssoData, loggedIn) {
        const errorDiv = document.getElementById('error');
        const successDiv = document.getElementById('success');
        const loginForm = document.getElementById('loginForm');

        if (loggedIn) {
            // Êó¢„Å´„Çª„ÉÉ„Ç∑„Éß„É≥„É≠„Ç∞„Ç§„É≥Ê∏à„Åø„Å™„ÅÆ„Åß„ÄÅ„É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥„ÅØ„Éû„Ç§„Éö„Éº„Ç∏„Å∏ÈÅ∑Áßª
            if (loginForm) {
                loginForm.onsubmit = function(e) {
                    e.preventDefault();
                    window.location.href = '/me/';
                };
            }
            if (successDiv) {
                successDiv.textContent = 'StudySphereË™çË®º„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ„É≠„Ç∞„Ç§„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®„Éû„Ç§„Éö„Éº„Ç∏„Å∏ÁßªÂãï„Åó„Åæ„Åô„ÄÇ';
                successDiv.style.display = 'block';
            }
        }

        // „Ç¢„Ç´„Ç¶„É≥„Éà„ÅÇ„Çä ‚Üí ID„Éï„Ç£„Éº„É´„Éâ„Å´Ëá™ÂãïÂÖ•Âäõ„Åó„Å¶„ÄÅ„Éë„Çπ„ÉØ„Éº„Éâ„Å™„Åó„Åß„É≠„Ç∞„Ç§„É≥ÂèØËÉΩ„Å´„Åô„Çã
        console.log('[SSO] Account found, preparing login form...');

        // SSOÊÉÖÂ†±„Çí„Çª„ÉÉ„Ç∑„Éß„É≥„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠òÔºàÊú™„É≠„Ç∞„Ç§„É≥ÊôÇ„ÅÆ„ÅøÔºâ
        if (ssoData && !loggedIn) {
            sessionStorage.setItem('sso_login_data', JSON.stringify({
                ticket: ticket,
                sso_data: ssoData
            }));
        }

        // ID„Éï„Ç£„Éº„É´„Éâ„Å´Ëá™ÂãïÂÖ•Âäõ
        const displayIdInput = document.getElementById('display_id');
        if (displayIdInput && ssoData && ssoData.studysphere_username) {
            // StudySphere„ÅÆusername„ÇíÂ∞èÊñáÂ≠ó„ÉªËã±Êï∞Â≠ó„Éª„Ç¢„É≥„ÉÄ„Éº„Çπ„Ç≥„Ç¢„ÅÆ„Åø„Å´Â§âÊèõ„Åó„Å¶Ëá™ÂãïÂÖ•Âäõ
            const suggestedId = ssoData.studysphere_username
                .toLowerCase()
                .replace(/[^a-z0-9_]/g, '_')
                .substring(0, 30);
            displayIdInput.value = suggestedId;
        }

        // „Éë„Çπ„ÉØ„Éº„Éâ„Éï„Ç£„Éº„É´„Éâ„ÇíÈùûË°®Á§∫„Åæ„Åü„ÅØ„Ç™„Éó„Ç∑„Éß„É≥„Å´„Åô„Çã
        const passwordInput = document.getElementById('password');
        const passwordLabel = passwordInput ? passwordInput.previousElementSibling : null;
        if (passwordInput) {
            passwordInput.required = false;
            passwordInput.placeholder = '„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ‰∏çË¶Å„Åß„ÅôÔºàStudySphereÁµåÁî±Ôºâ';
            passwordInput.style.opacity = '0.5';
        }
        if (passwordLabel) {
            passwordLabel.textContent = '„Éë„Çπ„ÉØ„Éº„ÉâÔºàStudySphereÁµåÁî±„ÅÆ„Åü„ÇÅ‰∏çË¶ÅÔºâ';
        }

        // „Éï„Ç©„Éº„É†„ÇíË°®Á§∫
        if (loginForm) loginForm.style.display = 'block';
        if (successDiv && !loggedIn) {
            successDiv.textContent = 'StudySphere„Ç¢„Ç´„Ç¶„É≥„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü„ÄÇID„ÅåËá™ÂãïÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Äå„É≠„Ç∞„Ç§„É≥„Äç„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
            successDiv.style.display = 'block';
        }

        // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°ÊôÇ„Å´SSO„É≠„Ç∞„Ç§„É≥API„ÇíÂëº„Å≥Âá∫„Åô„Çà„ÅÜ„Å´Â§âÊõ¥ÔºàÊú™„É≠„Ç∞„Ç§„É≥ÊôÇ„ÅÆ„ÅøÔºâ
        if (loginForm && !loggedIn) {
            loginForm.onsubmit = async function(e) {
                e.preventDefault();
                await handleSSOLogin(e);
            };
        }

        if (errorDiv) errorDiv.style.display = 'none';
    }

    // StudySphere„Åã„Çâ„ÅÆSSO„ÉÅ„Ç±„ÉÉ„Éà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
    async function checkSSOTicket() {
        const urlParams = new URLSearchParams(window.location.search);
        const ticket = urlParams.get('ticket');
        
        // „Éá„Éê„ÉÉ„Ç∞Áî®: Ë©≥Á¥∞„Å™ÊÉÖÂ†±„Çí„É≠„Ç∞Âá∫Âäõ
        console.log('[SSO] ========== SSO Debug Info ==========');
        console.log('[SSO] Current URL:', window.location.href);
        console.log('[SSO] URL Search:', window.location.search);
        console.log('[SSO] All URL Parameters:', Object.fromEntries(urlParams));
        console.log('[SSO] Ticket value:', ticket);
        console.log('[SSO] Ticket type:', typeof ticket);
        console.log('[SSO] Ticket length:', ticket ? ticket.length : 0);
        if (ticket) {
            console.log('[SSO] Ticket preview (first 20 chars):', ticket.substring(0, 20) + '...');
        }
        console.log('[SSO] ====================================');
        
        if (!ticket) {
            console.log('[SSO] No ticket found in URL parameters');
            return; // „ÉÅ„Ç±„ÉÉ„Éà„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÈÄöÂ∏∏„ÅÆ„É≠„Ç∞„Ç§„É≥ÁîªÈù¢
        }
        
        const errorDiv = document.getElementById('error');
        const successDiv = document.getElementById('success');
        const submitBtn = document.getElementById('submitBtn');
        const loginForm = document.getElementById('loginForm');

        // Êó¢„Å´Ê§úË®ºÊ∏à„Åø„ÅÆ„ÉÅ„Ç±„ÉÉ„Éà„ÅØÂÜçÊ§úË®º„Åó„Å™„ÅÑ
        const cachedTicket = sessionStorage.getItem('sso_verified_ticket');
        const cachedLoginDataStr = sessionStorage.getItem('sso_login_data');
        const cachedLoggedIn = sessionStorage.getItem('sso_logged_in');
        if (cachedTicket && cachedTicket === ticket && cachedLoginDataStr) {
            try {
                const cachedLoginData = JSON.parse(cachedLoginDataStr);
                applySSOLoginState(ticket, cachedLoginData.sso_data, cachedLoggedIn === 'true');
                return;
            } catch (err) {
                console.error('[SSO] Failed to parse cached login data:', err);
            }
        }
        
        // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
        if (loginForm) loginForm.style.display = 'none';
        if (successDiv) {
            successDiv.textContent = 'StudySphere„Åã„ÇâÈÄ£Êê∫‰∏≠...';
            successDiv.style.display = 'block';
        }
        
        try {
            console.log('[SSO] Calling verify-and-check API...');
            const response = await fetch(`/sso/verify-and-check/?ticket=${encodeURIComponent(ticket)}`, {
                method: 'GET',
            });
            
            console.log('[SSO] API response status:', response.status);
            const data = await response.json();
            console.log('[SSO] API response data:', data);
            
            if (!response.ok) {
                // „Ç®„É©„Éº
                console.error('[SSO] API error:', data.error);
                if (errorDiv) {
                    errorDiv.textContent = data.error || 'SSOË™çË®º„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
                    errorDiv.style.display = 'block';
                }
                if (successDiv) successDiv.style.display = 'none';
                if (loginForm) loginForm.style.display = 'block';
                return;
            }
            
            if (data.has_account) {
                const hasTokens = !!data.access;
                if (hasTokens) {
                    setAccessToken(data.access);
                    if (data.refresh) {
                        setRefreshToken(data.refresh);
                    }
                }
                // ÂÜçÊ§úË®ºÈò≤Ê≠¢Áî®„Å´‰øùÂ≠ò
                sessionStorage.setItem('sso_verified_ticket', ticket);
                sessionStorage.setItem('sso_logged_in', (data.logged_in || hasTokens) ? 'true' : 'false');
                applySSOLoginState(ticket, data.sso_data, !!(data.logged_in || hasTokens));
            } else if (data.sso_data) {
                // „Ç¢„Ç´„Ç¶„É≥„Éà„Å™„Åó ‚Üí ÁôªÈå≤ÁîªÈù¢„Å∏
                console.log('[SSO] No account found, redirecting to signup...');
                console.log('[SSO] SSO data:', data.sso_data);
                
                // SSOÊÉÖÂ†±„Çí„Çª„ÉÉ„Ç∑„Éß„É≥„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
                sessionStorage.setItem('sso_signup_data', JSON.stringify(data.sso_data));
                sessionStorage.setItem('sso_verified_ticket', ticket);
                console.log('[SSO] Saved to sessionStorage');
                
                if (successDiv) {
                    successDiv.textContent = 'StudySphere„Ç¢„Ç´„Ç¶„É≥„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü„ÄÇ„Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàêÁîªÈù¢„Å∏ÁßªÂãï„Åó„Åæ„Åô...';
                    successDiv.style.display = 'block';
                }
                
                console.log('[SSO] Redirecting to /signup/?from=sso in 1.5s');
                setTimeout(() => {
                    console.log('[SSO] Executing redirect now');
                    window.location.href = '/signup/?from=sso';
                }, 1500);
            } else {
                console.error('[SSO] Unexpected response structure:', data);
                if (errorDiv) {
                    errorDiv.textContent = '‰∫àÊúü„Åó„Å™„ÅÑÂøúÁ≠îÂΩ¢Âºè„Åß„Åô';
                    errorDiv.style.display = 'block';
                }
                if (successDiv) successDiv.style.display = 'none';
                if (loginForm) loginForm.style.display = 'block';
            }
        } catch (err) {
            console.error('[SSO] check error:', err);
            if (errorDiv) {
                errorDiv.textContent = 'SSOË™çË®º‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + err.message;
                errorDiv.style.display = 'block';
            }
            if (successDiv) successDiv.style.display = 'none';
            if (loginForm) loginForm.style.display = 'block';
        }
    }
    
    // SSOÁµåÁî±„ÅÆ„É≠„Ç∞„Ç§„É≥Âá¶ÁêÜ
    async function handleSSOLogin(e) {
        e.preventDefault();
        
        const ssoLoginDataStr = sessionStorage.getItem('sso_login_data');
        if (!ssoLoginDataStr) {
            // SSOÊÉÖÂ†±„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÈÄöÂ∏∏„ÅÆ„É≠„Ç∞„Ç§„É≥Âá¶ÁêÜ
            handleNormalLogin(e);
            return;
        }
        
        const ssoLoginData = JSON.parse(ssoLoginDataStr);
        const ticket = ssoLoginData.ticket;
        const displayId = document.getElementById('display_id').value.trim();
        
        if (!displayId) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = 'ID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
            errorDiv.style.display = 'block';
            return;
        }
        
        const errorDiv = document.getElementById('error');
        const successDiv = document.getElementById('success');
        const submitBtn = document.getElementById('submitBtn');
        
        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';
        submitBtn.disabled = true;
        submitBtn.textContent = '„É≠„Ç∞„Ç§„É≥‰∏≠...';
        
        try {
            const response = await fetch('/sso/login-with-ticket/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    display_id: displayId,
                    ticket: ticket
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.access) {
                setAccessToken(data.access);
                if (data.refresh) {
                    setRefreshToken(data.refresh);
                }
                
                // SSOÊÉÖÂ†±„Çí„ÇØ„É™„Ç¢
                sessionStorage.removeItem('sso_login_data');
                
                // Ë≠¶Âëä„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØË°®Á§∫
                if (data.penalty && data.penalty.message) {
                    showPenaltyModal(data.penalty.type, data.penalty.message);
                } else {
                    const redirectUrl = (data.user && data.user.role === 'FREE_USER') ? '/upgrade/' : '/me/';
                    const redirectMessage = (data.user && data.user.role === 'FREE_USER') 
                        ? '„É≠„Ç∞„Ç§„É≥ÊàêÂäüÔºÅË™≤Èáë„Å´„Å§„ÅÑ„Å¶„ÅÆ„Éö„Éº„Ç∏„Å∏ÁßªÂãï„Åó„Åæ„Åô...' 
                        : '„É≠„Ç∞„Ç§„É≥ÊàêÂäüÔºÅ„Éû„Ç§„Éö„Éº„Ç∏„Å∏ÁßªÂãï„Åó„Åæ„Åô...';
                    
                    successDiv.textContent = redirectMessage;
                    successDiv.style.display = 'block';
                    setTimeout(() => {
                        window.location.href = redirectUrl;
                    }, 1000);
                }
            } else {
                errorDiv.textContent = data.error || '„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
                errorDiv.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = '„É≠„Ç∞„Ç§„É≥';
            }
        } catch (err) {
            errorDiv.textContent = '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + err.message;
            errorDiv.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = '„É≠„Ç∞„Ç§„É≥';
        }
    }
    
    // ÈÄöÂ∏∏„ÅÆ„É≠„Ç∞„Ç§„É≥Âá¶ÁêÜ
    async function handleNormalLogin(e) {
        e.preventDefault();
        
        const displayId = document.getElementById('display_id').value;
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('error');
        const successDiv = document.getElementById('success');
        const submitBtn = document.getElementById('submitBtn');
        
        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';
        submitBtn.disabled = true;
        submitBtn.textContent = '„É≠„Ç∞„Ç§„É≥‰∏≠...';
        
        try {
            const response = await fetch('/api/auth/login/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    display_id: displayId,
                    password: password
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.access) {
                setAccessToken(data.access);
                if (data.refresh) {
                    setRefreshToken(data.refresh);
                }
                
                // Ë≠¶Âëä„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØË°®Á§∫
                if (data.penalty && data.penalty.message) {
                    showPenaltyModal(data.penalty.type, data.penalty.message);
                } else {
                    // „É≠„Éº„É´„Å´Âøú„Åò„Å¶„É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÂÖà„ÇíÊ±∫ÂÆö
                    // „Éá„Éê„ÉÉ„Ç∞Áî®: „É≠„Éº„É´ÊÉÖÂ†±„ÇíÁ¢∫Ë™ç
                    console.log('Login response:', data);
                    console.log('User role:', data.role);
                    
                    const redirectUrl = (data.role === 'FREE_USER') ? '/upgrade/' : '/me/';
                    const redirectMessage = (data.role === 'FREE_USER') 
                        ? '„É≠„Ç∞„Ç§„É≥ÊàêÂäüÔºÅË™≤Èáë„Å´„Å§„ÅÑ„Å¶„ÅÆ„Éö„Éº„Ç∏„Å∏ÁßªÂãï„Åó„Åæ„Åô...' 
                        : '„É≠„Ç∞„Ç§„É≥ÊàêÂäüÔºÅ„Éû„Ç§„Éö„Éº„Ç∏„Å∏ÁßªÂãï„Åó„Åæ„Åô...';
                    
                    successDiv.textContent = redirectMessage;
                    successDiv.style.display = 'block';
                    setTimeout(() => {
                        console.log('Redirecting to:', redirectUrl);
                        window.location.href = redirectUrl;
                    }, 1000);
                }
            } else {
                errorDiv.textContent = data.detail || data.non_field_errors?.[0] || '„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
                errorDiv.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = '„É≠„Ç∞„Ç§„É≥';
            }
        } catch (err) {
            errorDiv.textContent = '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
            errorDiv.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = '„É≠„Ç∞„Ç§„É≥';
        }
    }
    
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        // SSOÁµåÁî±„ÅÆÂ†¥Âêà„ÅØhandleSSOLogin„ÄÅ„Åù„ÅÜ„Åß„Å™„ÅÑÂ†¥Âêà„ÅØhandleNormalLogin
        const ssoLoginDataStr = sessionStorage.getItem('sso_login_data');
        if (ssoLoginDataStr) {
            await handleSSOLogin(e);
        } else {
            await handleNormalLogin(e);
        }
    });
    
    function showPenaltyModal(type, message) {
        const modal = document.getElementById('penaltyModal');
        const header = document.getElementById('penaltyModalHeader');
        const body = document.getElementById('penaltyModalBody');
        const closeBtn = document.getElementById('penaltyModalClose');
        
        // „Çø„Ç§„Éó„Å´Âøú„Åò„Åü„Éò„ÉÉ„ÉÄ„Éº„ÇíË®≠ÂÆö
        let headerText = '';
        let headerClass = '';
        if (type === 'WARNING') {
            headerText = '‚ö†Ô∏è Ë≠¶Âëä';
            headerClass = 'warning';
        } else if (type === 'SUSPEND') {
            headerText = '‚õî „Ç¢„Ç´„Ç¶„É≥„ÉàÂÅúÊ≠¢';
            headerClass = 'suspend';
        } else if (type === 'BAN') {
            headerText = 'üö´ BANÔºà„Ç¢„Ç´„Ç¶„É≥„ÉàÂâäÈô§Ôºâ';
            headerClass = 'ban';
        } else {
            headerText = '‚ö†Ô∏è „ÅäÁü•„Çâ„Åõ';
            headerClass = 'warning';
        }
        
        header.textContent = headerText;
        header.className = 'penalty-modal-header ' + headerClass;
        body.textContent = message;
        
        modal.classList.add('show');
        
        // Èñâ„Åò„Çã„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà
        closeBtn.onclick = function() {
            modal.classList.remove('show');
            
            // „Çø„Ç§„Éó„Å´Âøú„Åò„Å¶Áï∞„Å™„ÇãÂá¶ÁêÜ
            if (type === 'WARNING') {
                // Ë≠¶Âëä„ÅÆÂ†¥Âêà„ÅØ„Éû„Ç§„Éö„Éº„Ç∏„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
                const successDiv = document.getElementById('success');
                successDiv.textContent = '„É≠„Ç∞„Ç§„É≥ÊàêÂäüÔºÅ„Éû„Ç§„Éö„Éº„Ç∏„Å∏ÁßªÂãï„Åó„Åæ„Åô...';
                successDiv.style.display = 'block';
                setTimeout(() => {
                    window.location.href = '/me/';
                }, 500);
            } else if (type === 'SUSPEND' || type === 'BAN') {
                // „Ç¢„Ç´„Ç¶„É≥„ÉàÂÅúÊ≠¢„Åæ„Åü„ÅØBAN„ÅÆÂ†¥Âêà„ÅØ„Éà„Éº„ÇØ„É≥„ÇíÂâäÈô§„Åó„Å¶„É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏„Å´Êàª„Çã
                clearAuth();
                const errorDiv = document.getElementById('error');
                if (type === 'SUSPEND') {
                    errorDiv.textContent = '„Ç¢„Ç´„Ç¶„É≥„Éà„ÅåÂÅúÊ≠¢„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏„Å´Êàª„Çä„Åæ„Åô„ÄÇ';
                } else {
                    errorDiv.textContent = '„Ç¢„Ç´„Ç¶„É≥„Éà„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„Åü„ÄÇ„É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏„Å´Êàª„Çä„Åæ„Åô„ÄÇ';
                }
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    window.location.href = '/login/';
                }, 2000);
            }
        };
        
        // „É¢„Éº„ÉÄ„É´Â§ñ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„ÇÇÈñâ„Åò„Å™„ÅÑÔºàÈáçË¶Å„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ„Åü„ÇÅÔºâ
    }
</script>
{% endblock %}

