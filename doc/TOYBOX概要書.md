## TOYBOX 概要書

最終更新: 2025-12-18  
対象: 企画/運用/開発（新規参加者が「何のプロダクトで、何ができて、どう動いているか」を短時間で把握するための資料）
想定読者: 社内向け（運用・開発） / 社外向け（概要説明・協業/採用/紹介）

---

## 1. プロダクト概要

TOYBOX は **投稿（画像/動画/ゲーム）** を起点に、**抽選（ジャックポット）** と **称号・カード収集（ゲーミフィケーション）** を組み合わせて、継続的な創作・参加を促す Web アプリです。  
また、**Discord シェア** や **お知らせ/問い合わせ** など、コミュニティ運用に必要な周辺機能を備えています。

### 1.1 提供価値（要約）
- **投稿の継続**: 抽選・称号・カード付与により「出すほど楽しい」を作る
- **コミュニティ性**: フィード/タイムライン/ランキング/Discord共有で回遊を作る
- **AI生成スキルの習得**: 「投稿する楽しみ（SNS体験）」の中で、自然に AI 生成のスキルを身につけていく
- **運用性**: 管理画面（Django Admin + adminpanel）、問い合わせ/通報導線、規約同意フロー

### 1.2 公開範囲・提供形態
- **社内限定（招待制）**: 原則として社内ユーザー向けに提供
- **会社との直接やり取り**: 課金/利用継続/問い合わせ等は、会社との直接コミュニケーションを前提に運用

---

## 2. 現行システム（正）とレガシー（参考）の区別

### 2.1 現行（正）
現行の実装は **Django 5 + DRF + PostgreSQL + Celery + Redis** を前提とします。
- 入口: `README.md`
- バックエンド開発ガイド: `backend/README_DJANGO.md`

### 2.2 レガシー（参考）
過去に Next.js/Express(MongoDB) 構成で検討・実装されていた痕跡が `doc/legacy/` に保存されています。  
また、`doc/toybox仕様.md` や `doc/作業工程.md`、`ホスティング.md` などには **旧構成の記述が混在**するため、参照時は「現行Django版の前提か」を必ず確認してください。

---

## 3. 主要機能（機能一覧）

### 3.1 ユーザー/認証
- ユーザー登録・ログイン（JWT）
- ユーザーロール: `FREE_USER` / `PAID_USER` / `ADMIN` / `SUPERUSER`
- プロフィール（表示名、bio、ヘッダー、アバター等）
- Discord OAuth 連携（トークン保持・ステータス確認）

### 3.2 投稿（Submissions）
- 投稿作成（画像/動画/ゲームZIP などの提出を想定）
- フィード（新着、人気、ハッシュタグ）
- ユーザー別投稿一覧
- いいね相当のリアクション（`Reaction`）
- ソフトデリート（`deleted_at`）対応

### 3.3 抽選（Lottery）
- ジャックポット抽選ルール（基本確率/増分/上限/日次上限などをルール化）
- 当選履歴（`JackpotWin`）

### 3.4 ゲーミフィケーション（Gamification）
- 称号マスター（期間付き、画像/URL対応）
- カードマスター（レアリティ・画像/URL対応）
- ユーザーのカード所持（同一カード複数枚を許容）

### 3.5 シェア/運用導線
- Discord 共有の記録（チャンネル/メッセージID）
- お知らせ（一覧/詳細/API）
- 問い合わせ（課金問い合わせ）・通報（規約違反/不具合など）

---

## 4. 画面構成（Django Templates）

ユーザーがブラウザでアクセスする画面は Django テンプレートで提供されます。

### 4.1 ページ一覧（代表）
- `/` : トップ
- `/login/` : ログイン
- `/signup/` : 登録
- `/feed/` : フィード（要ログイン、課金ユーザーは規約同意が必要）
- `/me/` : マイページ（要ログイン、**FREE_USERは閲覧不可**。課金ユーザーは規約同意が必要）
- `/lottery/` : 抽選（要ログイン、課金ユーザーは規約同意が必要）
- `/collection/` : コレクション（要ログイン、課金ユーザーは規約同意が必要）
- `/profile/` : プロフィール編集（要ログイン、課金ユーザーは規約同意が必要）
- `/profile/view/` : プロフィール閲覧
- `/upgrade/` : 一般ユーザー向けの課金問い合わせ導線
- `/terms/` / `/terms/agree/` : 利用規約・同意フロー
- `/announcements/` : お知らせ一覧
- `/inquiry/` : お問い合わせ/通報フォーム

### 4.2 代表導線（例）
- **初回導線（招待制運用の想定）**: `/` → `/signup/` → `/login/` →（権限に応じて）`/me/` or `/upgrade/`
- **投稿→反映**: 投稿API → `/feed/` で閲覧 → 反応（リアクション） → 人気フィード等に反映
- **課金ユーザーの必須導線**: `/terms/agree/` 同意完了後に `/me/` `/feed/` などへ遷移

---

## 5. API 概要（DRF）

API は主に `/api/` 配下に集約されています。詳細な一覧は `backend/README_DJANGO.md` の「APIエンドポイント」を参照してください。

### 5.1 主なAPIカテゴリ
- **認証**: `/api/auth/*`
- **ユーザー**: `/api/user/*`（プロフィール取得/更新、通知など）
- **投稿**: `/api/submit/`, `/api/feed/`, `/api/submissions/*`
- **抽選**: `/api/lottery/*`
- **カード**: `/api/cards/*`
- **シェア**: `/api/share/*`
- **ヘルスチェック**: `/api/health/*`

---

## 6. データモデル（主要テーブル/概念）

### 6.1 Users
- `users`: ユーザー本体（role、停止/警告、表示IDなど）
- `user_meta`: 付帯情報（称号、期限、プロフィール、通知、規約同意日時、Discordトークン等）
- `user_cards`: ユーザーのカード所持履歴

### 6.2 Submissions
- `submissions`: 投稿（画像/サムネ/タイトル/キャプション/タグ、公開状態、ソフトデリート）
- `reactions`: 投稿へのリアクション（重複禁止のユニーク制約あり）

### 6.3 Lottery / Gamification / Sharing
- `lottery_rules`: 抽選ルール（基本確率など）
- `jackpot_wins`: 当選履歴
- `titles`: 称号マスター
- `cards`: カードマスター
- `discord_shares`: Discord共有の記録

---

## 7. アーキテクチャ概要

### 7.1 論理構成（概念図）
```
[Browser]
  |  Django Templates (HTML)
  |  /api/* (JSON)
  v
[Django + DRF]
  |  ORM
  v
[PostgreSQL]

非同期処理:
[Django] -> [Celery] -> [Redis] -> (Worker/Beat)
```

### 7.2 実行環境（開発/本番）
- Docker Compose で `db`（PostgreSQL）+ `redis` + `web`（Django）+ `worker` + `beat` を起動可能
- 本番はリバースプロキシ（Caddy）を前提に運用（ドキュメント参照）

---

## 8. 運用/デプロイ概要

### 8.1 ローカル起動（推奨ルート）
- `README.md` の「クイックスタート」
- `backend/README_DJANGO.md` の「Dockerでの起動」

### 8.2 本番デプロイ
- `DEPLOYMENT_GUIDE.md`（自動デプロイ/Secrets/確認方法）

### 8.3 監視・ヘルスチェック
- `GET /api/health/`（ヘルスチェック）
- `GET /api/health/ready/`（レディネスチェック）

---

## 9. セキュリティ/権限制御（概要）

- 管理画面URLは `ADMIN_URL`（環境変数）で変更可能（スキャン対策）
- ロール（FREE/PAID/ADMIN/SUPERUSER）による画面制御あり
  - 例: **FREE_USER は `/me/` に入れず `/upgrade/` へ誘導**
  - 例: **PAID_USER は規約同意前に主要画面へ入れない**

---

## 10. KPI（現行方針）

### 10.1 最重要KPI
- **ユーザー**（例: 招待ユーザー数 / 登録ユーザー数 / MAU・WAU・DAU など、どれを「ユーザー」と定義するかは運用で確定）

---

## 11. 既知の論点（要確認・概要書の空欄になりやすい項目）

以下はコード/既存ドキュメントだけでは断定しづらく、運用方針として確定が必要な項目です。
- **投稿のガイドライン**（禁止事項、モデレーション基準、通報対応フロー）
- **招待の運用**（招待の発行元、失効、上限、監査ログの要否）
- **課金/権限付与の運用**（会社との直接やりとりでの `PAID_USER` 付与手順、退会/失効時の扱い）
- **「ユーザー」KPI の定義**（登録/アクティブ/継続のどれを一次指標にするか）

---

## 12. 社外共有時の注意（チェックリスト）

社外向けに共有する場合は、以下の情報が含まれていないか確認してください（必要に応じてマスキング）。
- **インフラの具体**（サーバーIP、内部ドメイン、接続情報、構成の詳細すぎる記述）
- **運用の機微**（内部ルール、モデレーション手順の詳細、管理URLの推測材料）
- **秘密情報**（環境変数の具体値、認証情報、鍵、メール設定の実値など）

---

## 付録: 参照先

- `README.md`（全体の入口）
- `backend/README_DJANGO.md`（バックエンドの詳細）
- `CURRENT_STATUS.md`（現在の課題と状況）
- `DEPLOYMENT_GUIDE.md`（自動デプロイ）
- `doc/`（レガシー含む各種ドキュメント）


