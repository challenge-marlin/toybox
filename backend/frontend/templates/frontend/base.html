{% load static %}
<!DOCTYPE html>
<html lang="ja" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}TOYBOX！{% endblock %}</title>
    
    <!-- OGP / Meta Tags -->
    <meta name="description" content="{% block description %}TOYBOX！ - 創造の遊び場。ゲーム、画像、動画を作って共有しよう！{% endblock %}">
    <meta property="og:type" content="{% block og_type %}website{% endblock %}">
    <meta property="og:title" content="{% block og_title %}{% block title_plain %}TOYBOX！{% endblock %}{% endblock %}">
    <meta property="og:description" content="{% block og_description %}TOYBOX！ - 創造の遊び場。ゲーム、画像、動画を作って共有しよう！{% endblock %}">
    <meta property="og:url" content="{% block og_url %}{{ request.build_absolute_uri }}{% endblock %}">
    <meta property="og:site_name" content="TOYBOX！">
    <meta property="og:image" content="{% block og_image %}https://toybox.ayatori-inc.co.jp/static/frontend/hero/toybox-ogp.png{% endblock %}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="TOYBOX！ - 創造の遊び場">
    <meta property="og:locale" content="ja_JP">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{% block twitter_title %}{% block title_plain2 %}TOYBOX！{% endblock %}{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}TOYBOX！ - 創造の遊び場。ゲーム、画像、動画を作って共有しよう！{% endblock %}">
    <meta name="twitter:image" content="{% block twitter_image %}https://toybox.ayatori-inc.co.jp/static/frontend/hero/toybox-ogp.png{% endblock %}">
    <meta name="twitter:image:alt" content="TOYBOX！ - 創造の遊び場">
    
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <script>
        // ページ読み込み前にテーマを適用（FOUC防止）
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    <link rel="stylesheet" href="{% static 'frontend/css/base.css' %}">
    <script src="{% static 'frontend/js/auth.js' %}"></script>
    <script src="{% static 'frontend/js/common/api.js' %}?v=20260114-1"></script>
    <script src="{% static 'frontend/js/common/errors.js' %}?v=20260114-1"></script>
    <script src="{% static 'frontend/js/common/utils.js' %}?v=20260114-1"></script>
    {% block extra_css %}{% endblock %}
</head>
<body>
    <header class="header-nav" style="border-bottom: 1px solid var(--steam-iron-800); background: rgba(31, 35, 42, 0.7);">
        <div class="container" style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; font-size: 0.875rem; max-width: 1200px; margin: 0 auto;">
            <nav style="display: flex; align-items: center; gap: 1rem;">
                <a href="/" id="logo-link" style="display: flex; align-items: center;">
                    <img src="{% static 'frontend/hero/toybox-title.png' %}" alt="ToyBox" style="height: 2rem; width: auto;">
                </a>
                <a href="/me/" id="nav-me" style="color: var(--steam-gold-400); text-decoration: none; display: none;">マイページ</a>
                <a href="/collection/" id="nav-collection" style="color: var(--steam-gold-400); text-decoration: none; display: none;">コレクション</a>
                <a href="/profile/view/" id="nav-profile" style="color: var(--steam-gold-400); text-decoration: none; display: none;">プロフィール</a>
                <a href="/feed/" style="color: var(--steam-gold-400); text-decoration: none;">みんなの投稿</a>
                <a href="/login/" id="nav-login" style="color: var(--steam-gold-400); text-decoration: none;">ログイン</a>
            </nav>
            <div id="user-info" style="display: flex; align-items: center; gap: 0.75rem; color: var(--steam-iron-200); display: none;">
                <div id="notification-container" style="position: relative; display: none;">
                    <button id="notification-button" onclick="toggleNotifications()" style="position: relative; background: transparent; border: none; padding: 0.25rem 0.5rem; cursor: pointer; color: var(--steam-gold-300); border-radius: 9999px;" aria-label="通知">
                        <svg aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: block;">
                            <path d="M18 8a6 6 0 10-12 0c0 7-3 9-3 9h18s-3-2-3-9" />
                            <path d="M13.73 21a2 2 0 01-3.46 0" />
                        </svg>
                        <span id="notification-badge" style="position: absolute; top: -4px; right: -4px; background: #dc2626; color: white; border-radius: 50%; font-size: 10px; min-width: 18px; height: 18px; display: none; align-items: center; justify-content: center; padding: 0 4px; font-weight: bold;">0</span>
                    </button>
                    <div id="notification-dropdown" style="display: none; position: absolute; right: 0; top: 100%; margin-top: 0.5rem; width: 288px; background: var(--steam-iron-900); border: 1px solid var(--steam-iron-700); border-radius: 4px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); z-index: 50;">
                        <div id="notification-list" style="max-height: 320px; overflow-y: auto; border-bottom: 1px solid var(--steam-iron-800);">
                            <div style="padding: 0.75rem; text-align: center; color: var(--steam-iron-300); font-size: 0.75rem;">読み込み中...</div>
                        </div>
                        <div style="padding: 0.5rem; text-align: right; border-top: 1px solid var(--steam-iron-800);">
                            <button id="load-more-notifications" onclick="loadMoreNotifications()" style="display: none; background: transparent; border: none; color: var(--steam-gold-300); font-size: 11px; cursor: pointer; text-decoration: underline;">もっと見る</button>
                            <span id="notification-all-shown" style="display: none; color: var(--steam-iron-300); font-size: 11px;">すべて表示</span>
                        </div>
                    </div>
                </div>
                <div id="user-menu-container" style="position: relative;">
                    <button id="user-menu-button" onclick="toggleUserMenu()" style="background: transparent; border: none; padding: 0.25rem; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'" aria-label="ユーザーメニュー">
                        <img id="user-avatar-img" src="" alt="ユーザーアバター" style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--steam-gold-400); object-fit: cover; display: none;">
                        <svg id="user-avatar-icon" aria-hidden="true" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--steam-gold-300)" stroke-width="2" style="display: block;">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                            <circle cx="12" cy="7" r="4" />
                        </svg>
                    </button>
                    <div id="user-menu-dropdown" style="display: none; position: absolute; right: 0; top: 100%; margin-top: 0.5rem; width: 200px; background: var(--steam-iron-900); border: 1px solid var(--steam-iron-700); border-radius: 4px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); z-index: 50; overflow: hidden;">
                        <a href="/profile/" style="display: block; padding: 0.75rem 1rem; color: var(--steam-iron-100); text-decoration: none; border-bottom: 1px solid var(--steam-iron-800); transition: background 0.2s;" onmouseover="this.style.background='var(--steam-iron-800)'" onmouseout="this.style.background='transparent'">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                                    <circle cx="12" cy="7" r="4" />
                                </svg>
                                <span>プロフィール設定</span>
                            </div>
                        </a>
                        <a id="studysphere-link-header" href="https://studysphere.ayatori-inc.co.jp/student/dashboard" target="_blank" rel="noopener noreferrer" style="display: block; padding: 0.75rem 1rem; color: var(--steam-iron-100); text-decoration: none; border-bottom: 1px solid var(--steam-iron-800); transition: background 0.2s;" onmouseover="this.style.background='var(--steam-iron-800)'" onmouseout="this.style.background='transparent'">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                    <polyline points="15 3 21 3 21 9"></polyline>
                                    <line x1="10" y1="14" x2="21" y2="3"></line>
                                </svg>
                                <span>StudySphereへ移動</span>
                            </div>
                        </a>
                        <button id="theme-toggle-btn" onclick="toggleTheme()" style="display: block; width: 100%; padding: 0.75rem 1rem; color: var(--steam-iron-100); text-decoration: none; border: none; background: transparent; text-align: left; cursor: pointer; border-bottom: 1px solid var(--steam-iron-800); transition: background 0.2s;" onmouseover="this.style.background='var(--steam-iron-800)'" onmouseout="this.style.background='transparent'">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <svg id="theme-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="5" />
                                    <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
                                </svg>
                                <span id="theme-toggle-text">ライトモード</span>
                            </div>
                        </button>
                        <a href="/login/" onclick="event.preventDefault(); clearAuth(); window.location.replace('/login/'); return false;" style="display: block; padding: 0.75rem 1rem; color: var(--steam-iron-100); text-decoration: none; transition: background 0.2s;" onmouseover="this.style.background='var(--steam-iron-800)'" onmouseout="this.style.background='transparent'">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                                    <polyline points="16 17 21 12 16 7" />
                                    <line x1="21" y1="12" x2="9" y2="12" />
                                </svg>
                                <span>ログアウト</span>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <main id="main-content">
        {% block content %}{% endblock %}
    </main>
    
    {% block extra_js %}{% endblock %}
    <script>
        // 通知機能の変数（グローバルスコープ）
        let notificationItems = [];
        let notificationNextOffset = null;
        let notificationUnread = 0;
        let notificationDropdownOpen = false;
        
        // 通知機能の関数（グローバルスコープ）
        function loadNotifications() {
            const token = getAccessToken();
            if (!token) return;
            
            fetch('/api/users/notifications/?limit=10', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                }
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                // APIレスポンス形式に対応（items/unread または notifications/unreadCount）
                notificationItems = data.items || data.notifications || [];
                notificationUnread = data.unread !== undefined ? data.unread : (data.unreadCount || 0);
                notificationNextOffset = data.nextOffset || null;
                
                updateNotificationBadge();
                if (notificationDropdownOpen) {
                    renderNotifications();
                }
            })
            .catch(err => {
                console.error('Failed to load notifications:', err);
                // エラーが発生してもバッジは非表示のままにする
                notificationUnread = 0;
                updateNotificationBadge();
            });
        }
        
        function updateNotificationBadge() {
            const badge = document.getElementById('notification-badge');
            if (badge) {
                if (notificationUnread > 0) {
                    badge.textContent = notificationUnread > 99 ? '99+' : String(notificationUnread);
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        function renderNotifications() {
            const list = document.getElementById('notification-list');
            const loadMoreBtn = document.getElementById('load-more-notifications');
            const allShown = document.getElementById('notification-all-shown');
            
            if (!list) return;
            
            if (notificationItems.length === 0) {
                list.innerHTML = '<div style="padding: 0.75rem; text-align: center; color: var(--steam-iron-300); font-size: 0.75rem;">通知はありません</div>';
            } else {
                list.innerHTML = notificationItems.map((n, i) => {
                    const date = new Date(n.createdAt);
                    return `<div style="padding: 0.75rem; border-bottom: 1px solid var(--steam-iron-800); ${i === notificationItems.length - 1 ? 'border-bottom: none;' : ''}">
                        <div style="font-weight: 600; color: var(--steam-gold-300); font-size: 0.75rem; margin-bottom: 0.25rem;">${n.message || ''}</div>
                        <div style="color: var(--steam-iron-300); font-size: 10px;">${date.toLocaleString('ja-JP')}</div>
                    </div>`;
                }).join('');
            }
            
            if (loadMoreBtn && allShown) {
                if (notificationNextOffset !== null) {
                    loadMoreBtn.style.display = 'inline';
                    allShown.style.display = 'none';
                } else {
                    loadMoreBtn.style.display = 'none';
                    allShown.style.display = 'inline';
                }
            }
        }
        
        function toggleNotifications() {
            notificationDropdownOpen = !notificationDropdownOpen;
            const dropdown = document.getElementById('notification-dropdown');
            if (dropdown) {
                dropdown.style.display = notificationDropdownOpen ? 'block' : 'none';
                if (notificationDropdownOpen) {
                    renderNotifications();
                    // 開いた時に既読にする
                    if (notificationUnread > 0) {
                        markNotificationsAsRead();
                    }
                }
            }
        }
        
        function loadMoreNotifications() {
            if (notificationNextOffset === null) return;
            
            const token = getAccessToken();
            if (!token) return;
            
            fetch(`/api/users/notifications/?limit=10&offset=${notificationNextOffset}`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                }
            })
            .then(res => res.json())
            .then(data => {
                notificationItems = [...notificationItems, ...(data.items || [])];
                notificationNextOffset = data.nextOffset || null;
                renderNotifications();
            })
            .catch(err => console.error('Failed to load more notifications:', err));
        }
        
        function markNotificationsAsRead() {
            const token = getAccessToken();
            if (!token) return;
            
            fetch('/api/users/notifications/read/', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    notificationUnread = 0;
                    updateNotificationBadge();
                    // 通知アイテムも既読状態に更新
                    notificationItems.forEach(n => n.read = true);
                }
            })
            .catch(err => console.error('Failed to mark notifications as read:', err));
        }
        
        // ナビゲーションの認証状態に応じた表示切り替えと通知読み込み
        document.addEventListener('DOMContentLoaded', function() {
            const isAuthenticated = hasValidToken();
            const logoLink = document.getElementById('logo-link');
            const navMe = document.getElementById('nav-me');
            const navCollection = document.getElementById('nav-collection');
            const navProfile = document.getElementById('nav-profile');
            const navLogin = document.getElementById('nav-login');
            const userInfo = document.getElementById('user-info');
            
            if (isAuthenticated) {
                // ログイン済みの場合
                if (logoLink) logoLink.href = '/me/';
                if (navMe) navMe.style.display = 'inline';
                if (navCollection) navCollection.style.display = 'inline';
                if (navProfile) navProfile.style.display = 'inline';
                if (navLogin) navLogin.style.display = 'none';
                if (userInfo) userInfo.style.display = 'flex';
                
                const notificationContainer = document.getElementById('notification-container');
                if (notificationContainer) notificationContainer.style.display = 'block';
                
                // ユーザー情報を取得して表示
                fetch('/api/users/me/meta/', {
                    headers: {
                        'Authorization': `Bearer ${getAccessToken()}`,
                    }
                })
                .then(res => res.json())
                .then(data => {
                    // ユーザーアバター画像を設定
                    console.log('[Profile Image Debug] base.html - API Response:', {
                        avatar_url: data.avatar_url,
                        fullData: data
                    });
                    
                    const avatarImg = document.getElementById('user-avatar-img');
                    const avatarIcon = document.getElementById('user-avatar-icon');
                    const avatarUrl = data.avatar_url;
                    console.log('[Profile Image Debug] base.html - Avatar URL:', avatarUrl);
                    
                    if (avatarUrl && avatarImg && avatarIcon) {
                        console.log('[Profile Image Debug] base.html - Setting header avatar image:', avatarUrl);
                        avatarImg.src = avatarUrl;
                        avatarImg.style.display = 'block';
                        avatarIcon.style.display = 'none';
                        avatarImg.onerror = function() {
                            console.error('[Profile Image Debug] base.html - Header avatar image load error:', avatarUrl);
                            avatarImg.style.display = 'none';
                            avatarIcon.style.display = 'block';
                        };
                    } else {
                        console.log('[Profile Image Debug] base.html - No avatar URL or elements not found');
                    }
                })
                .catch(err => console.error('[Profile Image Debug] base.html - Failed to load user info:', err));
                
                // StudySphere連携状態を確認してリンクを更新（ID 8対応）
                fetch('/api/users/me/', {
                    headers: {
                        'Authorization': `Bearer ${getAccessToken()}`,
                    }
                })
                .then(res => res.json())
                .then(userData => {
                    const studysphereLink = document.getElementById('studysphere-link-header');
                    if (studysphereLink && (userData.studysphere_user_id || userData.studysphere_login_code)) {
                        // StudySphere連携済みの場合はSSOディスパッチを使用
                        studysphereLink.href = '/sso/dispatch/studysphere/?redirect=1';
                        console.log('[StudySphere] User is linked, will use SSO dispatch');
                    } else if (studysphereLink) {
                        // 未連携の場合はダッシュボードへ（StudySphere側でログイン処理される）
                        studysphereLink.href = 'https://studysphere.ayatori-inc.co.jp/student/dashboard';
                        console.log('[StudySphere] User is not linked, redirecting to dashboard');
                    }
                })
                .catch(err => console.error('[StudySphere] Failed to check link status:', err));
                
                // テーマの初期化
                initializeTheme();
                
                // 通知を読み込む（初回）
                loadNotifications();
                
                // 定期的に通知を更新（30秒ごと）
                setInterval(loadNotifications, 30000);
            } else {
                // 未ログインの場合
                if (logoLink) logoLink.href = '/';
                if (navMe) navMe.style.display = 'none';
                if (navCollection) navCollection.style.display = 'none';
                if (navProfile) navProfile.style.display = 'none';
                if (navLogin) navLogin.style.display = 'inline';
                if (userInfo) userInfo.style.display = 'none';
                
                const notificationContainer = document.getElementById('notification-container');
                if (notificationContainer) notificationContainer.style.display = 'none';
            }
            
            // 通知ドロップダウンの外側をクリックしたら閉じる
            document.addEventListener('click', function(e) {
                const container = document.getElementById('notification-container');
                const dropdown = document.getElementById('notification-dropdown');
                const button = document.getElementById('notification-button');
                
                if (container && dropdown && button && notificationDropdownOpen) {
                    if (!container.contains(e.target)) {
                        notificationDropdownOpen = false;
                        dropdown.style.display = 'none';
                    }
                }
                
                // ユーザーメニューの外側をクリックしたら閉じる
                const userMenuContainer = document.getElementById('user-menu-container');
                const userMenuDropdown = document.getElementById('user-menu-dropdown');
                const userMenuButton = document.getElementById('user-menu-button');
                
                if (userMenuContainer && userMenuDropdown && userMenuButton) {
                    if (!userMenuContainer.contains(e.target) && userMenuDropdown.style.display === 'block') {
                        userMenuDropdown.style.display = 'none';
                    }
                }
            });
        });
        
        // ユーザーメニューの表示/非表示を切り替え
        let userMenuOpen = false;
        function toggleUserMenu() {
            const dropdown = document.getElementById('user-menu-dropdown');
            if (!dropdown) return;
            
            userMenuOpen = !userMenuOpen;
            dropdown.style.display = userMenuOpen ? 'block' : 'none';
            
            // 通知ドロップダウンが開いていたら閉じる
            if (userMenuOpen) {
                const notificationDropdown = document.getElementById('notification-dropdown');
                if (notificationDropdown) {
                    notificationDropdown.style.display = 'none';
                    notificationDropdownOpen = false;
                }
            }
        }
        
        // テーマの初期化（ページ読み込み時に既に適用されているので、トグルテキストのみ更新）
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            // テーマは既に<head>内のスクリプトで適用済みなので、トグルテキストのみ更新
            updateThemeToggleText(savedTheme);
        }
        
        // テーマを適用
        function applyTheme(theme) {
            const html = document.documentElement;
            html.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        }
        
        // テーマトグルボタンのテキストを更新
        function updateThemeToggleText(theme) {
            const themeText = document.getElementById('theme-toggle-text');
            const themeIcon = document.getElementById('theme-icon');
            if (themeText) {
                themeText.textContent = theme === 'dark' ? 'ライトモード' : 'ダークモード';
            }
            if (themeIcon) {
                if (theme === 'dark') {
                    // 太陽アイコン（ライトモードに切り替える）
                    themeIcon.innerHTML = '<circle cx="12" cy="12" r="5" /><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />';
                } else {
                    // 月アイコン（ダークモードに切り替える）
                    themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />';
                }
            }
        }
        
        // テーマを切り替え
        function toggleTheme() {
            const currentTheme = localStorage.getItem('theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
            updateThemeToggleText(newTheme);
        }
    </script>
</body>
</html>

